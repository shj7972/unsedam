{% extends "base.html" %}

{% block sidebar %}
{% include "includes/sidebar_input.html" %}

<!-- Sidebar Banner -->
{{ sidebar_banner_html | safe }}
{% endblock %}

{% block content %}
<!-- ìš°ì¸¡: ê²°ê³¼ í‘œì‹œ -->
<div class="result-container">
    <!-- ì»¨í…ì¸  ìƒë‹¨ ë°°ë„ˆ (ê²°ê³¼ ì˜ì—­ì—ë§Œ ìœ„ì¹˜) -->


    {% if processed and pillars_data %}
    <!-- ê¸°ë³¸ ì‚¬ì£¼ ì •ë³´ (í•­ìƒ í‘œì‹œ) -->
    <div id="saju-basic-info">
        <h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ì‚¬ì£¼íŒ”ì</h3>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            {% for pillar in pillars_data %}
            <div
                style="padding: 1rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold);">
                <div style="font-weight: bold; color: var(--gold-primary); margin-bottom: 0.5rem;">
                    {{ pillar.get('Pillar', '') }}
                </div>
                <div style="color: var(--text-primary);">
                    {{ pillar.get('Heavenly Stem (ì²œê°„)', '') }} {{ pillar.get('Earthly Branch (ì§€ì§€)', '') }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- AI Result Container -->
    <div id="ai-result"></div>

    {% else %}
    <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">âœ¨</div>
        <h2 style="color: var(--gold-primary); margin-bottom: 1rem;">ë‹¹ì‹ ì˜ ìš´ëª… ì°¨íŠ¸ë¥¼ í¼ì³ë³´ì„¸ìš”</h2>
        <p id="hero-subtitle" style="color: var(--text-muted); line-height: 1.8; min-height: 1.8em; font-size: 1.1rem;">
            <!-- Typing effect will render here -->
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const text = "ì„±í•¨ê³¼ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì‹œë©´ í”„ë¦¬ë¯¸ì—„ AI ì‚¬ì£¼ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.";
            const element = document.getElementById('hero-subtitle');
            let i = 0;

            if (element) {
                element.innerHTML = '<span class="typing-text"></span><span class="typing-cursor">|</span>';
                const textSpan = element.querySelector('.typing-text');

                function typeWriter() {
                    if (i < text.length) {
                        textSpan.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(typeWriter, 50);
                    } else {
                        // Blink cursor after typing done
                        const cursor = element.querySelector('.typing-cursor');
                        if (cursor) cursor.style.animation = 'blink 1s infinite';
                    }
                }

                // Add cursor blink animation style
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
                    .typing-cursor { color: var(--gold-primary); font-weight: bold; margin-left: 5px; }
                `;
                document.head.appendChild(style);

                setTimeout(typeWriter, 500);
            }
        });
    </script>

    <!-- SEO Rich Content (ì´ˆê¸° í™”ë©´ì—ë§Œ í‘œì‹œ, ê²°ê³¼ ë Œë”ë§ ì‹œ ë®ì–´ì¨ì§) -->
    <div id="seo-rich-content-main" class="glass-card"
        style="margin-top: 2rem; padding: 2rem; border-top: 1px solid rgba(212, 175, 55, 0.2);">
        <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; font-size: 1.3rem;">ğŸ’¡ AI ì‚¬ì£¼ ë¶„ì„ ê°€ì´ë“œ</h3>

        <div style="margin-bottom: 2rem;">
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                AI ì‚¬ì£¼(AI Saju) ë¶„ì„ì´ë€?</h4>
            <p style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem; text-align: justify;">
                ìš´ì„¸ë‹´ì˜ <strong>AI ì‚¬ì£¼ ë¶„ì„</strong>ì€ ìˆ˜ì²œ ë…„ê°„ ì¶•ì ëœ ë™ì–‘ì˜ ëª…ë¦¬í•™(å‘½ç†å­¸) ë°ì´í„°ë¥¼ ìµœì‹  ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ë¡œ ì¬í•´ì„í•œ ì°¨ì„¸ëŒ€ ìš´ì„¸ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
                ë³µì¡í•œ ë§Œì„¸ë ¥ ê³„ì‚°ê³¼ ì˜¤í–‰ì˜ ìƒìƒìƒê·¹ ì›ë¦¬ë¥¼ AIê°€ 0.1ì´ˆ ë§Œì— ì •ë°€í•˜ê²Œ ë¶„ì„í•˜ì—¬, ê¸°ì¡´ì˜ ì •í˜•í™”ëœ í’€ì´ë¥¼ ë„˜ì–´ ì‚¬ìš©ìì˜ ì„±í–¥ê³¼ ìš´ì˜ íë¦„ì— ìµœì í™”ëœ ë§ì¶¤í˜• ì¸ìƒ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
            </p>
        </div>

        <div style="margin-bottom: 2rem;">
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                ì‚¬ì£¼ëª…ë¦¬í•™ì˜ ê¸°ì´ˆ</h4>
            <div style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem;">
                <p style="margin-bottom: 1rem; text-align: justify;">
                    ì‚¬ì£¼(å››æŸ±)ëŠ” ì‚¬ëŒì´ íƒœì–´ë‚œ ì—°(å¹´), ì›”(æœˆ), ì¼(æ—¥), ì‹œ(æ™‚)ì˜ ë„¤ ê°€ì§€ ê¸°ë‘¥ì„, íŒ”ì(å…«å­—)ëŠ” ê° ê¸°ë‘¥ì˜ ì²œê°„(å¤©å¹²)ê³¼ ì§€ì§€(åœ°æ”¯)ë¥¼ í•©ì¹œ 8ê°œì˜ ê¸€ìë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
                    ì´ëŠ” ë‹¨ìˆœí•œ ì ìˆ ì´ ì•„ë‹ˆë¼, ìš°ì£¼ì˜ ê¸°ìš´ì´ ê°œì¸ì—ê²Œ ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë¶„ì„í•˜ëŠ” í†µê³„í•™ì  ì„±ê²©ì„ ì§€ë‹™ë‹ˆë‹¤.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì²œê°„
                            (10ì)</strong>
                        í•˜ëŠ˜ì˜ ê¸°ìš´ìœ¼ë¡œ ì •ì‹ ì ì¸ ì¸¡ë©´ì„ ìƒì§•í•©ë‹ˆë‹¤.<br>
                        (ê°‘, ì„, ë³‘, ì •, ë¬´, ê¸°, ê²½, ì‹ , ì„, ê³„)
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì§€ì§€
                            (12ì)</strong>
                        ë•…ì˜ ê¸°ìš´ìœ¼ë¡œ í˜„ì‹¤ì ì¸ ì¸¡ë©´ì„ ìƒì§•í•©ë‹ˆë‹¤.<br>
                        (ì, ì¶•, ì¸, ë¬˜, ì§„, ì‚¬, ì˜¤, ë¯¸, ì‹ , ìœ , ìˆ , í•´)
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                ìš´ì„¸ë‹´ì´ ì§€í–¥í•˜ëŠ” ê°€ì¹˜</h4>
            <p style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem; text-align: justify;">
                "ìš´ëª…ì€ ì •í•´ì§„ ê²ƒì´ ì•„ë‹ˆë¼ ë§Œë“¤ì–´ê°€ëŠ” ê²ƒì…ë‹ˆë‹¤."<br>
                ì‚¬ì£¼ ë¶„ì„ì˜ ì§„ì •í•œ ëª©ì ì€ ë‹¨ìˆœíˆ ë¯¸ë˜ë¥¼ ì˜ˆì–¸í•˜ëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.
                ìì‹ ì˜ íƒ€ê³ ë‚œ ê¸°ì§ˆê³¼ ë‹¤ê°€ì˜¤ëŠ” ìš´ì˜ íë¦„ì„ ë¯¸ë¦¬ íŒŒì•…í•˜ì—¬, ì¢‹ì€ ìš´ì€ ë” í¬ê²Œ í‚¤ìš°ê³  ë‚˜ìœ ìš´ì€ ìŠ¬ê¸°ë¡­ê²Œ í”¼í•´ê°€ëŠ” ì§€í˜œë¥¼ ì–»ëŠ” ë° ìˆìŠµë‹ˆë‹¤.
                ìš´ì„¸ë‹´ì€ ê³ ëŒ€ ëª…ë¦¬í•™ì˜ ì§€í˜œë¥¼ í˜„ëŒ€ì ì¸ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ í’€ì–´ë‚´ì–´, ì—¬ëŸ¬ë¶„ì˜ ì‚¶ì— ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë˜ëŠ” ê°€ì´ë“œë¥¼ ì œê³µí•˜ê³ ì ë…¸ë ¥í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div
            style="margin-top: 2rem; padding: 1rem; background: rgba(212, 175, 55, 0.05); border-radius: 8px; font-size: 0.85rem;">
            <p style="color: var(--gold-secondary); margin-bottom: 0.5rem; font-weight: bold;">âš ï¸ ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­</p>
            <p style="color: var(--text-dim); line-height: 1.6;">
                ìš´ì„¸ ì •ë³´ëŠ” ê°œì¸ì˜ ìƒë…„ì›”ì¼ì‹œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í†µê³„ì  ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ì´ëŠ” ê³¼í•™ì  ì¦ëª…ë³´ë‹¤ëŠ” ë™ì–‘ ì² í•™ì  ê´€ì ì—ì„œì˜ í•´ì„ì´ë¯€ë¡œ, ì‚¶ì˜ ì¤‘ìš”í•œ ê²°ì • ì‹œì—ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì‹œê³  ì£¼ì²´ì ì¸
                íŒë‹¨ì„ ë‚´ë¦¬ì‹œê¸¸ ê¶Œì¥í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
    {% endif %}
    <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ í…œí”Œë¦¿ (renderResultsì—ì„œ ë™ì ìœ¼ë¡œ ë³µì œí•˜ì—¬ ì‚¬ìš©) -->
</div>
<!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ í…œí”Œë¦¿ (renderResultsì—ì„œ ë™ì ìœ¼ë¡œ ë³µì œí•˜ì—¬ ì‚¬ìš©) -->
<template id="share-buttons-template">
    <div id="ai-saju-share" style="margin-top: 2rem;">
        {% include "includes/share_buttons.html" %}
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    // ë‚˜ì´ ê³„ì‚° ë° í‘œì‹œ
    document.getElementById('birth_date')?.addEventListener('change', function () {
        const birthDate = this.value;
        if (birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            const currentAge = today.getFullYear() - birth.getFullYear() -
                ((today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) ? 1 : 0);
            const koreanAge = today.getFullYear() - birth.getFullYear() + 1;

            const ageInfo = document.getElementById('age-info');
            if (ageInfo) {
                ageInfo.style.display = 'block';
                ageInfo.textContent = `í˜„ì¬ ë‚˜ì´: ë§Œ ${currentAge}ì„¸ (í•œêµ­ë‚˜ì´ ${koreanAge}ì„¸)`;
            }
        }
    });

    // íƒœì–´ë‚œ ì‹œê° ì…ë ¥ í•„ë“œëŠ” ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì‚¬ìš© (ì™¸ë¶€ í´ë¦­ ì‹œì—ë§Œ ë‹«í˜)
    // JavaScriptë¡œ ì„¸ë¶€ì ì¸ ì œì–´ê°€ ì–´ë ¤ìš°ë¯€ë¡œ ìë™ ë‹«ê¸° ê¸°ëŠ¥ ì œê±°

    // í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('input-form')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const errorDiv = document.getElementById('form-error');
        const submitBtn = this.querySelector('button[type="submit"]');

        // ë¡œë”© ìƒíƒœ
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        }
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'  // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ì„¸ì…˜ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
                if (data.data && data.data.session_data) {
                    saveSessionDataToLocalStorage(data.data);
                } else {
                    // session_dataê°€ ì—†ìœ¼ë©´ FormDataì—ì„œ ì§ì ‘ ì €ì¥
                    const sessionData = {
                        user_name: formData.get('name') || '',
                        user_gender: formData.get('gender') || '',
                        birth_date: formData.get('birth_date') || '',
                        birth_time: formData.get('birth_time') || '',
                        is_lunar: formData.get('is_lunar') === 'on' || formData.get('is_lunar') === 'true',
                        _timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                    };
                    localStorage.setItem('user_session_data', JSON.stringify(sessionData));
                }

                // í¼ ê°’ì„ FormDataì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
                const form = document.getElementById('input-form');
                if (form) {
                    const nameInput = form.querySelector('[name="name"]');
                    const birthDateInput = form.querySelector('[name="birth_date"]');
                    const birthTimeInput = form.querySelector('[name="birth_time"]');
                    const genderSelect = form.querySelector('[name="gender"]');
                    const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

                    if (nameInput) nameInput.value = formData.get('name') || '';
                    if (birthDateInput) birthDateInput.value = formData.get('birth_date') || '';
                    if (birthTimeInput) birthTimeInput.value = formData.get('birth_time') || '';
                    if (genderSelect) genderSelect.value = formData.get('gender') || '';
                    if (isLunarCheckbox) {
                        const isLunarValue = formData.get('is_lunar');
                        isLunarCheckbox.checked = isLunarValue === 'on' || isLunarValue === 'true' || isLunarValue === true;
                    }
                }

                // ê²°ê³¼ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§
                renderResults(data.data);

                // AI ë¶„ì„ ìë™ ì‹œì‘ (ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ì „ë‹¬)
                setTimeout(() => {
                    runAIAnalysis(data.data);
                }, 300);

                // ì…ë ¥ê°’ ìœ ì§€ (í¼ ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ)
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            } else {
                // ì—ëŸ¬ í‘œì‹œ
                if (errorDiv) {
                    errorDiv.textContent = data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            if (errorDiv) {
                errorDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    });

    // AI ë¶„ì„ ì‹¤í–‰ (ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ë°›ì•„ì„œ ì‚¬ìš©)
    async function runAIAnalysis(calculatedData = null) {
        // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        if (isAIAnalysisRunning) {
            console.log('AI ë¶„ì„ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ìš”ì²­ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
            return;
        }

        const resultDiv = document.getElementById('ai-result');
        const infoMessage = document.getElementById('ai-info-message');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (!resultDiv) return;

        // ì‹¤í–‰ í”Œë˜ê·¸ ì„¤ì •
        isAIAnalysisRunning = true;

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'AI ë¶„ì„ì¤‘...';
        }

        // ë¡œë”© í‘œì‹œ (ì´ë¯¸ renderResultsì—ì„œ í‘œì‹œí–ˆì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„)
        if (!resultDiv.innerHTML.includes('spinner')) {
            resultDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 1rem; color: var(--text-muted);">AI ì‚¬ì£¼ ë¶„ì„ ì¤‘...</p></div>';
        }

        try {
            // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            // API Keyê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ì´ë¯¸ renderResultsì—ì„œ í‘œì‹œë˜ì—ˆì§€ë§Œ, AI ë¶„ì„ ì˜ì—­ì—ë„ í‘œì‹œ)
            if (!currentApiKey) {
                const aiResultDiv = document.getElementById('ai-result');
                if (aiResultDiv && lastCalculatedData) {
                    // ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ë¥¼ AI ê²°ê³¼ ì˜ì—­ì— í‘œì‹œ
                    const basicAnalysis = generateBasicAnalysis(
                        lastCalculatedData.pillars_data || [],
                        lastCalculatedData.pillars_info || {},
                        lastCalculatedData.daeun || {},
                        lastCalculatedData.fortunes || [],
                        lastCalculatedData.sinsals || []
                    );
                    aiResultDiv.innerHTML = basicAnalysis;
                }
                // í‚¤ê°€ ì—†ì–´ì„œ ì¢…ë£Œí•  ë•Œë„ ë²„íŠ¼ ë³µêµ¬
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
                isAIAnalysisRunning = false;
                return;
            }

            // ì„¸ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ëŒ€ì‹ , ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ì „ë‹¬
            const requestBody = calculatedData ? {
                calculated_data: calculatedData,
                api_key: currentApiKey  // API Keyë¥¼ ìš”ì²­ ë³¸ë¬¸ì— í¬í•¨
            } : { api_key: currentApiKey };

            console.log('AI ë¶„ì„ ìš”ì²­:', {
                has_calculated_data: !!calculatedData,
                has_ai_input_data: !!(calculatedData?.ai_input_data),
                has_api_key: !!currentApiKey
            });

            const response = await fetch('/api/ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(requestBody)
            });

            // 503 ì—ëŸ¬ ì²˜ë¦¬
            if (response.status === 503) {
                throw new Error('ì„œë²„ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }

            // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/event-stream')) {
                // SSE ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                let fullData = null;

                resultDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 1rem; color: var(--text-muted);">AI ì‚¬ì£¼ ë¶„ì„ ì¤‘...</p></div>';

                try {
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        // ë§ˆì§€ë§‰ ì¤„ì€ ì™„ì „í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ìœ ì§€
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            // ë¹ˆ ì¤„ ë¬´ì‹œ
                            if (!line.trim()) continue;

                            // SSE í˜•ì‹: "data: {json}"
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.substring(6).trim();
                                    if (!jsonStr) continue;

                                    const data = JSON.parse(jsonStr);

                                    if (data.type === 'start') {
                                        accumulatedText = '';
                                        console.log('ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘');
                                    } else if (data.type === 'chunk') {
                                        if (data.content) {
                                            accumulatedText += data.content;
                                        }
                                    } else if (data.type === 'complete') {
                                        fullData = data.data;
                                        console.log('ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ:', fullData ? 'ë°ì´í„° ìˆ˜ì‹ ' : 'ë°ì´í„° ì—†ìŒ');
                                    } else if (data.type === 'error') {
                                        throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                    }
                                } catch (parseError) {
                                    console.error('ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError, 'Line:', line);
                                    // JSON íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰ (ë¶ˆì™„ì „í•œ ì²­í¬ì¼ ìˆ˜ ìˆìŒ)
                                }
                            }
                        }
                    }

                    // ë²„í¼ì— ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
                    if (buffer.trim() && buffer.startsWith('data: ')) {
                        try {
                            const jsonStr = buffer.substring(6).trim();
                            if (jsonStr) {
                                const data = JSON.parse(jsonStr);
                                if (data.type === 'complete') {
                                    fullData = data.data;
                                } else if (data.type === 'error') {
                                    throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        } catch (e) {
                            console.error('ë²„í¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                        }
                    }

                    // ìµœì¢… ê²°ê³¼ ë Œë”ë§
                    if (fullData) {
                        console.log('AI ë¶„ì„ ê²°ê³¼ ë Œë”ë§ ì¤‘...');
                        resultDiv.innerHTML = formatAIResult(fullData);
                        if (infoMessage) {
                            infoMessage.style.display = 'none';
                        }
                    } else if (accumulatedText) {
                        // accumulatedTextê°€ ìˆìœ¼ë©´ JSON íŒŒì‹± ì‹œë„
                        try {
                            const parsed = JSON.parse(accumulatedText);
                            console.log('ëˆ„ì  í…ìŠ¤íŠ¸ì—ì„œ ê²°ê³¼ íŒŒì‹± ì„±ê³µ');
                            resultDiv.innerHTML = formatAIResult(parsed);
                            if (infoMessage) {
                                infoMessage.style.display = 'none';
                            }
                        } catch (e) {
                            console.error('ëˆ„ì  í…ìŠ¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', e);
                            throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (streamError) {
                    console.error('ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì˜¤ë¥˜:', streamError);
                    throw streamError;
                }
            } else {
                // ê¸°ì¡´ JSON ì‘ë‹µ ì²˜ë¦¬ (í•˜ìœ„ í˜¸í™˜ì„±)
                const text = await response.text();
                if (!text) {
                    throw new Error('ì„œë²„ ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }

                try {
                    const data = JSON.parse(text);
                    if (data.success && data.data) {
                        if (data.data.is_ai_analysis) {
                            resultDiv.innerHTML = formatAIResult(data.data);
                            if (infoMessage) {
                                infoMessage.style.display = 'none';
                            }
                        } else {
                            // API Keyê°€ ì—†ì„ ë•ŒëŠ” ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                            if (lastCalculatedData) {
                                const basicAnalysis = generateBasicAnalysis(
                                    lastCalculatedData.pillars_data || [],
                                    lastCalculatedData.pillars_info || {},
                                    lastCalculatedData.daeun || {},
                                    lastCalculatedData.fortunes || [],
                                    lastCalculatedData.sinsals || []
                                );
                                resultDiv.innerHTML = basicAnalysis;
                            } else {
                                resultDiv.innerHTML = '<div style="padding: 1rem; color: var(--text-muted);">ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                            }
                        }
                    } else {
                        throw new Error(data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (parseError) {
                    console.error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', parseError);
                    throw new Error('ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            }
        } catch (error) {
            console.error('AI Analysis Error:', error);

            // 503 ì—ëŸ¬ë‚˜ HTML ì‘ë‹µì¸ ê²½ìš° ì²˜ë¦¬
            let errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (error.message && error.message.includes('Unexpected token')) {
                errorMessage = 'ì„œë²„ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } else if (error.message) {
                errorMessage = error.message;
            }

            resultDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ${errorMessage}</div>`;
        } finally {
            // ì‹¤í–‰ í”Œë˜ê·¸ í•´ì œ
            isAIAnalysisRunning = false;
            // ë²„íŠ¼ í™œì„±í™”
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    }

    // ë§ˆì§€ë§‰ ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì €ì¥ (API Key ì €ì¥ í›„ AI ë¶„ì„ ì¬ì‹¤í–‰ìš©)
    let lastCalculatedData = null;

    // AI ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
    let isAIAnalysisRunning = false;

    // ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ë¦¬í•œ API Key ì €ì¥ (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
    let lastProcessedApiKey = '';

    // ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜
    function renderResults(data) {
        console.log('renderResults í˜¸ì¶œë¨:', {
            has_data: !!data,
            has_pillars_data: !!(data?.pillars_data),
            pillars_data_length: data?.pillars_data?.length || 0
        });

        // ê³„ì‚°ëœ ë°ì´í„° ì €ì¥ (API Key ì €ì¥ í›„ AI ë¶„ì„ ì¬ì‹¤í–‰ìš©)
        lastCalculatedData = data;

        let rightColumn = document.querySelector('div[style*="flex: 2"]');
        if (!rightColumn) {
            console.error('ê²°ê³¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì²´ ì„ íƒì ì‹œë„...');
            // ëŒ€ì²´ ì„ íƒì ì‹œë„
            rightColumn = document.querySelector('.result-container');
            if (rightColumn) {
                console.log('ëŒ€ì²´ ì„ íƒìë¡œ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì°¾ìŒ');
            } else {
                console.error('ê²°ê³¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
        }

        const pillarsData = data.pillars_data || [];
        const pillarsInfo = data.pillars_info || {};
        const daeun = data.daeun || {};
        const fortunes = data.fortunes || [];
        const sinsals = data.sinsals || [];

        // ì˜¤í–‰ ìƒ‰ìƒ
        const ELEM_COLORS = {
            "æœ¨": "#2ecc71",  // Green
            "ç«": "#e74c3c",  // Red
            "åœŸ": "#f1c40f",  // Gold/Yellow
            "é‡‘": "#ecf0f1",  // White/Silver
            "æ°´": "#3498db"   // Blue
        };

        // ì²œê°„ ì˜¤í–‰ ë§¤í•‘
        const FIVE_ELEMENTS = {
            "ç”²": "æœ¨", "ä¹™": "æœ¨",
            "ä¸™": "ç«", "ä¸": "ç«",
            "æˆŠ": "åœŸ", "å·±": "åœŸ",
            "åºš": "é‡‘", "è¾›": "é‡‘",
            "å£¬": "æ°´", "ç™¸": "æ°´"
        };

        // ì§€ì§€ ì˜¤í–‰ ë§¤í•‘
        const BRANCH_ELEMENTS = {
            "å¯…": "æœ¨", "å¯": "æœ¨",
            "å·³": "ç«", "åˆ": "ç«",
            "è¾°": "åœŸ", "æˆŒ": "åœŸ", "ä¸‘": "åœŸ", "æœª": "åœŸ",
            "ç”³": "é‡‘", "é…‰": "é‡‘",
            "äº¥": "æ°´", "å­": "æ°´"
        };

        // ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getColor(char, isStem) {
            if (!char) return "#D4AF37";

            // í•œìë§Œ ì¶”ì¶œ (ì˜ˆ: "ç”² (ê°‘)" -> "ç”²")
            const charOnly = char.split(' ')[0].trim();

            // ì˜¤í–‰ ì°¾ê¸°
            const element = isStem ? FIVE_ELEMENTS[charOnly] : BRANCH_ELEMENTS[charOnly];

            // ìƒ‰ìƒ ë°˜í™˜ (ì˜¤í–‰ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ)
            return element ? ELEM_COLORS[element] || "#D4AF37" : "#D4AF37";
        }

        // API Key í™•ì¸ (ì´ˆê¸° ë¡œë“œ ì‹œ)
        const apiKeyInput = document.getElementById('api-key-input');
        const hasApiKey = apiKeyInput ? apiKeyInput.value.trim().startsWith('sk-') && apiKeyInput.value.trim().length > 20 : false;

        let html = '';

        // AI ë¶„ì„ ì„¹ì…˜ í•­ìƒ í‘œì‹œ (API Key ìœ ë¬´ì— ë”°ë¼ ë‚´ìš©ì´ ë‹¬ë¼ì§)
        html += `
        <div class="glass-card result-card" style="margin-bottom: 2rem;">
            <div class="section-header">
                <span>ğŸ”®</span> AI ì‚¬ì£¼ ë¶„ì„
            </div>
            
            <!-- AI ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
            <div id="ai-result-container">
                <div id="ai-analysis-section" style="margin-bottom: 2rem;">
                    <div id="ai-result" style="margin-top: 1.5rem;">
    `;

        if (!hasApiKey) {
            // API Keyê°€ ì—†ì„ ë•ŒëŠ” ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            html += generateBasicAnalysis(pillarsData, pillarsInfo, daeun, fortunes, sinsals);
        } else {
            // API Keyê°€ ìˆì„ ë•ŒëŠ” ë¡œë”© í‘œì‹œ (AI ë¶„ì„ ì§„í–‰ ì¤‘)
            html += `
                        <div style="text-align: center; padding: 2rem;">
                            <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 1rem; color: var(--text-muted);">AI ì‚¬ì£¼ ë¶„ì„ ì¤‘...</p>
                        </div>
        `;
        }

        html += `
                    </div>
                </div>
            </div>
        </div>
    `;

        html += `
        <!-- ì‚¬ì£¼íŒ”ì í…Œì´ë¸” -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <div class="section-header">
                <span>ğŸ•¯ï¸</span> ì‚¬ì£¼íŒ”ì(å››æŸ±å…«å­—)
            </div>
            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 1.3em; border: 1px solid var(--border-gold);">
                <thead>
                    <tr style="border-bottom: 2px solid var(--gold-primary);">
                        <th style="padding: 1rem; color: #D4AF37; border-right: 1px solid var(--border-gold);">êµ¬ë¶„</th>
                        <th style="padding: 1rem; color: #D4AF37; border-right: 1px solid var(--border-gold);">ë…„ (å¹´)</th>
                        <th style="padding: 1rem; color: #D4AF37; border-right: 1px solid var(--border-gold);">ì›” (æœˆ)</th>
                        <th style="padding: 1rem; color: #D4AF37; border-right: 1px solid var(--border-gold);">ì¼ (æ—¥)</th>
                        <th style="padding: 1rem; color: #D4AF37;">ì‹œ (æ™‚)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--border-gold);">
                        <td style="padding: 1rem; color: #A0AEC0; border-right: 1px solid var(--border-gold);">ì²œê°„</td>
    `;

        // ì²œê°„ í–‰
        pillarsData.forEach((pillar, idx) => {
            const borderRight = idx < 3 ? '1px solid var(--border-gold)' : 'none';
            html += `<td style="padding: 1rem; font-weight: bold; color: ${getColor(pillar['Heavenly Stem (ì²œê°„)'], true)}; border-right: ${borderRight};">${pillar['Heavenly Stem (ì²œê°„)'] || ''}</td>`;
        });

        html += `
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-gold);">
                        <td style="padding: 1rem; color: #A0AEC0; border-right: 1px solid var(--border-gold);">ì§€ì§€</td>
    `;

        // ì§€ì§€ í–‰
        pillarsData.forEach((pillar, idx) => {
            const borderRight = idx < 3 ? '1px solid var(--border-gold)' : 'none';
            html += `<td style="padding: 1rem; font-weight: bold; color: ${getColor(pillar['Earthly Branch (ì§€ì§€)'], false)}; border-right: ${borderRight};">${pillar['Earthly Branch (ì§€ì§€)'] || ''}</td>`;
        });

        // ì§€ì¥ê°„ í–‰ë“¤
        const hiddenLists = pillarsData.map(p => p['Hidden Stems (ì§€ì¥ê°„)'] || []);
        const maxHidden = Math.max(...hiddenLists.map(h => h.length), 0);

        for (let i = 0; i < maxHidden; i++) {
            const label = i === 0 ? 'ì§€ì¥ê°„' : '';
            const borderBottom = i === maxHidden - 1 ? '1px solid var(--border-gold)' : 'none';
            html += `<tr style="border-bottom: ${borderBottom};"><td style="padding: 0.5rem 1rem; color: #A0AEC0; font-size: 0.7em; border-right: 1px solid var(--border-gold);">${label}</td>`;

            hiddenLists.forEach((hidden, idx) => {
                const borderRight = idx < 3 ? '1px solid var(--border-gold)' : 'none';
                if (i < hidden.length) {
                    const h = hidden[i];
                    html += `<td style="padding: 0.2rem; font-size: 0.7em; color: ${getColor(h.stem, true)}; border-right: ${borderRight};">${h.stem}<span style="color: #A0AEC0;">(${h.ten_god})</span></td>`;
                } else {
                    html += `<td style="padding: 0.2rem; border-right: ${borderRight};"></td>`;
                }
            });
            html += '</tr>';
        }

        // ì‹­ì´ìš´ì„± í–‰
        html += `<tr style="border-bottom: 1px solid var(--border-gold);"><td style="padding: 1rem; color: #A0AEC0; font-size: 0.8em; border-right: 1px solid var(--border-gold);">ì‹­ì´ìš´ì„±</td>`;
        fortunes.forEach((fort, idx) => {
            const borderRight = idx < 3 ? '1px solid var(--border-gold)' : 'none';
            html += `<td style="padding: 0.5rem; font-size: 0.8em; color: #F9E79F; border-right: ${borderRight};">${fort || ''}</td>`;
        });
        html += '</tr>';

        // ì‹ ì‚´ í–‰ë“¤
        const sinsalLists = sinsals.map(sin => (sin || '').split(' ').filter(s => s));
        const maxSinsal = Math.max(...sinsalLists.map(s => s.length), 0);

        for (let i = 0; i < maxSinsal; i++) {
            const label = i === 0 ? 'ì‹ ì‚´' : '';
            const borderBottom = i === maxSinsal - 1 ? '1px solid var(--border-gold)' : 'none';
            html += `<tr style="border-bottom: ${borderBottom};"><td style="padding: 0.5rem 1rem; color: #A0AEC0; font-size: 0.7em; border-right: 1px solid var(--border-gold);">${label}</td>`;

            sinsalLists.forEach((sinsal, idx) => {
                const borderRight = idx < 3 ? '1px solid var(--border-gold)' : 'none';
                if (i < sinsal.length) {
                    html += `<td style="padding: 0.2rem; font-size: 0.8em; color: #D4AF37; border-right: ${borderRight};">${sinsal[i]}</td>`;
                } else {
                    html += `<td style="padding: 0.2rem; border-right: ${borderRight};"></td>`;
                }
            });
            html += '</tr>';
        }

        html += `
                </tbody>
            </table>
        </div>
        
        <!-- ëŒ€ìš´ ì¹´ë“œ -->
        <div class="glass-card">
            <div class="section-header">
                <span>ğŸŒŠ</span> ëŒ€ìš´ (å¤§é‹)
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>ëŒ€ìš´ ë°©í–¥:</strong> ${daeun.direction || ''} ( ${daeun.start_age || 0}ì„¸ ì£¼ê¸° )
            </div>
            <div style="display: flex; flex-wrap: nowrap; gap: 0.5rem; overflow-x: auto;">
    `;

        // ëŒ€ìš´ ê¸°ê°„ë“¤
        const today = new Date();
        const birthDate = pillarsInfo.birth_datetime ? new Date(pillarsInfo.birth_datetime) : null;
        let currentAge = 0;
        if (birthDate) {
            currentAge = today.getFullYear() - birthDate.getFullYear() -
                ((today.getMonth() < birthDate.getMonth() ||
                    (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) ? 1 : 0);
        }

        // í•œë¬¸ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (ganji: "ç”² (ê°‘) å­ (ì)" -> ["ç”²", "å­"])
        function extractGanjiHanja(ganjiText) {
            if (!ganjiText) return ['', ''];
            // ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬í•˜ê³  ê° ë¶€ë¶„ì—ì„œ í•œë¬¸ë§Œ ì¶”ì¶œ
            const parts = ganjiText.split(/\s+/);
            const hanjaList = parts.map(part => {
                // "ç”² (ê°‘)" í˜•ì‹ì—ì„œ í•œë¬¸ë§Œ ì¶”ì¶œ
                const match = part.match(/^([^\s(]+)/);
                return match ? match[1] : '';
            }).filter(part => part);
            // ì²œê°„ê³¼ ì§€ì§€ ë°˜í™˜ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
            return [hanjaList[0] || '', hanjaList[1] || ''];
        }

        (daeun.periods || []).forEach(period => {
            const ageStart = parseFloat(period.age_start || 0);
            const isCurrent = ageStart <= currentAge && currentAge < ageStart + 10;
            const [stem, branch] = extractGanjiHanja(period.ganji || '');
            html += `
            <div style="min-width: 50px; padding: 0.5rem; border: 1px solid ${isCurrent ? '#D4AF37' : 'rgba(255,255,255,0.1)'}; 
                        border-radius: 8px; background: ${isCurrent ? 'rgba(212,175,55,0.2)' : 'transparent'}; 
                        text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 0.3rem;">
                    <div style="font-size: 1.2em; font-weight: bold; color: ${isCurrent ? '#D4AF37' : 'white'}; line-height: 1.2;">${stem}</div>
                    <div style="font-size: 1.2em; font-weight: bold; color: ${isCurrent ? '#D4AF37' : 'white'}; line-height: 1.2;">${branch}</div>
                </div>
                <div style="font-size: 0.7em; color: #A0AEC0; margin-top: 0.2rem;">${Math.floor(ageStart)}ì„¸</div>
            </div>
        `;
        });

        html += `
            </div>
        </div>
    `;

        // ê²°ê³¼ ì˜ì—­ ì—…ë°ì´íŠ¸
        rightColumn.innerHTML = html;
        console.log('ê²°ê³¼ HTML ì—…ë°ì´íŠ¸ ì™„ë£Œ');

        // ê³µìœ  ë²„íŠ¼ í‘œì‹œ (í…œí”Œë¦¿ ë³µì œ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
        const shareTemplate = document.getElementById('share-buttons-template');
        if (shareTemplate) {
            const shareContent = shareTemplate.content.cloneNode(true);
            rightColumn.appendChild(shareContent);

            // IDê°€ ë³µì œë˜ì—ˆìœ¼ë¯€ë¡œ ìƒˆë¡œ ì„ íƒ
            const shareDiv = document.getElementById('ai-saju-share');
            if (shareDiv) shareDiv.style.display = 'block';
        }

        // ê³µìœ  ë°ì´í„° ì„¤ì • - ê¸°ë³¸ ì‚¬ì£¼ ì •ë³´ ê¸°ë°˜
        const gender = document.getElementById('person1_gender')?.value || 'ì‚¬ìš©ì';
        const name = document.getElementById('person1_name')?.value || 'ë‚˜';
        const shareBirthDate = pillarsInfo.birth_datetime ? new Date(pillarsInfo.birth_datetime) : new Date();
        const year = shareBirthDate.getFullYear();

        let shareTitle = "ìš´ì„¸ë‹´ - í”„ë¦¬ë¯¸ì—„ AI ì‚¬ì£¼ ë¶„ì„";
        let shareDesc = "ë‚˜ì˜ ì‚¬ì£¼íŒ”ìì™€ ìš´ì„¸ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.";

        // ì¼ì£¼ ì •ë³´ê°€ ìˆìœ¼ë©´ ì œëª©ì— í™œìš©
        const dayPillar = pillarsData.find(p => p.Pillar === 'ì¼ì£¼ (Day)');
        if (dayPillar) {
            const dayStem = dayPillar['Heavenly Stem (ì²œê°„)'] || '';
            const dayBranch = dayPillar['Earthly Branch (ì§€ì§€)'] || '';
            shareTitle = `${year}ë…„ìƒ ${dayStem}${dayBranch}ì¼ì£¼ ì‚¬ì£¼ ë¶„ì„ - ìš´ì„¸ë‹´`;
        }

        window.currentShareData = {
            title: shareTitle,
            description: shareDesc,
            url: window.location.href,
            text: `${shareTitle}\n${shareDesc}\n\nì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!`
        };
    }

    // ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ ìƒì„± (API Keyê°€ ì—†ì„ ë•Œ)
    // ì ìˆ˜ ë°” ì‹œê°í™” í•¨ìˆ˜ (10ì  ë§Œì )
    function renderSajuScoreBar(label, score, maxScore = 10) {
        const percentage = (score / maxScore) * 100;
        const color = score >= 8 ? '#2ecc71' : score >= 6 ? '#3498db' : score >= 4 ? '#f1c40f' : '#e74c3c';

        return `
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-primary); font-weight: 500;">${label}</span>
                <span style="color: ${color}; font-weight: bold; font-size: 1.1em;">${score}ì </span>
            </div>
            <div style="width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.3s ease;"></div>
            </div>
        </div>
    `;
    }

    // ì‚¬ì£¼ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
    function calculateSajuScores(pillarsData, pillarsInfo, fortunes, sinsals, daeun) {
        const dayFortune = fortunes[2] || '';
        const allSinsals = sinsals.filter(s => s && s.trim()).join(' ').split(/\s+/);

        // ê¸°ë³¸ ì ìˆ˜ (5ì )
        let overall = 5, personality = 5, wealth = 5, love = 5, health = 5, career = 5;

        // ì‹­ì´ìš´ì„±ì— ë”°ë¥¸ ì¡°ì •
        const fortuneScores = {
            "ì œì™•": { overall: 9, personality: 9, wealth: 8, love: 8, health: 7, career: 9 },
            "ê±´ë¡": { overall: 8, personality: 8, wealth: 7, love: 7, health: 7, career: 8 },
            "ì¥ìƒ": { overall: 7, personality: 7, wealth: 6, love: 7, health: 7, career: 7 },
            "ê´€ëŒ€": { overall: 7, personality: 8, wealth: 6, love: 7, health: 6, career: 8 },
            "ëª©ìš•": { overall: 6, personality: 7, wealth: 5, love: 8, health: 5, career: 5 },
            "ì‡ ": { overall: 5, personality: 5, wealth: 5, love: 5, health: 5, career: 5 },
            "ë³‘": { overall: 4, personality: 4, wealth: 4, love: 4, health: 3, career: 4 },
            "ì‚¬": { overall: 4, personality: 4, wealth: 4, love: 4, health: 3, career: 4 },
            "ë¬˜": { overall: 4, personality: 5, wealth: 4, love: 4, health: 4, career: 4 },
            "ì ˆ": { overall: 5, personality: 5, wealth: 5, love: 5, health: 5, career: 5 },
            "íƒœ": { overall: 6, personality: 6, wealth: 6, love: 6, health: 6, career: 6 },
            "ì–‘": { overall: 6, personality: 6, wealth: 6, love: 6, health: 6, career: 6 }
        };

        if (dayFortune && fortuneScores[dayFortune]) {
            const fs = fortuneScores[dayFortune];
            overall = fs.overall;
            personality = fs.personality;
            wealth = fs.wealth;
            love = fs.love;
            health = fs.health;
            career = fs.career;
        }

        // ì‹ ì‚´ì— ë”°ë¥¸ ì¡°ì •
        if (allSinsals.includes("ì²œì„ê·€ì¸")) {
            overall = Math.min(10, overall + 1);
            love = Math.min(10, love + 1);
            career = Math.min(10, career + 1);
        }
        if (allSinsals.includes("ë„í™”")) {
            love = Math.min(10, love + 2);
            personality = Math.min(10, personality + 1);
        }
        if (allSinsals.includes("í™”ê°œ")) {
            career = Math.min(10, career + 1);
            personality = Math.min(10, personality + 1);
        }
        if (allSinsals.includes("ì–‘ì¸")) {
            personality = Math.min(10, personality + 1);
            career = Math.min(10, career + 1);
        }
        if (allSinsals.includes("ì—­ë§ˆ")) {
            overall = Math.max(4, overall - 1);
            health = Math.max(4, health - 1);
        }
        if (allSinsals.includes("ê³µë§")) {
            overall = Math.max(4, overall - 1);
            love = Math.max(4, love - 1);
        }

        return { overall, personality, wealth, love, health, career };
    }

    // í‚¤ì›Œë“œ ìƒì„± í•¨ìˆ˜
    function getSajuKeywords(dayElement, dayFortune, sinsals) {
        const allSinsals = sinsals.filter(s => s && s.trim()).join(' ').split(/\s+/);

        const elementKeywords = {
            "æœ¨": ["ì„±ì¥", "ë°œì „", "ì°½ì˜"],
            "ç«": ["ì—´ì •", "í™œë™", "ì‚¬êµ"],
            "åœŸ": ["ì•ˆì •", "ì‹ ë¢°", "ì‹¤ìš©"],
            "é‡‘": ["ê²°ë‹¨", "ì •ì˜", "ì¶”ì§„"],
            "æ°´": ["ìœ ì—°", "ì§€í˜œ", "ì§ê´€"]
        };

        const fortuneKeywords = {
            "ì œì™•": ["ì„±ê³µ", "ë¦¬ë”ì‹­", "ê¶Œìœ„"],
            "ê±´ë¡": ["ë…ë¦½", "ìì‹ ê°", "ì˜ì§€"],
            "ì¥ìƒ": ["ì„±ì¥", "ê¸°íšŒ", "ì‹œì‘"],
            "ê´€ëŒ€": ["ì¸ì •", "ì‚¬íšŒì„±", "ì„±ì¥"],
            "ëª©ìš•": ["ë³€í™”", "ì ì‘", "ë§¤ë ¥"],
            "ì‡ ": ["ì•ˆì •", "ì„±ìˆ™", "ì¸ë‚´"],
            "ë³‘": ["ì£¼ì˜", "íœ´ì‹", "ê´€ë¦¬"],
            "ì‚¬": ["ë³€í™”", "ì „í™˜", "ìƒˆë¡œì›€"],
            "ë¬˜": ["ë‚´ë©´", "ì„±ì°°", "ì€ë‘”"],
            "ì ˆ": ["ì¤€ë¹„", "ì ì¬", "ê¸°íšŒ"],
            "íƒœ": ["ì ì¬ë ¥", "ê°€ëŠ¥ì„±", "ì‹œì‘"],
            "ì–‘": ["ì„±ì¥", "ë°œì „", "í™œë™"]
        };

        let keywords = [];

        // ì¼ê°„ ì˜¤í–‰ ê¸°ë°˜ í‚¤ì›Œë“œ
        if (elementKeywords[dayElement]) {
            keywords = keywords.concat(elementKeywords[dayElement].slice(0, 1));
        }

        // ì‹­ì´ìš´ì„± ê¸°ë°˜ í‚¤ì›Œë“œ
        if (dayFortune && fortuneKeywords[dayFortune]) {
            keywords = keywords.concat(fortuneKeywords[dayFortune].slice(0, 1));
        }

        // ì‹ ì‚´ ê¸°ë°˜ í‚¤ì›Œë“œ
        if (allSinsals.includes("ì²œì„ê·€ì¸")) {
            keywords.push("ì¸ë³µ");
        } else if (allSinsals.includes("ë„í™”")) {
            keywords.push("ì˜ˆìˆ ");
        } else if (allSinsals.includes("í™”ê°œ")) {
            keywords.push("í•™ë¬¸");
        }

        // 3ê°œë¡œ ë§ì¶”ê¸°
        if (keywords.length < 3) {
            const defaultKeywords = ["ê· í˜•", "ì„±ì¥", "ë°œì „", "í˜‘ë ¥", "ë…ë¦½", "ì°½ì˜"];
            while (keywords.length < 3) {
                const candidate = defaultKeywords[Math.floor(Math.random() * defaultKeywords.length)];
                if (!keywords.includes(candidate)) {
                    keywords.push(candidate);
                }
            }
        }

        return keywords.slice(0, 3);
    }

    function generateBasicAnalysis(pillarsData, pillarsInfo, daeun, fortunes, sinsals) {
        const dayStem = pillarsInfo.day_stem || '';
        const dayStemChar = dayStem.split(' ')[0] || '';
        const dayBranch = pillarsInfo.day_branch || '';
        const dayBranchChar = dayBranch.split(' ')[0] || '';

        // ì˜¤í–‰ ì´ë¦„
        const elementNames = { "æœ¨": "ëª©(æœ¨)", "ç«": "í™”(ç«)", "åœŸ": "í† (åœŸ)", "é‡‘": "ê¸ˆ(é‡‘)", "æ°´": "ìˆ˜(æ°´)" };

        // ì¼ê°„ ì˜¤í–‰ ì°¾ê¸°
        const FIVE_ELEMENTS = {
            "ç”²": "æœ¨", "ä¹™": "æœ¨",
            "ä¸™": "ç«", "ä¸": "ç«",
            "æˆŠ": "åœŸ", "å·±": "åœŸ",
            "åºš": "é‡‘", "è¾›": "é‡‘",
            "å£¬": "æ°´", "ç™¸": "æ°´"
        };
        const dayElement = FIVE_ELEMENTS[dayStemChar] || '';
        const dayElementName = elementNames[dayElement] || dayElement;

        // ì˜¤í–‰ ê· í˜• ê³„ì‚°
        const elementCount = { "æœ¨": 0, "ç«": 0, "åœŸ": 0, "é‡‘": 0, "æ°´": 0 };
        pillarsData.forEach(pillar => {
            const stem = pillar['Heavenly Stem (ì²œê°„)'] || '';
            const stemChar = stem.split(' ')[0] || '';
            if (FIVE_ELEMENTS[stemChar]) {
                elementCount[FIVE_ELEMENTS[stemChar]] += 1;
            }
            const branch = pillar['Earthly Branch (ì§€ì§€)'] || '';
            const branchChar = branch.split(' ')[0] || '';
            const BRANCH_ELEMENTS = {
                "å¯…": "æœ¨", "å¯": "æœ¨",
                "å·³": "ç«", "åˆ": "ç«",
                "è¾°": "åœŸ", "æˆŒ": "åœŸ", "ä¸‘": "åœŸ", "æœª": "åœŸ",
                "ç”³": "é‡‘", "é…‰": "é‡‘",
                "äº¥": "æ°´", "å­": "æ°´"
            };
            if (BRANCH_ELEMENTS[branchChar]) {
                elementCount[BRANCH_ELEMENTS[branchChar]] += 0.5;
            }
        });

        const totalCount = Object.values(elementCount).reduce((a, b) => a + b, 0);
        const dominantElement = Object.keys(elementCount).reduce((a, b) => elementCount[a] > elementCount[b] ? a : b, 'æœ¨');
        const dominantElementName = elementNames[dominantElement] || dominantElement;

        // ì‹­ì´ìš´ì„± í•´ì„
        const fortuneMeanings = {
            "ì¥ìƒ": "ìƒˆë¡œìš´ ì‹œì‘ê³¼ ì„±ì¥ì˜ ê¸°ìš´",
            "ëª©ìš•": "ë³€í™”ì™€ ì ì‘ì˜ ì‹œê¸°",
            "ê´€ëŒ€": "ì‚¬íšŒì  ì¸ì •ê³¼ ì„±ì¥",
            "ê±´ë¡": "ìì‹ ê°ê³¼ ë…ë¦½ì„±",
            "ì œì™•": "ìµœê³ ì˜ ê¸°ìš´ê³¼ ì„±ê³µ",
            "ì‡ ": "ì•ˆì •ê³¼ ì„±ìˆ™",
            "ë³‘": "ì£¼ì˜ì™€ íœ´ì‹ í•„ìš”",
            "ì‚¬": "ë³€í™”ì™€ ì „í™˜ì ",
            "ë¬˜": "ì€ë‘”ê³¼ ë‚´ë©´ ì„±ì°°",
            "ì ˆ": "ìƒˆë¡œìš´ ì‹œì‘ì˜ ì¤€ë¹„",
            "íƒœ": "ì ì¬ë ¥ê³¼ ê°€ëŠ¥ì„±",
            "ì–‘": "ì„±ì¥ê³¼ ë°œì „"
        };
        const dayFortune = fortunes[2] || '';
        const dayFortuneMeaning = fortuneMeanings[dayFortune] || '';

        // ì‹ ì‚´ í•´ì„
        const sinsalMeanings = {
            "ì²œì„ê·€ì¸": "ê·€ì¸ì˜ ë„ì›€ê³¼ ì¸ë³µ",
            "ë„í™”": "ì˜ˆìˆ ì  ì¬ëŠ¥ê³¼ ë§¤ë ¥",
            "í™”ê°œ": "í•™ë¬¸ê³¼ ì§€ì‹ì— ëŒ€í•œ ì—´ì •",
            "ì–‘ì¸": "ê°•í•œ ì˜ì§€ë ¥ê³¼ ì¶”ì§„ë ¥",
            "ì—­ë§ˆ": "ë³€í™”ì™€ ì´ë™ì´ ë§ì€ ì‚¶",
            "ê³µë§": "í—ˆë¬´ì™€ ê³µí—ˆí•¨ì„ ëŠë‚„ ìˆ˜ ìˆìŒ",
            "ì¥ì„±": "ë¦¬ë”ì‹­ê³¼ ì§€íœ˜ ëŠ¥ë ¥"
        };
        const allSinsals = sinsals.filter(s => s && s.trim()).join(' ').split(/\s+/).filter((v, i, a) => a.indexOf(v) === i);
        const sinsalList = allSinsals.slice(0, 5).map(s => sinsalMeanings[s] ? `<strong>${s}</strong>: ${sinsalMeanings[s]}` : s).join(', ');

        // ëŒ€ìš´ ì •ë³´
        const daeunDirection = daeun.direction || '';
        const today = new Date();
        const birthDate = pillarsInfo.birth_datetime ? new Date(pillarsInfo.birth_datetime) : null;
        let currentAge = 0;
        let currentDaeun = null;
        if (birthDate) {
            currentAge = today.getFullYear() - birthDate.getFullYear() -
                ((today.getMonth() < birthDate.getMonth() ||
                    (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) ? 1 : 0);
            currentDaeun = (daeun.periods || []).find(p => {
                const ageStart = parseFloat(p.age_start || 0);
                return ageStart <= currentAge && currentAge < ageStart + 10;
            });
        }

        // ì ìˆ˜ ê³„ì‚°
        const scores = calculateSajuScores(pillarsData, pillarsInfo, fortunes, sinsals, daeun);

        // í‚¤ì›Œë“œ ìƒì„±
        const keywords = getSajuKeywords(dayElement, dayFortune, sinsals);

        // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
        let basicInfoHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-left: 4px solid var(--gold-primary); border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“œ ê¸°ë³¸ ì‚¬ì£¼ ë¶„ì„</h3>
            <div style="line-height: 1.8; color: var(--text-primary);">
    `;

        if (dayStemChar && dayElementName) {
            basicInfoHtml += `<p style="margin-bottom: 0.8rem;"><strong>ì¼ê°„(æ—¥å¹²):</strong> ${dayStemChar} (${dayElementName})</p>`;
        }

        if (dayBranchChar) {
            basicInfoHtml += `<p style="margin-bottom: 0.8rem;"><strong>ì¼ì§€(æ—¥æ”¯):</strong> ${dayBranchChar}</p>`;
        }

        if (dayFortune && dayFortuneMeaning) {
            basicInfoHtml += `<p style="margin-bottom: 0.8rem;"><strong>ì¼ì£¼ ìš´ì„±:</strong> ${dayFortune} - ${dayFortuneMeaning}</p>`;
        }

        basicInfoHtml += `
            </div>
        </div>
    `;

        // ìƒë‹¨ ìš”ì•½ ì¹´ë“œ: ì ìˆ˜ ì‹œê°í™”
        let summaryCardHtml = `
        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%); border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; text-align: center;">âœ¨ ì‚¬ì£¼ ìš´ì„¸ ì§€ìˆ˜ (10ì  ë§Œì )</h3>
            ${renderSajuScoreBar('ì¢…í•©ìš´', scores.overall)}
            ${renderSajuScoreBar('ì„±ê²©/íŠ¹ì„±', scores.personality)}
            ${renderSajuScoreBar('ì¬ë¬¼ìš´', scores.wealth)}
            ${renderSajuScoreBar('ì—°ì• Â·ì¸ê°„ê´€ê³„', scores.love)}
            ${renderSajuScoreBar('ê±´ê°•ìš´', scores.health)}
            ${renderSajuScoreBar('ì§ì¥Â·ì‚¬ì—…ìš´', scores.career)}
        </div>
    `;

        // í‚¤ì›Œë“œ ì„¹ì…˜
        const keywordColors = ['#3498db', '#2ecc71', '#f1c40f'];
        let keywordsHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ·ï¸ ì‚¬ì£¼ í‚¤ì›Œë“œ</h4>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                ${keywords.map((keyword, idx) => `
                    <span style="padding: 0.5rem 1rem; background: ${keywordColors[idx % keywordColors.length]}; color: white; border-radius: 20px; font-weight: bold; font-size: 0.95em;">${keyword}</span>
                `).join('')}
            </div>
        </div>
    `;

        // ì˜¤í–‰ ê· í˜• ì‹œê°í™”
        let elementBalanceHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">âš–ï¸ ì˜¤í–‰(äº”è¡Œ) ê· í˜•</h4>
            <div style="line-height: 1.8; color: var(--text-primary);">
    `;

        if (totalCount > 0) {
            const elementColors = { "æœ¨": "#2ecc71", "ç«": "#e74c3c", "åœŸ": "#f39c12", "é‡‘": "#95a5a6", "æ°´": "#3498db" };
            Object.entries(elementCount).forEach(([elem, count]) => {
                if (count > 0) {
                    const percentage = ((count / totalCount) * 100).toFixed(1);
                    const color = elementColors[elem] || "#f1c40f";
                    elementBalanceHtml += `
                    <div style="margin-bottom: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="font-weight: 500;">${elementNames[elem]}</span>
                            <span style="color: ${color}; font-weight: bold;">${percentage}%</span>
                        </div>
                        <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${color};"></div>
                        </div>
                    </div>
                `;
                }
            });
            elementBalanceHtml += `<p style="margin-top: 1rem; color: var(--gold-primary); font-weight: 500;">ì „ì²´ì ìœ¼ë¡œ <strong>${dominantElementName}</strong>ì˜ ê¸°ìš´ì´ ê°€ì¥ ê°•í•˜ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>`;
        }

        elementBalanceHtml += `
            </div>
        </div>
    `;

        // ì„±ê²©/íŠ¹ì„± ìƒì„¸ ë¶„ì„
        let personalityHtml = '';
        if (dayFortune && dayFortuneMeaning) {
            const personalityTraits = {
                "ì œì™•": { strengths: ["ë¦¬ë”ì‹­", "ì¶”ì§„ë ¥", "ê²°ë‹¨ë ¥"], weaknesses: ["ë…ì„ ì ì¼ ìˆ˜ ìˆìŒ", "ê²½ì§ëœ ì‚¬ê³ "], advice: "íƒ€ì¸ê³¼ì˜ í˜‘ë ¥ì„ ì¤‘ì‹œí•˜ê³ , ë‹¤ì–‘í•œ ì˜ê²¬ì„ ìˆ˜ìš©í•˜ëŠ” ìì„¸ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤." },
                "ê±´ë¡": { strengths: ["ë…ë¦½ì„±", "ìì‹ ê°", "ì˜ì§€ë ¥"], weaknesses: ["ê³ ì§‘ìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆìŒ", "íƒ€í˜‘ ë¶€ì¡±"], advice: "í˜¼ì ëª¨ë“  ê²ƒì„ í•´ê²°í•˜ë ¤ í•˜ì§€ ë§ê³ , í•„ìš”ì‹œ ë„ì›€ì„ ìš”ì²­í•˜ëŠ” ê²ƒë„ ì§€í˜œì…ë‹ˆë‹¤." },
                "ì¥ìƒ": { strengths: ["í™œë ¥", "ì„±ì¥ ì˜ì§€", "ì ì‘ë ¥"], weaknesses: ["ê²½í—˜ ë¶€ì¡±", "ì„±ê¸‰í•¨"], advice: "ê¸‰í•˜ê²Œ ì„œë‘ë¥´ì§€ ë§ê³ , ê¾¸ì¤€í•œ ë…¸ë ¥ê³¼ í•™ìŠµì„ í†µí•´ ì‹¤ë ¥ì„ ìŒ“ì•„ê°€ì„¸ìš”." },
                "ê´€ëŒ€": { strengths: ["ì‚¬íšŒì„±", "í˜‘ë ¥", "ì¸ì •ìš•êµ¬"], weaknesses: ["íƒ€ì¸ì˜ ì‹œì„ ì— ë¯¼ê°", "ìê¸° í™•ì‹  ë¶€ì¡±"], advice: "íƒ€ì¸ì˜ í‰ê°€ë³´ë‹¤ ìì‹ ì˜ ê°€ì¹˜ë¥¼ ì¸ì •í•˜ê³ , ë‚´ë©´ì˜ í™•ì‹ ì„ í‚¤ì›Œê°€ì„¸ìš”." },
                "ëª©ìš•": { strengths: ["ë§¤ë ¥", "ì˜ˆìˆ ì„±", "ì ì‘ë ¥"], weaknesses: ["ë³€ë•ìŠ¤ëŸ¬ì›€", "ì§‘ì¤‘ë ¥ ë¶€ì¡±"], advice: "í•œ ê°€ì§€ì— ì§‘ì¤‘í•˜ì—¬ ê¹Šì´ ìˆê²Œ ë°œì „ì‹œí‚¤ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤." },
                "ì‡ ": { strengths: ["ì•ˆì •ì„±", "ì„±ìˆ™í•¨", "ì¸ë‚´"], weaknesses: ["ë³´ìˆ˜ì ", "ë³€í™” ê±°ë¶€"], advice: "ìƒˆë¡œìš´ ì‹œë„ì™€ ë³€í™”ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ê³ , ì ì§„ì ìœ¼ë¡œ ë°œì „ì‹œí‚¤ì„¸ìš”." },
                "ë³‘": { strengths: ["ì‹ ì¤‘í•¨", "ê´€ì°°ë ¥", "ë°˜ì„±"], weaknesses: ["ì†Œê·¹ì ", "ê±´ê°• ê´€ë¦¬ í•„ìš”"], advice: "ê±´ê°• ê´€ë¦¬ì— íŠ¹íˆ ì£¼ì˜í•˜ê³ , ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì„ ìœ ì§€í•˜ì„¸ìš”." },
                "ì‚¬": { strengths: ["ë³€í™” ì ì‘ë ¥", "ìœµí†µì„±"], weaknesses: ["ë¶ˆì•ˆì •", "ì§‘ì¤‘ë ¥ ë¶€ì¡±"], advice: "ë³€í™”ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ê³ , ìƒˆë¡œìš´ ê¸°íšŒë¥¼ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”." },
                "ë¬˜": { strengths: ["ë‚´ë©´ ì„±ì°°", "ê¹Šì€ ì‚¬ê³ "], weaknesses: ["ì†Œí†µ ë¶€ì¡±", "ì€ë‘” ê²½í–¥"], advice: "íƒ€ì¸ê³¼ì˜ ì†Œí†µì„ ëŠ˜ë¦¬ê³ , ë‚´ë©´ì˜ ê¹¨ë‹¬ìŒì„ í˜„ì‹¤ì— ì ìš©í•˜ì„¸ìš”." },
                "ì ˆ": { strengths: ["ì ì¬ë ¥", "ì¤€ë¹„ì„±"], weaknesses: ["í–‰ë™ë ¥ ë¶€ì¡±", "ê¸°íšŒ ë†“ì¹¨"], advice: "ì¤€ë¹„ê°€ ì¤‘ìš”í•˜ì§€ë§Œ, ë•Œë¡œëŠ” ê³¼ê°í•˜ê²Œ ë„ì „í•˜ëŠ” ìš©ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤." },
                "íƒœ": { strengths: ["ì ì¬ë ¥", "ìƒˆë¡œì›€"], weaknesses: ["ë¶ˆì•ˆì •", "ì‹¤í–‰ë ¥ ë¶€ì¡±"], advice: "ì•„ì´ë””ì–´ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì‹¤í–‰ë ¥ê³¼ ì¸ë‚´ë ¥ì´ ì¤‘ìš”í•©ë‹ˆë‹¤." },
                "ì–‘": { strengths: ["í™œë™ë ¥", "ì ê·¹ì„±"], weaknesses: ["ì„±ê¸‰í•¨", "ì¸ë‚´ ë¶€ì¡±"], advice: "í™œë™ì ì¸ ë©´ì„ ì‚´ë¦¬ë˜, ì‹ ì¤‘í•¨ê³¼ ì¸ë‚´ë ¥ì„ í•¨ê»˜ ê¸°ë¥´ì„¸ìš”." }
            };

            const traits = personalityTraits[dayFortune] || { strengths: [], weaknesses: [], advice: "" };

            personalityHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ‘¤ ì„±ê²©/íŠ¹ì„± ìƒì„¸ ë¶„ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(46, 204, 113, 0.1); border-radius: 6px;">
                        <strong style="color: #2ecc71; display: block; margin-bottom: 0.5rem;">âœ¨ ê°•ì :</strong>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${traits.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(241, 196, 15, 0.1); border-radius: 6px;">
                        <strong style="color: #f1c40f; display: block; margin-bottom: 0.5rem;">âš ï¸ ë³´ì™„ì :</strong>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${traits.weaknesses.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 6px;">
                        <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ’¡ ì¡°ì–¸:</strong>
                        <p style="margin: 0;">${traits.advice}</p>
                    </div>
                </div>
            </div>
        `;
        }

        // ì‹­ì´ìš´ì„± ë° ì‹ ì‚´ ë¶„ì„
        let fortuneSinsalHtml = '';
        if (dayFortune && dayFortuneMeaning) {
            fortuneSinsalHtml += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸŒŸ ì‹­ì´ìš´ì„±(åäºŒé‹æ˜Ÿ) ë¶„ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>ì¼ì£¼(æ—¥æŸ±)ì˜ ìš´ì„±ì€ <strong>${dayFortune}</strong>ìœ¼ë¡œ, ${dayFortuneMeaning}ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
        `;
        }

        if (sinsalList) {
            fortuneSinsalHtml += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">âœ¨ ì‹ ì‚´(ç¥ç…) ë¶„ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>${sinsalList}</p>
                </div>
            </div>
        `;
        }

        // ëŒ€ìš´ ë¶„ì„
        let daeunHtml = '';
        if (daeunDirection) {
            daeunHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸŒŠ ëŒ€ìš´(å¤§é‹) ë¶„ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>ëŒ€ìš´ ë°©í–¥ì€ <strong>${daeunDirection}</strong>ì…ë‹ˆë‹¤.</p>
        `;
            if (currentDaeun) {
                const ageStart = Math.floor(parseFloat(currentDaeun.age_start || 0));
                const ageEnd = ageStart + 10;
                daeunHtml += `<p style="margin-top: 0.5rem;">í˜„ì¬ ${ageStart}ì„¸ë¶€í„° ${ageEnd}ì„¸ê¹Œì§€ì˜ ëŒ€ìš´ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¸ìƒì˜ í° íë¦„ì´ ë³€í™”í•˜ëŠ” ì¤‘ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤.</p>`;
            }
            daeunHtml += `
                </div>
            </div>
        `;
        }

        // ì¬í…Œí¬/ì»¤ë¦¬ì–´ íŠ¹í™” ì¡°ì–¸
        const careerAdvice = getSajuCareerAdvice(dayElement, dayFortune, scores, allSinsals);
        let careerAdviceHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’¼ ì¬í…Œí¬Â·ì»¤ë¦¬ì–´ íŠ¹í™” ì¡°ì–¸</h4>
            <div style="line-height: 1.8; color: var(--text-primary);">
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                    <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ’° ì¬í…Œí¬:</strong>
                    <p>${careerAdvice.investment}</p>
                </div>
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                    <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ‘” ì»¤ë¦¬ì–´:</strong>
                    <p>${careerAdvice.career}</p>
                </div>
                <div style="padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                    <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ¢ ì‚¬ì—…:</strong>
                    <p>${careerAdvice.business}</p>
                </div>
            </div>
        </div>
    `;

        // í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸
        const checklist = getSajuActionChecklist(dayElement, dayFortune, scores);
        let checklistHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">âœ… ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    `;

        ['personality', 'wealth', 'health', 'career'].forEach(category => {
            const categoryNames = {
                'personality': 'ì„±ê²©/ê´€ê³„',
                'wealth': 'ì¬ë¬¼',
                'health': 'ê±´ê°•',
                'career': 'ì»¤ë¦¬ì–´'
            };
            const categoryIcons = {
                'personality': 'ğŸ‘¤',
                'wealth': 'ğŸ’°',
                'health': 'ğŸƒ',
                'career': 'ğŸ’¼'
            };
            if (!checklist[category] || !Array.isArray(checklist[category])) return;
            checklistHtml += `
            <div style="padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                <h5 style="color: var(--gold-primary); margin-bottom: 0.8rem; font-size: 1em;">
                    ${categoryIcons[category]} ${categoryNames[category]}
                </h5>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    ${checklist[category].map(item => `
                        <li style="padding: 0.5rem 0; color: var(--text-primary); font-size: 0.9em; line-height: 1.6; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: var(--gold-primary); margin-right: 0.5rem;">â˜</span> ${item}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
        });

        checklistHtml += `
            </div>
        </div>
    `;

        // ì¢…í•© í•´ì„
        let overallHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’¡ ì¢…í•© í•´ì„</h4>
            <div style="line-height: 1.8; color: var(--text-primary);">
    `;

        if (dayElement === dominantElement) {
            overallHtml += `<p style="margin-bottom: 0.8rem;">ì¼ê°„ê³¼ ì „ì²´ ì˜¤í–‰ì´ ì¡°í™”ë¥¼ ì´ë£¨ê³  ìˆì–´, íƒ€ê³ ë‚œ ì„±í–¥ì„ ë°œíœ˜í•˜ê¸°ì— ìœ ë¦¬í•œ ì‚¬ì£¼ì…ë‹ˆë‹¤.</p>`;
        } else {
            overallHtml += `<p style="margin-bottom: 0.8rem;">ì¼ê°„ê³¼ ì „ì²´ ì˜¤í–‰ì˜ ê· í˜•ì„ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë¶€ì¡±í•œ ì˜¤í–‰ì„ ë³´ì™„í•˜ëŠ” í™œë™ì´ë‚˜ í™˜ê²½ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>`;
        }

        if (dayFortune === "ì œì™•" || dayFortune === "ê±´ë¡" || dayFortune === "ì¥ìƒ") {
            overallHtml += `<p style="margin-bottom: 0.8rem;">ê°•í•œ ê¸°ìš´ì„ ê°€ì§€ê³  ìˆì–´ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸°ì— ìœ ë¦¬í•œ ì‹œê¸°ì…ë‹ˆë‹¤. ì ê·¹ì ìœ¼ë¡œ ë„ì „í•˜ê³ , ë¦¬ë”ì‹­ì„ ë°œíœ˜í•  ìˆ˜ ìˆëŠ” ê¸°íšŒë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</p>`;
        } else if (dayFortune === "ì‡ " || dayFortune === "ë³‘" || dayFortune === "ì‚¬") {
            overallHtml += `<p style="margin-bottom: 0.8rem;">ì‹ ì¤‘í•œ íŒë‹¨ê³¼ ì¸ë‚´ê°€ í•„ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤. ë¬´ë¦¬í•œ ë„ì „ë³´ë‹¤ëŠ” ì•ˆì •ì ì¸ ë°œì „ì„ ì¶”êµ¬í•˜ê³ , ê±´ê°• ê´€ë¦¬ì— íŠ¹íˆ ì£¼ì˜í•˜ì„¸ìš”.</p>`;
        } else {
            overallHtml += `<p style="margin-bottom: 0.8rem;">ê¾¸ì¤€í•œ ë…¸ë ¥ê³¼ ê³„íšì„ í†µí•´ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì„ ìœ ì§€í•˜ê³ , ì‘ì€ ì„±ê³¼ë¶€í„° ìŒ“ì•„ê°€ì„¸ìš”.</p>`;
        }

        overallHtml += `
            </div>
        </div>
    `;

        // ìµœì¢… HTML ì¡°í•©
        let html = `
        <div class="basic-analysis-result" style="margin-top: 1.5rem;">
            ${basicInfoHtml}
            ${summaryCardHtml}
            ${keywordsHtml}
            ${elementBalanceHtml}
            ${personalityHtml}
            ${fortuneSinsalHtml}
            ${daeunHtml}
            ${careerAdviceHtml}
            ${checklistHtml}
            ${overallHtml}
        </div>
    `;

        return html;
    }

    // ì¬í…Œí¬/ì»¤ë¦¬ì–´ ì¡°ì–¸ ìƒì„± í•¨ìˆ˜
    function getSajuCareerAdvice(dayElement, dayFortune, scores, sinsals) {
        const wealthScore = scores.wealth || 5;
        const careerScore = scores.career || 5;

        let investment = '', career = '', business = '';

        if (wealthScore >= 8) {
            investment = "ì¬ë¬¼ìš´ì´ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤. ì ê·¹ì ì¸ íˆ¬ìì™€ ìƒˆë¡œìš´ ì¬í…Œí¬ ë°©ë²•ì„ ì‹œë„í•´ë³´ì„¸ìš”. ë‹¤ë§Œ ë¦¬ìŠ¤í¬ ê´€ë¦¬ëŠ” í•­ìƒ ì¤‘ìš”í•©ë‹ˆë‹¤.";
        } else if (wealthScore >= 6) {
            investment = "ì¬ë¬¼ìš´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤. ì•ˆì •ì ì¸ íˆ¬ìì™€ ì¥ê¸°ì ì¸ ê´€ì ì—ì„œ ìì‚°ì„ ëŠ˜ë ¤ê°€ì„¸ìš”. ê¸‰ê²©í•œ íˆ¬ìëŠ” í”¼í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
        } else {
            investment = "ì¬ë¬¼ìš´ì´ ë³´í†µì…ë‹ˆë‹¤. ì €ì¶•ì— ì§‘ì¤‘í•˜ê³ , ì•ˆì •ì ì¸ ë°©ë²•ìœ¼ë¡œ ìì‚°ì„ ëŠ˜ë ¤ê°€ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì§€ì¶œì„ ì¤„ì´ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.";
        }

        if (careerScore >= 8) {
            career = "ì§ì¥Â·ì‚¬ì—…ìš´ì´ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤. ìŠ¹ì§„ì´ë‚˜ ìƒˆë¡œìš´ ê¸°íšŒê°€ ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ì ê·¹ì ìœ¼ë¡œ ë„ì „í•˜ì„¸ìš”. ë¦¬ë”ì‹­ì„ ë°œíœ˜í•  ìˆ˜ ìˆëŠ” ê¸°íšŒë¥¼ ì°¾ì•„ë³´ì„¸ìš”.";
        } else if (careerScore >= 6) {
            career = "ì§ì¥Â·ì‚¬ì—…ìš´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤. í˜„ì¬ ì—…ë¬´ì— ì¶©ì‹¤í•˜ë©´ì„œ ì ì§„ì ìœ¼ë¡œ ë°œì „ì‹œì¼œ ë‚˜ê°€ì„¸ìš”. ë„¤íŠ¸ì›Œí‚¹ê³¼ ìê¸°ê³„ë°œì— íˆ¬ìí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
        } else {
            career = "ì§ì¥Â·ì‚¬ì—…ìš´ì´ ë³´í†µì…ë‹ˆë‹¤. ì•ˆì •ì ìœ¼ë¡œ í˜„ì¬ ìƒí™©ì„ ìœ ì§€í•˜ë©´ì„œ ì‹¤ë ¥ì„ ìŒ“ì•„ê°€ì„¸ìš”. ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ì‹œë©´ ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤.";
        }

        if (dayFortune === "ì œì™•" || dayFortune === "ê±´ë¡") {
            business = "ì°½ì—…ì´ë‚˜ ì‚¬ì—… í™•ì¥ì— ìœ ë¦¬í•œ ì‹œê¸°ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‹ ì¤‘í•œ ê³„íšê³¼ ì¤€ë¹„ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆë¥¼ ì˜ ì„ íƒí•˜ê³ , ì¥ê¸°ì ì¸ ë¹„ì „ì„ ê°€ì ¸ë³´ì„¸ìš”.";
        } else if (dayFortune === "ì¥ìƒ" || dayFortune === "ê´€ëŒ€") {
            business = "ìƒˆë¡œìš´ ì‚¬ì—…ì„ ì‹œì‘í•˜ê¸°ì—ëŠ” ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¶©ë¶„í•œ ì¤€ë¹„ì™€ ì‹œì¥ ì¡°ì‚¬ë¥¼ ë¨¼ì € í•˜ì„¸ìš”. í˜‘ë ¥ê³¼ ë„¤íŠ¸ì›Œí‚¹ì´ ì„±ê³µì˜ ì—´ì‡ ì…ë‹ˆë‹¤.";
        } else {
            business = "ì‚¬ì—…ì€ ì‹ ì¤‘í•˜ê²Œ ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤. ê¸°ì¡´ ì‚¬ì—…ì„ ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜í•˜ë©´ì„œ ì ì§„ì ìœ¼ë¡œ í™•ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ë¬´ë¦¬í•œ ë„ì „ì€ í”¼í•˜ì„¸ìš”.";
        }

        if (sinsals.includes("ì²œì„ê·€ì¸")) {
            career += " íŠ¹íˆ ì£¼ë³€ì˜ ë„ì›€ì´ë‚˜ ì¡°ì–¸ì„ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”.";
        }
        if (sinsals.includes("í™”ê°œ")) {
            career += " í•™ë¬¸ì´ë‚˜ ì „ë¬¸ ì§€ì‹ì„ ìŒ“ëŠ” ê²ƒì´ ì»¤ë¦¬ì–´ ë°œì „ì— ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.";
        }

        return { investment, career, business };
    }

    // í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
    function getSajuActionChecklist(dayElement, dayFortune, scores) {
        const checklist = {
            personality: [],
            wealth: [],
            health: [],
            career: []
        };

        // ì„±ê²©/ê´€ê³„
        if (scores.personality >= 7) {
            checklist.personality = [
                "ë¦¬ë”ì‹­ì„ ë°œíœ˜í•  ìˆ˜ ìˆëŠ” ê¸°íšŒ ì°¾ê¸°",
                "íƒ€ì¸ê³¼ì˜ í˜‘ë ¥ ê´€ê³„ ê°•í™”í•˜ê¸°",
                "ìì‹ ì˜ ê°•ì ì„ í™œìš©í•œ í”„ë¡œì íŠ¸ ì œì•ˆí•˜ê¸°"
            ];
        } else {
            checklist.personality = [
                "ìê¸°ê³„ë°œì„ ìœ„í•œ í•™ìŠµ ê³„íš ìˆ˜ë¦½í•˜ê¸°",
                "íƒ€ì¸ê³¼ì˜ ì†Œí†µ ê¸°íšŒ ëŠ˜ë¦¬ê¸°",
                "ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ ìœ ì§€í•˜ê¸°"
            ];
        }

        // ì¬ë¬¼
        if (scores.wealth >= 7) {
            checklist.wealth = [
                "íˆ¬ì ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰í•˜ê¸°",
                "ì¬í…Œí¬ ê´€ë ¨ ì •ë³´ ìˆ˜ì§‘ ë° í•™ìŠµí•˜ê¸°",
                "ì›” ì €ì¶• ëª©í‘œ ê¸ˆì•¡ ì„¤ì •í•˜ê¸°"
            ];
        } else {
            checklist.wealth = [
                "ì›”ë³„ ì§€ì¶œ ë‚´ì—­ ì •ë¦¬í•˜ê¸°",
                "ë¶ˆí•„ìš”í•œ ì§€ì¶œ ì¤„ì´ê¸°",
                "ì•ˆì •ì ì¸ ì €ì¶• ê³„íš ìˆ˜ë¦½í•˜ê¸°"
            ];
        }

        // ê±´ê°•
        if (scores.health < 6) {
            checklist.health = [
                "ì •ê¸°ì ì¸ ê±´ê°•ê²€ì§„ ë°›ê¸°",
                "ê·œì¹™ì ì¸ ìš´ë™ ìŠµê´€ ë§Œë“¤ê¸°",
                "ì¶©ë¶„í•œ ìˆ˜ë©´ê³¼ íœ´ì‹ ì‹œê°„ í™•ë³´í•˜ê¸°"
            ];
        } else {
            checklist.health = [
                "ê±´ê°•í•œ ì‹ìŠµê´€ ìœ ì§€í•˜ê¸°",
                "ì£¼ 2-3íšŒ ìš´ë™í•˜ê¸°",
                "ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ ë°©ë²• ì°¾ê¸°"
            ];
        }

        // ì»¤ë¦¬ì–´
        if (scores.career >= 7) {
            checklist.career = [
                "ì§ì¥ ë‚´ ë„¤íŠ¸ì›Œí‚¹ ê°•í™”í•˜ê¸°",
                "ìê¸°ê³„ë°œ ê°•ì¢Œë‚˜ ì„¸ë¯¸ë‚˜ ì°¸ì—¬í•˜ê¸°",
                "ì—…ë¬´ ëª©í‘œì™€ ê³„íš ì¬ì ê²€í•˜ê¸°"
            ];
        } else {
            checklist.career = [
                "í˜„ì¬ ì—…ë¬´ì— ì§‘ì¤‘í•˜ë©° ì„±ê³¼ ë‚´ê¸°",
                "ìƒˆë¡œìš´ ìŠ¤í‚¬ í•™ìŠµí•˜ê¸°",
                "ì§ì¥ ë‚´ í˜‘ë ¥ ê´€ê³„ ê°œì„ í•˜ê¸°"
            ];
        }

        return checklist;
    }

    // AI ë¶„ì„ ê²°ê³¼ í¬ë§·íŒ…
    function formatAIResult(data) {
        if (!data || typeof data !== 'object') {
            return '<div>AI ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        const summary = data.summary || {};
        const personality = data.personality || {};
        const wealth = data.wealth || {};
        const career = data.career || {};
        const relationships = data.relationships || {};
        const health = data.health || {};
        const lifeAdvice = data.lifeAdvice || {};
        const currentFortune = data.currentFortune || {};

        let html = `
        <div class="ai-analysis-result" style="margin-top: 1.5rem;">
            <!-- ì¢…í•© ë¶„ì„ -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“œ AI ì¢…í•© ë¶„ì„</h3>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin-bottom: 0.5rem;"><strong>ì¼ê°„(æ—¥å¹²):</strong> ${summary.dayMasterType || '-'}</p>
                    <p style="margin-bottom: 0.5rem;"><strong>ê²©êµ­/ìš©ì‹ :</strong> ${summary.gyeokguk || '-'} / ${summary.yongsin || '-'}</p>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">
                    <p><strong>ğŸ’¡ ì´í‰:</strong><br>${summary.overallTone || '-'}</p>
                </div>
            </div>
            
            <!-- ì„±ê²©/íŠ¹ì„± -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ‘¤ ì„±ê²©ê³¼ ì‹¬ë¦¬</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem;">
                        <span style="color: #A0AEC0; font-size: 0.9em;">í•µì‹¬ í‚¤ì›Œë“œ</span><br>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            ${(personality.coreTraits || []).map(t => `<span style="padding: 0.3rem 0.8rem; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.9em;">${t}</span>`).join('') || '-'}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(46, 204, 113, 0.1); border-radius: 6px;">
                            <strong style="color: #2ecc71;">ê°•ì </strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem; font-size: 0.95em;">
                                ${(personality.strengths || []).map(s => `<li>${s}</li>`).join('') || '-'}
                            </ul>
                        </div>
                        <div style="padding: 1rem; background: rgba(241, 196, 15, 0.1); border-radius: 6px;">
                            <strong style="color: #f1c40f;">ë³´ì™„ì </strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem; font-size: 0.95em;">
                                ${(personality.weaknesses || []).map(w => `<li>${w}</li>`).join('') || '-'}
                            </ul>
                        </div>
                    </div>
                    <p style="margin-top: 1rem;">${personality.detailedAnalysis || '-'}</p>
                </div>
            </div>

            <!-- ì¬ë¬¼ìš´ -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’° ì¬ë¬¼ìš´ ë¶„ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p style="margin-bottom: 0.8rem;"><strong>ì¬ë¬¼ìš´ íë¦„:</strong> ${wealth.wealthLuck || '-'}</p>
                    <p style="margin-bottom: 0.8rem;"><strong>ìˆ˜ì… ìŠ¤íƒ€ì¼:</strong> ${wealth.incomeStyle || '-'}</p>
                    <div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 6px; margin-top: 1rem;">
                        <strong style="color: var(--gold-primary);">ìƒì„¸ ì¡°ì–¸</strong>
                        <p style="margin-top: 0.5rem;">${wealth.detailedAnalysis || '-'}</p>
                    </div>
                </div>
            </div>

            <!-- ì§ì—…/ì§„ë¡œ -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’¼ ì§ì—…ê³¼ ì§„ë¡œ</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem;">
                        <strong style="display: block; margin-bottom: 0.5rem;">ì¶”ì²œ ë¶„ì•¼</strong>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${(career.suitableFields || []).map(f => `<span style="padding: 0.3rem 0.8rem; background: rgba(52, 152, 219, 0.15); color: #3498db; border-radius: 6px; font-weight: 500;">${f}</span>`).join('') || '-'}
                        </div>
                    </div>
                    <p>${career.detailedAnalysis || '-'}</p>
                </div>
            </div>

            <!-- ì¸ê°„ê´€ê³„/ì• ì • -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">â¤ï¸ ì¸ê°„ê´€ê³„ì™€ ì• ì •</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: #e74c3c;">ì—°ì• /ê²°í˜¼:</strong> ${relationships.romantic?.loveStyle || '-'}
                        <p style="margin-top: 0.5rem;">${relationships.romantic?.analysis || '-'}</p>
                    </div>
                    <div>
                        <strong style="color: #2ecc71;">ê°€ì¡±/ëŒ€ì¸ê´€ê³„:</strong>
                        <p style="margin-top: 0.5rem;">${relationships.family?.analysis || '-'}</p>
                    </div>
                </div>
            </div>

            <!-- ê±´ê°• -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ¥ ê±´ê°• ì¡°ì–¸</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>${health.detailedAnalysis || '-'}</p>
                </div>
            </div>

            <!-- ì¸ìƒ ì¡°ì–¸ (ê°œìš´ë²•) -->
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold); margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ€ í–‰ìš´ê³¼ ê°œìš´ë²•</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; color: #A0AEC0; margin-bottom: 0.5rem;">í–‰ìš´ì˜ ìƒ‰</div>
                        <strong style="font-size: 1.1em;">${(lifeAdvice.luckyElements?.colors || []).join(', ') || '-'}</strong>
                    </div>
                    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; color: #A0AEC0; margin-bottom: 0.5rem;">í–‰ìš´ì˜ ìˆ«ì</div>
                        <strong style="font-size: 1.1em;">${(lifeAdvice.luckyElements?.numbers || []).join(', ') || '-'}</strong>
                    </div>
                </div>
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-left: 3px solid var(--gold-primary); border-radius: 4px;">
                    <p style="margin: 0; font-style: italic;">"${lifeAdvice.detailedGuidance || '-'}"</p>
                </div>
            </div>
            
            <!-- í˜„ì¬ ìš´ì„¸ -->
            ${currentFortune.yearlyForecast ? `
            <div style="padding: 1.5rem; background: var(--navy-glass); border-radius: 8px; border: 1px solid var(--border-gold);">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“… ì˜¬í•´(ì„¸ìš´)ì™€ ëŒ€ìš´ì˜ íë¦„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem;">
                        <strong>ëŒ€ìš´:</strong> ${currentFortune.daeunPeriod || '-'} (${currentFortune.overallTrend || '-'})
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <strong>ì˜¬í•´ ì „ë§</strong>
                        <p style="margin-top: 0.5rem;">${currentFortune.yearlyForecast}</p>
                    </div>
                    ${currentFortune.detailedAnalysis ? `<p style="margin-top: 1rem;">${currentFortune.detailedAnalysis}</p>` : ''}
                </div>
            </div>
            ` : ''}
        </div>
    `;

        return html;
    }

    // API Key ì…ë ¥ ì²˜ë¦¬ (ì €ì¥í•˜ì§€ ì•Šê³  ì…ë ¥ê°’ë§Œ ì‚¬ìš©)
    function setupApiKeyAutoSave() {
        const apiKeyInput = document.getElementById('api-key-input');
        const statusDiv = document.getElementById('api-key-status');

        if (!apiKeyInput) {
            return;
        }

        let inputTimeout = null;

        // API Key ê²€ì¦ ë° AI ë¶„ì„ ì‹¤í–‰ í•¨ìˆ˜
        function triggerAIAnalysisIfNeeded() {
            // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (isAIAnalysisRunning) {
                console.log('AI ë¶„ì„ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ìš”ì²­ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
                return;
            }

            const apiKey = apiKeyInput.value.trim();

            // API Keyê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            if (!apiKey || !apiKey.startsWith('sk-') || apiKey.length <= 20) {
                if (!apiKey) {
                    lastProcessedApiKey = ''; // API Keyê°€ ë¹„ì›Œì§€ë©´ ë¦¬ì…‹
                    if (statusDiv) {
                        statusDiv.style.display = 'none';
                    }
                }
                return;
            }

            // ê³„ì‚° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            if (!lastCalculatedData) {
                console.log('ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‚¬ì£¼ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ë¯¸ ì²˜ë¦¬í•œ API Keyì™€ ë™ì¼í•˜ë©´ ë¬´ì‹œ
            if (apiKey === lastProcessedApiKey) {
                console.log('ì´ë¯¸ ì²˜ë¦¬í•œ API Keyì…ë‹ˆë‹¤. ì¤‘ë³µ ìš”ì²­ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
                return;
            }

            // ì¡°ê±´ì„ í†µê³¼í–ˆìœ¼ë¯€ë¡œ ì¦‰ì‹œ lastProcessedApiKey ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
            // ì´ë ‡ê²Œ í•˜ë©´ blurì™€ input ì´ë²¤íŠ¸ê°€ ë™ì‹œì— ë°œìƒí•´ë„ í•˜ë‚˜ë§Œ ì‹¤í–‰ë¨
            lastProcessedApiKey = apiKey;

            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#86EFAC';
                statusDiv.textContent = 'âœ… API Keyê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. AI ë¶„ì„ì„ ë‹¤ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤...';
            }

            // API Key ì…ë ¥ í›„, AI ë¶„ì„ ì„¹ì…˜ í‘œì‹œ ë° AI ë¶„ì„ ì‹¤í–‰
            const aiResultCard = document.querySelector('.result-card');
            if (aiResultCard) {
                aiResultCard.style.display = 'block';
                setTimeout(() => {
                    runAIAnalysis(lastCalculatedData);
                }, 500);
            }
        }

        // ì…ë ¥ ì¤‘ debounce (1ì´ˆ í›„ ì²˜ë¦¬)
        apiKeyInput.addEventListener('input', function () {
            const apiKey = apiKeyInput.value.trim();

            if (inputTimeout) {
                clearTimeout(inputTimeout);
            }

            inputTimeout = setTimeout(() => {
                triggerAIAnalysisIfNeeded();
                inputTimeout = null; // ì‹¤í–‰ í›„ timeout ì´ˆê¸°í™”
            }, 1000);
        });

        // í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ì²˜ë¦¬ (input ì´ë²¤íŠ¸ì˜ debounce timeoutì´ ìˆìœ¼ë©´ ì·¨ì†Œí•˜ê³  ì¦‰ì‹œ ì‹¤í–‰)
        apiKeyInput.addEventListener('blur', function () {
            // input ì´ë²¤íŠ¸ì˜ debounce timeoutì´ ìˆìœ¼ë©´ ì·¨ì†Œí•˜ê³  ì¦‰ì‹œ ì‹¤í–‰
            if (inputTimeout) {
                clearTimeout(inputTimeout);
                inputTimeout = null;
                // blurì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ (triggerAIAnalysisIfNeeded ë‚´ë¶€ì—ì„œ ì¤‘ë³µ ì²´í¬)
                triggerAIAnalysisIfNeeded();
            }
            // timeoutì´ nullì´ë©´ ì´ë¯¸ input ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë˜ì—ˆê±°ë‚˜ ì•„ì§ debounce ì‹œê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë¬´ì‹œ
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ìš´ì„¸ë‹´ ì•±ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        setupApiKeyAutoSave();

        // localStorageì—ì„œ ì½ì–´ì™€ì„œ í¼ì— ì±„ìš°ê¸° (ì„¸ì…˜ ê°’ë³´ë‹¤ ìš°ì„ )
        fillFormFromLocalStorage('input-form');

        // í¼ì— ê°’ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ (ì„¸ì…˜ ë°ì´í„° ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ)
        // setTimeoutì„ ì‚¬ìš©í•˜ì—¬ fillFormFromLocalStorage ì™„ë£Œ í›„ ì‹¤í–‰ ë³´ì¥
        setTimeout(() => {
            const form = document.getElementById('input-form');
            if (form) {
                const nameInput = form.querySelector('[name="name"]');
                const birthDateInput = form.querySelector('[name="birth_date"]');
                const genderSelect = form.querySelector('[name="gender"]');

                // í¼ì— í•„ìˆ˜ ê°’ì´ ìˆìœ¼ë©´ ìë™ ë¡œë“œ
                if (nameInput?.value && birthDateInput?.value && genderSelect?.value) {
                    autoLoadResults();
                }
            }
        }, 100);
    });

    // ì„¸ì…˜ ë°ì´í„°ë¡œ ìë™ ê²°ê³¼ ë¡œë“œ
    async function autoLoadResults() {
        const form = document.getElementById('input-form');
        if (!form) return;

        // í¼ì—ì„œ ì§ì ‘ ê°’ì„ ì½ì–´ì™€ì„œ ì‚¬ìš© (localStorageì—ì„œ ì±„ì›Œì§„ ìµœì‹  ê°’)
        const nameInput = form.querySelector('[name="name"]');
        const birthDateInput = form.querySelector('[name="birth_date"]');
        const birthTimeInput = form.querySelector('[name="birth_time"]');
        const genderSelect = form.querySelector('[name="gender"]');
        const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

        // í¼ ê°’ì´ ì—†ìœ¼ë©´ ìë™ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        if (!nameInput?.value || !birthDateInput?.value || !genderSelect?.value) {
            return;
        }

        // í¼ ë°ì´í„° ì¤€ë¹„
        const formData = new FormData();
        formData.append('name', nameInput.value);
        formData.append('birth_date', birthDateInput.value);
        formData.append('birth_time', birthTimeInput.value || '');
        formData.append('gender', genderSelect.value);
        if (isLunarCheckbox?.checked) {
            formData.append('is_lunar', 'true');
        }

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ê²°ê³¼ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§
                renderResults(data.data);

                // AI ë¶„ì„ ìë™ ì‹œì‘
                setTimeout(() => {
                    runAIAnalysis(data.data);
                }, 300);
            }
        } catch (error) {
            console.error('ìë™ ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}