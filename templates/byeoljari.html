{% extends "base.html" %}

{% block sidebar %}
{% include "includes/sidebar_input.html" %}

<!-- Sidebar Banner -->
{{ sidebar_banner_html | safe }}
{% endblock %}

{% block content %}
<!-- ìš°ì¸¡: ë³„ìë¦¬ìš´ì„¸ ê²°ê³¼ -->
<div class="result-container">
    <!-- ì»¨í…ì¸  ìƒë‹¨ ë°°ë„ˆ -->

    {% if not processed or not birth_date %}
    <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">â­</div>
        <h2 style="color: var(--gold-primary); margin-bottom: 1rem;">ë³„ìë¦¬ìš´ì„¸</h2>
        <p style="color: var(--text-muted); line-height: 1.8;">
            ì™¼ìª½ì—ì„œ ì„±í•¨ê³¼ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì‹œë©´ ë³„ìë¦¬ ìš´ì„¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>
    {% else %}
    <div class="glass-card" id="byeoljari-container">
        <div class="section-header" id="byeoljari-title" style="display: none;">
            <span>â­</span> <span id="user-name">{{ user_name }}</span>ë‹˜ì˜ <span id="current-year">{{ current_year
                }}</span>ë…„ ë³„ìë¦¬ìš´ì„¸
        </div>

        <!-- ë¡œë”© í‘œì‹œ -->
        <div id="byeoljari-loading" style="text-align: center; padding: 2rem;">
            <div class="spinner"
                style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;">
            </div>
            <p style="margin-top: 1rem; color: var(--text-muted);">ë³„ìë¦¬ ìš´ì„¸ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="byeoljari-result" style="display: none;"></div>

        <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ ì˜ì—­ -->
        <div id="byeoljari-share" style="display: none;">
            {% include "includes/share_buttons.html" %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // ë§ˆì§€ë§‰ ê³„ì‚°ëœ ë°ì´í„° ì €ì¥ (AI ë¶„ì„ìš©)
    let lastCalculatedData = null;
    let isAIAnalysisRunning = false;
    let lastProcessedApiKey = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³„ìë¦¬ìš´ì„¸ ê³„ì‚°
    document.addEventListener('DOMContentLoaded', function () {
        // localStorageì—ì„œ ì½ì–´ì™€ì„œ í¼ì— ì±„ìš°ê¸° (ì„¸ì…˜ ê°’ë³´ë‹¤ ìš°ì„ )
        fillFormFromLocalStorage('input-form');

        // í¼ì— ê°’ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ
        setTimeout(() => {
            const form = document.getElementById('input-form');
            if (form) {
                const nameInput = form.querySelector('[name="name"]');
                const birthDateInput = form.querySelector('[name="birth_date"]');
                const genderSelect = form.querySelector('[name="gender"]');

                if (nameInput?.value && birthDateInput?.value && genderSelect?.value) {
                    autoLoadByeoljari();
                }
            }
        }, 100);

        // API Key ì…ë ¥ ê°ì§€ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const apiKeyInput = document.getElementById('api-key-input');
        if (apiKeyInput) {
            apiKeyInput.addEventListener('change', function () {
                const apiKey = this.value.trim();
                if (apiKey.startsWith('sk-') && apiKey.length > 20 && lastCalculatedData && apiKey !== lastProcessedApiKey) {
                    console.log('API Key ë³€ê²½ ê°ì§€: AI ë¶„ì„ ìš”ì²­');
                    requestAIAnalysis(lastCalculatedData);
                }
            });
        }
    });

    // AI ê²°ê³¼ í¬ë§·íŒ…
    function formatAIResult(data) {
        if (!data) return '';

        let html = '';

        if (data.overview) {
            html += `
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(212,175,55,0.15); border-radius: 12px; border: 1px solid var(--border-gold);">
                    <div style="color: #D4AF37; font-size: 1.1em; font-weight: bold; margin-bottom: 0.5rem;">${data.overview.keyTheme || 'ì˜¤ëŠ˜ì˜ í…Œë§ˆ'}</div>
                    <div style="color: #E2E8F0; line-height: 1.6;">${data.overview.summary || ''}</div>
                </div>
            `;
        }

        if (data.detailedAnalysis) {
            const sections = [
                { key: 'personality', icon: 'ğŸ§ ', title: 'ì‹¬ë¦¬ & ì„±ê²©' },
                { key: 'love', icon: 'â¤ï¸', title: 'ì• ì •ìš´' },
                { key: 'career', icon: 'ğŸ’¼', title: 'ì§ì—…/í•™ì—…ìš´' },
                { key: 'wealth', icon: 'ğŸ’°', title: 'ì¬ë¬¼ìš´' },
                { key: 'health', icon: 'ğŸ¥', title: 'ê±´ê°•ìš´' }
            ];

            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">`;

            sections.forEach(sec => {
                if (data.detailedAnalysis[sec.key]) {
                    html += `
                        <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">${sec.icon} ${sec.title}</div>
                            <div style="color: #E2E8F0; font-size: 0.95em; line-height: 1.6;">${data.detailedAnalysis[sec.key]}</div>
                        </div>
                    `;
                }
            });

            html += `</div>`;
        }

        if (data.advice) {
            html += `
                <div style="margin-top: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ’¡ AIì˜ ì¡°ì–¸</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(46,204,113,0.15); border-radius: 8px;">
                            <div style="color: #2ecc71; font-weight: bold; margin-bottom: 0.5rem;">Do (ì¶”ì²œ)</div>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #E2E8F0;">
                                ${(data.advice.do || []).map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="padding: 1rem; background: rgba(231,76,60,0.15); border-radius: 8px;">
                            <div style="color: #e74c3c; font-weight: bold; margin-bottom: 0.5rem;">Avoid (ì£¼ì˜)</div>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #E2E8F0;">
                                ${(data.advice.avoid || []).map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    ${data.advice.luckyTip ? `
                    <div style="padding: 1rem; background: rgba(52,152,219,0.15); border-radius: 8px; text-align: center;">
                        <span style="color: #3498db; font-weight: bold;">ğŸ€ í–‰ìš´ íŒ:</span> 
                        <span style="color: #E2E8F0;">${data.advice.luckyTip}</span>
                    </div>` : ''}
                </div>
            `;
        }

        return html;
    }

    // AI ë¶„ì„ ìš”ì²­
    async function requestAIAnalysis(byeoljariData) {
        const apiKeyInput = document.getElementById('api-key-input');
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
        const submitBtn = document.querySelector('button[type="submit"]');

        if (!apiKey || !apiKey.startsWith('sk-')) {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
            return;
        }

        if (isAIAnalysisRunning) return;
        isAIAnalysisRunning = true;

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'AI ë¶„ì„ì¤‘...';
        }

        lastProcessedApiKey = apiKey;

        // AI ë¶„ì„ ì¹´ë“œ í‘œì‹œ
        const aiCard = document.getElementById('ai-analysis-card');
        if (aiCard) aiCard.style.display = 'block';

        const aiResultDiv = document.getElementById('ai-result');
        if (!aiResultDiv) {
            isAIAnalysisRunning = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
            return;
        }

        aiResultDiv.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 1rem; color: var(--text-muted);">AIê°€ ë³„ìë¦¬ ìš´ì„¸ë¥¼ ì‹¬ë„ìˆê²Œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                <p style="font-size: 0.9em; color: var(--text-muted); opacity: 0.7;">(ìµœëŒ€ 30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</p>
            </div>
        `;

        try {
            const response = await fetch('/api/byeoljari-ai-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ byeoljari_data: byeoljariData, api_key: apiKey })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'AI ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedText = '';
            let buffer = '';
            let fullData = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.trim()) continue;
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.substring(6).trim();
                            const data = JSON.parse(jsonStr);
                            if (data.type === 'start') accumulatedText = '';
                            else if (data.type === 'chunk' && data.content) accumulatedText += data.content;
                            else if (data.type === 'complete') fullData = data.data;
                            else if (data.type === 'error') throw new Error(data.error);
                        } catch (e) { console.error('Parsing error:', e); }
                    }
                }
            }

            if (fullData) aiResultDiv.innerHTML = formatAIResult(fullData);
            else if (accumulatedText) {
                try {
                    aiResultDiv.innerHTML = formatAIResult(JSON.parse(accumulatedText));
                } catch (e) {
                    aiResultDiv.innerHTML = `<div style="padding: 1rem; color: #FCA5A5;">ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
                }
            }
        } catch (error) {
            console.error('AI Analysis Error:', error);
            aiResultDiv.innerHTML = `<div style="padding: 1rem; color: #FCA5A5;">âš ï¸ ${error.message || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`;
        } finally {
            isAIAnalysisRunning = false;
            // ë²„íŠ¼ í™œì„±í™”
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    }

    // ì„¸ì…˜ ë°ì´í„°ë¡œ ìë™ ë³„ìë¦¬ìš´ì„¸ ë¡œë“œ
    async function autoLoadByeoljari() {
        // í¼ì—ì„œ ì§ì ‘ ê°’ì„ ì½ì–´ì™€ì„œ ì‚¬ìš© (localStorageì—ì„œ ì±„ì›Œì§„ ìµœì‹  ê°’)
        const form = document.getElementById('input-form');
        if (!form) return;

        const nameInput = form.querySelector('[name="name"]');
        const birthDateInput = form.querySelector('[name="birth_date"]');
        const birthTimeInput = form.querySelector('[name="birth_time"]');
        const genderSelect = form.querySelector('[name="gender"]');
        const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

        // í¼ ê°’ì´ ì—†ìœ¼ë©´ ìë™ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        if (!nameInput?.value || !birthDateInput?.value || !genderSelect?.value) {
            return;
        }

        // ë¨¼ì € ì‚¬ì£¼ ê³„ì‚° APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const formData = new FormData();
        formData.append('name', nameInput.value);
        formData.append('birth_date', birthDateInput.value);
        formData.append('birth_time', birthTimeInput.value || '');
        formData.append('gender', genderSelect.value);
        if (isLunarCheckbox?.checked) {
            formData.append('is_lunar', 'true');
        }

        try {
            // ì‚¬ì£¼ ê³„ì‚° ë¨¼ì € ìˆ˜í–‰
            const calculateResponse = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const calculateData = await calculateResponse.json();

            if (calculateResponse.ok && calculateData.success) {
                // ë³„ìë¦¬ìš´ì„¸ ê³„ì‚° (í¼ì—ì„œ ì§ì ‘ ì½ì€ ìƒë…„ì›”ì¼ê³¼ ì´ë¦„ ì „ë‹¬)
                calculateByeoljari(birthDateInput.value, nameInput.value);
            } else {
                // ì‚¬ì£¼ ê³„ì‚° ì‹¤íŒ¨ ì‹œ í¼ ê°’ìœ¼ë¡œ ì§ì ‘ ì‹œë„
                calculateByeoljari(birthDateInput.value, nameInput.value);
            }
        } catch (error) {
            console.error('ìë™ ë³„ìë¦¬ìš´ì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ í¼ ê°’ìœ¼ë¡œ ì§ì ‘ ì‹œë„
            calculateByeoljari(birthDateInput.value, nameInput.value);
        }
    }

    // ë³„ìë¦¬ìš´ì„¸ ê³„ì‚°
    async function calculateByeoljari(birthDate = null, userName = null) {
        const loadingDiv = document.getElementById('byeoljari-loading');
        const resultDiv = document.getElementById('byeoljari-result');

        if (!loadingDiv || !resultDiv) return;

        // ë¡œë”© í‘œì‹œ
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';

        // ìƒë…„ì›”ì¼ê³¼ ì´ë¦„ì´ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ í¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!birthDate) {
            const birthDateInput = document.getElementById('birth_date');
            if (birthDateInput) birthDate = birthDateInput.value;
        }
        if (!userName) {
            const nameInput = document.getElementById('name');
            if (nameInput) userName = nameInput.value;
        }

        try {
            const requestBody = {};
            if (birthDate) requestBody.birth_date = birthDate;
            if (userName) requestBody.user_name = userName;

            const response = await fetch('/api/byeoljari', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (response.ok && data.success) {
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                renderByeoljariResult(data.data);
            } else {
                loadingDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ${data.detail || 'ë³„ìë¦¬ìš´ì„¸ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`;
            }
        } catch (error) {
            console.error('ë³„ìë¦¬ìš´ì„¸ ê³„ì‚° ì˜¤ë¥˜:', error);
            loadingDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        }
    }

    // ë³„ìë¦¬ìš´ì„¸ ê²°ê³¼ ë Œë”ë§
    function renderByeoljariResult(data) {
        lastCalculatedData = data;

        const resultDiv = document.getElementById('byeoljari-result');
        if (!resultDiv) return;

        // ì •ë³´ì…ë ¥ë€ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  ê°’)
        const nameInput = document.getElementById('name');
        const userName = nameInput?.value || data.user_name || '';

        // ì˜¬í•´ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
        const currentYear = data.current_year || new Date().getFullYear();

        // ìƒë‹¨ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        const titleDiv = document.getElementById('byeoljari-title');
        if (titleDiv) {
            const userNameSpan = titleDiv.querySelector('#user-name');
            const currentYearSpan = titleDiv.querySelector('#current-year');
            if (userNameSpan) userNameSpan.textContent = userName;
            if (currentYearSpan) currentYearSpan.textContent = currentYear;
            titleDiv.style.display = 'block';
        }

        // ê³µìœ  ë²„íŠ¼ í‘œì‹œ
        const shareDiv = document.getElementById('byeoljari-share');
        if (shareDiv) shareDiv.style.display = 'block';

        // ê³µìœ  ë°ì´í„° ì„¤ì •
        const shareTitle = `${data.current_year || new Date().getFullYear()}ë…„ ${userName}ë‹˜ì˜ ë³„ìë¦¬ ìš´ì„¸ - ${data.korean_name} (${data.emoji})`;
        const shareDesc = `ì˜¤ëŠ˜ì˜ ìš´ì„¸: ${data.today_fortune.level}! ${data.today_fortune.message.substring(0, 50)}...`;

        window.currentShareData = {
            title: shareTitle,
            description: shareDesc,
            url: window.location.href,
            text: `${shareTitle}\n${shareDesc}\n\nì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!`
        };

        // API Key í™•ì¸
        const apiKeyInput = document.getElementById('api-key-input');
        const hasApiKey = apiKeyInput ? apiKeyInput.value.trim().startsWith('sk-') && apiKeyInput.value.trim().length > 20 : false;

        // AI ë¶„ì„ ìë™ ìš”ì²­
        if (hasApiKey) {
            console.log('API Key ì¡´ì¬, AI ë¶„ì„ ìë™ ìš”ì²­');
            setTimeout(() => requestAIAnalysis(data), 100);
        }

        let html = '';

        // AI ë¶„ì„ ì„¹ì…˜ ì¶”ê°€
        const aiDisplay = hasApiKey ? 'block' : 'none';
        html += `
        <div id="ai-analysis-card" class="glass-card result-card" style="margin-bottom: 2rem; display: ${aiDisplay};">
            <div class="section-header">
                <span>ğŸ”®</span> AI ë³„ìë¦¬ ì‹¬ì¸µ ë¶„ì„
            </div>
            
            <div id="ai-result-container">
                <div id="ai-result" style="margin-top: 1.5rem;">
        `;

        if (hasApiKey) {
            html += `
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">AIê°€ ë³„ìë¦¬ ìš´ì„¸ë¥¼ ì‹¬ë„ìˆê²Œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            `;
        } else {
            html += `<div style="padding: 1rem; color: var(--text-muted); text-align: center; background: rgba(0,0,0,0.2); border-radius: 8px;">OpenAI API Keyë¥¼ ì…ë ¥í•˜ì‹œë©´ AI ì ì„±ê°€ê°€ ë‹¹ì‹ ì˜ ë³„ìë¦¬ë¥¼ ì‹¬ë„ìˆê²Œ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</div>`;
        }

        html += `
                </div>
            </div>
        </div>
        `;

        html += `
        <!-- ë³„ìë¦¬ ê¸°ë³¸ ì •ë³´ -->
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; margin-bottom: 2rem; text-align: center;">
            <div style="font-size: 5rem; margin-bottom: 1rem; filter: drop-shadow(0 0 10px rgba(212,175,55,0.5));">${data.emoji}</div>
            <div style="font-size: 2.2em; font-weight: bold; color: #D4AF37; margin-bottom: 0.5rem; text-shadow: 0 0 10px rgba(212,175,55,0.5);">${data.korean_name}</div>
            <div style="color: #A0AEC0; font-size: 1.2em; margin-bottom: 0.8rem;">${data.english_name}</div>
            <div style="color: #A0AEC0; font-size: 0.95em; margin-bottom: 1rem;">ìƒì¼: ${data.birth_date_formatted}</div>
            <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212,175,55,0.2);">
                <div>
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.3rem;">ìˆ˜í˜¸ì„±</div>
                    <div style="color: #E2E8F0; font-weight: 600;">${data.constellation_info.planet || '-'}</div>
                </div>
                <div>
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.3rem;">ì›ì†Œ</div>
                    <div style="color: #E2E8F0; font-weight: 600;">${data.constellation_info.element || '-'}</div>
                </div>
                <div>
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.3rem;">ê¸°ê°„</div>
                    <div style="color: #E2E8F0; font-weight: 600; font-size: 0.9em;">${data.constellation_info.period || '-'}</div>
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ëŠ˜ì˜ ìš´ì„¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸŒ… ì˜¤ëŠ˜ì˜ ìš´ì„¸</h3>
        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(212,175,55,0.15) 0%, rgba(212,175,55,0.05) 100%); border-left: 5px solid ${data.today_fortune.color}; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <span style="font-size: 2.5rem;">${data.today_fortune.emoji}</span>
                <div>
                    <div style="font-size: 1.8em; font-weight: bold; color: ${data.today_fortune.color}; margin-bottom: 0.3rem;">${data.today_fortune.level}ì˜ í•˜ë£¨</div>
                    <div style="color: #A0AEC0; font-size: 0.9em;">${data.current_date}</div>
                </div>
            </div>
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em; margin-bottom: 1.5rem;">${data.today_fortune.message}</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.5rem;">ğŸ’• ì—°ì• ìš´</div>
                    <div style="color: #E2E8F0; font-size: 0.95em; line-height: 1.6;">${data.today_fortune.love}</div>
                </div>
                <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.5rem;">ğŸ’¼ ì‚¬ì—…/ì§ì¥ìš´</div>
                    <div style="color: #E2E8F0; font-size: 0.95em; line-height: 1.6;">${data.today_fortune.work}</div>
                </div>
                <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.5rem;">ğŸ¥ ê±´ê°•ìš´</div>
                    <div style="color: #E2E8F0; font-size: 0.95em; line-height: 1.6;">${data.today_fortune.health}</div>
                </div>
            </div>
        </div>
        
        <!-- ì´ë²ˆ ì£¼ ìš´ì„¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ“… ì´ë²ˆ ì£¼ ìš´ì„¸</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">${data.weekly_fortune.message}</div>
        </div>
        
        <!-- ì´ë²ˆ ë‹¬ ìš´ì„¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸŒŸ ì´ë²ˆ ë‹¬ ìš´ì„¸</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-left: 5px solid ${data.monthly_fortune.color}; border-radius: 12px; margin-bottom: 2rem;">
            <div style="font-size: 1.3em; font-weight: bold; color: ${data.monthly_fortune.color}; margin-bottom: 1rem;">${data.monthly_fortune.level}</div>
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">${data.monthly_fortune.message}</div>
        </div>
        
        <!-- ì˜¬í•´ì˜ ìš´ì„¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ’« ${data.current_year}ë…„ ìš´ì„¸</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; margin-bottom: 2rem;">
            <div style="font-size: 1.3em; font-weight: bold; color: #D4AF37; margin-bottom: 1rem;">ì˜¬í•´ì˜ í…Œë§ˆ: ${data.yearly_fortune.theme}</div>
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">${data.yearly_fortune.message}</div>
        </div>
        
        <!-- ë³„ìë¦¬ íŠ¹ì„± -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">âœ¨ ë³„ìë¦¬ íŠ¹ì„±</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ’ª ê°•ì </h4>
                ${data.constellation_info.detailed_traits.ê°•ì .map(s => `<div style="padding: 0.5rem; margin: 0.3rem 0; background: rgba(46,204,113,0.2); border-radius: 6px; color: #E2E8F0;">âœ“ ${s}</div>`).join('')}
            </div>
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">âš ï¸ ì•½ì </h4>
                ${data.constellation_info.detailed_traits.ì•½ì .map(w => `<div style="padding: 0.5rem; margin: 0.3rem 0; background: rgba(231,76,60,0.2); border-radius: 6px; color: #E2E8F0;">â–³ ${w}</div>`).join('')}
            </div>
        </div>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; line-height: 1.8; color: #E2E8F0; margin-bottom: 2rem;">
            <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ“ ì„±ê²© ì„¤ëª…</h4>
            ${data.constellation_info.detailed_traits.ì„±ê²©}
        </div>
        
        <!-- í–‰ìš´ì˜ ìš”ì†Œ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ€ í–‰ìš´ì˜ ìš”ì†Œ</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 12px; text-align: center;">
                <div style="color: #D4AF37; font-size: 0.9em; font-weight: 600; margin-bottom: 0.5rem;">ğŸ¨ í–‰ìš´ì˜ ìƒ‰ìƒ</div>
                <div style="color: #E2E8F0; font-size: 1.1em; font-weight: 600;">${data.lucky_elements.color}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 12px; text-align: center;">
                <div style="color: #D4AF37; font-size: 0.9em; font-weight: 600; margin-bottom: 0.5rem;">ğŸ”¢ í–‰ìš´ì˜ ìˆ«ì</div>
                <div style="color: #E2E8F0; font-size: 1.1em; font-weight: 600;">${data.lucky_elements.number}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 12px; text-align: center;">
                <div style="color: #D4AF37; font-size: 0.9em; font-weight: 600; margin-bottom: 0.5rem;">ğŸ“… í–‰ìš´ì˜ ìš”ì¼</div>
                <div style="color: #E2E8F0; font-size: 1.1em; font-weight: 600;">${data.lucky_elements.day}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 12px; text-align: center;">
                <div style="color: #D4AF37; font-size: 0.9em; font-weight: 600; margin-bottom: 0.5rem;">ğŸ§­ í–‰ìš´ì˜ ë°©í–¥</div>
                <div style="color: #E2E8F0; font-size: 1.1em; font-weight: 600;">${data.lucky_elements.direction}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 12px; text-align: center;">
                <div style="color: #D4AF37; font-size: 0.9em; font-weight: 600; margin-bottom: 0.5rem;">ğŸ’ í–‰ìš´ì˜ ë³´ì„</div>
                <div style="color: #E2E8F0; font-size: 1.1em; font-weight: 600;">${data.lucky_elements.stone}</div>
            </div>
        </div>
        
        <!-- ë³„ìë¦¬ ê¶í•© -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ’• ë³„ìë¦¬ ê¶í•©</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ’• ìµœê³ ì˜ ê¶í•©</h4>
                ${data.compatibility.best.map(s => `<div style="padding: 0.8rem; margin: 0.5rem 0; background: rgba(46,204,113,0.2); border-radius: 8px; text-align: center; color: #E2E8F0; font-weight: 600;">${s}</div>`).join('')}
            </div>
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ‘ ì¢‹ì€ ê¶í•©</h4>
                ${data.compatibility.good.map(s => `<div style="padding: 0.8rem; margin: 0.5rem 0; background: rgba(52,152,219,0.2); border-radius: 8px; text-align: center; color: #E2E8F0; font-weight: 600;">${s}</div>`).join('')}
            </div>
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">âš ï¸ ë„ì „ì ì¸ ê¶í•©</h4>
                ${data.compatibility.challenge.map(s => `<div style="padding: 0.8rem; margin: 0.5rem 0; background: rgba(231,76,60,0.2); border-radius: 8px; text-align: center; color: #E2E8F0; font-weight: 600;">${s}</div>`).join('')}
            </div>
        </div>
        
        <!-- ìƒí™œ ì˜ì—­ë³„ ìƒì„¸ ìš´ì„¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ¯ ìƒí™œ ì˜ì—­ë³„ ìƒì„¸ ìš´ì„¸</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ’¼ ì§ì—…/ì‚¬ì—… ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.career}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ’° ì¬ë¬¼/ê¸ˆì „ ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.wealth}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">â¤ï¸ ì—°ì• /ì¸ê°„ê´€ê³„ ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.love}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ¥ ê±´ê°• ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.health}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ“š í•™ìŠµ/êµìœ¡ ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.study}</div>
            </div>
            <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ìš´</h4>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.life_aspects.family}</div>
            </div>
        </div>
        
        <!-- ì¶”ì²œ ì§ì—… & ì·¨ë¯¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ’¼ ì¶”ì²œ ì§ì—… & ì·¨ë¯¸</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ’¼ ì¶”ì²œ ì§ì—…</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${data.career_hobby.careers.map(c => `<span style="padding: 0.5rem 1rem; background: rgba(212,175,55,0.2); border-radius: 8px; color: #E2E8F0; font-weight: 500;">${c}</span>`).join('')}
                </div>
            </div>
            <div>
                <h4 style="color: #D4AF37; margin-bottom: 0.5rem;">ğŸ¨ ì¶”ì²œ ì·¨ë¯¸</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${data.career_hobby.hobbies.map(h => `<span style="padding: 0.5rem 1rem; background: rgba(52,152,219,0.2); border-radius: 8px; color: #E2E8F0; font-weight: 500;">${h}</span>`).join('')}
                </div>
            </div>
        </div>
        
        <!-- ì—°ì•  ìŠ¤íƒ€ì¼ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">â¤ï¸ ì—°ì•  ìŠ¤íƒ€ì¼</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #D4AF37; font-size: 1.2em; font-weight: bold; margin-bottom: 1rem;">ì—°ì•  ìŠ¤íƒ€ì¼: ${data.love_style.style}</div>
            <div style="color: #E2E8F0; line-height: 1.8; margin-bottom: 1.5rem;">${data.love_style.approach}</div>
            <div style="padding-top: 1rem; border-top: 1px solid rgba(212,175,55,0.2);">
                <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">ì´ìƒí˜•</div>
                <div style="color: #E2E8F0; margin-bottom: 1rem;">${data.love_style.ideal_type}</div>
                <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">ì—°ì•  íŒ</div>
                <div style="color: #E2E8F0;">${data.love_style.tips}</div>
            </div>
        </div>
        
        <!-- ê±´ê°• ê´€ë¦¬ & ì£¼ì˜ì‚¬í•­ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ¥ ê±´ê°• ê´€ë¦¬ & ì£¼ì˜ì‚¬í•­</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; margin-bottom: 2rem;">
            <div style="margin-bottom: 1.5rem;">
                <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">ğŸ’ª ê±´ê°• ê°•ì </div>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.health_info.strengths}</div>
            </div>
            <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(212,175,55,0.2);">
                <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">âš ï¸ ì£¼ì˜í•  ë¶€ë¶„</div>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.health_info.weaknesses}</div>
            </div>
            <div style="padding-top: 1rem; border-top: 1px solid rgba(212,175,55,0.2);">
                <div style="color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem;">ğŸ’¡ ê±´ê°• ê´€ë¦¬ íŒ</div>
                <div style="color: #E2E8F0; line-height: 1.8;">${data.health_info.tips}</div>
            </div>
        </div>
        
        <!-- 12ê°œì›” ìš´ì„¸ ê°€ì´ë“œ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ“† 12ê°œì›” ìš´ì„¸ ê°€ì´ë“œ</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            ${data.monthly_detailed.map(f => `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-left: 4px solid ${f.color}; border-radius: 8px;">
                    <div style="color: ${f.color}; font-weight: bold; font-size: 1.1em; margin-bottom: 0.5rem;">${f.month}</div>
                    <div style="color: #D4AF37; font-size: 0.9em; margin-bottom: 0.5rem;">${f.level}</div>
                    <div style="color: #E2E8F0; font-size: 0.9em; line-height: 1.6;">${f.message}</div>
                </div>
            `).join('')}
        </div>
        
        <!-- ë³„ìë¦¬ë³„ ì¡°ì–¸ -->
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ’¡ ë³„ìë¦¬ë³„ ì¡°ì–¸</h3>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 12px; line-height: 1.8; color: #E2E8F0; font-size: 1.05em;">
            ${data.advice}
        </div>
    `;

        resultDiv.innerHTML = html;
    }

    // í¼ ì œì¶œ ì²˜ë¦¬ (tojeong.htmlê³¼ ë™ì¼)
    document.getElementById('input-form')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const errorDiv = document.getElementById('form-error');
        const submitBtn = this.querySelector('button[type="submit"]');

        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        }
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ì„¸ì…˜ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
                if (data.data && data.data.session_data) {
                    saveSessionDataToLocalStorage(data.data);
                } else {
                    // session_dataê°€ ì—†ìœ¼ë©´ FormDataì—ì„œ ì§ì ‘ ì €ì¥
                    const sessionData = {
                        user_name: formData.get('name') || '',
                        user_gender: formData.get('gender') || '',
                        birth_date: formData.get('birth_date') || '',
                        birth_time: formData.get('birth_time') || '',
                        is_lunar: formData.get('is_lunar') === 'on' || formData.get('is_lunar') === 'true',
                        _timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                    };
                    localStorage.setItem('user_session_data', JSON.stringify(sessionData));
                }

                // í¼ ê°’ì„ FormDataì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
                const form = document.getElementById('input-form');
                if (form) {
                    const nameInput = form.querySelector('[name="name"]');
                    const birthDateInput = form.querySelector('[name="birth_date"]');
                    const birthTimeInput = form.querySelector('[name="birth_time"]');
                    const genderSelect = form.querySelector('[name="gender"]');
                    const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

                    if (nameInput) nameInput.value = formData.get('name') || '';
                    if (birthDateInput) birthDateInput.value = formData.get('birth_date') || '';
                    if (birthTimeInput) birthTimeInput.value = formData.get('birth_time') || '';
                    if (genderSelect) genderSelect.value = formData.get('gender') || '';
                    if (isLunarCheckbox) {
                        const isLunarValue = formData.get('is_lunar');
                        isLunarCheckbox.checked = isLunarValue === 'on' || isLunarValue === 'true' || isLunarValue === true;
                    }
                }

                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }

                // ë³„ìë¦¬ìš´ì„¸ ìë™ ê³„ì‚° (FormDataì—ì„œ ì§ì ‘ ìƒë…„ì›”ì¼ê³¼ ì´ë¦„ ì „ë‹¬)
                const birthDate = formData.get('birth_date');
                const userName = formData.get('name');
                setTimeout(() => {
                    calculateByeoljari(birthDate, userName);
                }, 200);
            } else {
                if (errorDiv) {
                    errorDiv.textContent = data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            if (errorDiv) {
                errorDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    });

    // ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}