{% extends "base.html" %}

{% block sidebar %}
{% include "includes/sidebar_input.html" %}

<!-- Sidebar Banner -->
{{ sidebar_banner_html | safe }}
{% endblock %}

{% block content %}
<!-- ìš°ì¸¡: í† ì •ë¹„ê²° ê²°ê³¼ -->
<div class="result-container">
    <!-- ì»¨í…ì¸  ìƒë‹¨ ë°°ë„ˆ (ê²°ê³¼ ì˜ì—­ì—ë§Œ ìœ„ì¹˜) -->


    <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ (ê²°ê³¼ê°€ ì—†ì„ ë•Œë§Œ í‘œì‹œ) -->
    {% if not processed or not pillars_data %}
    <div id="tojeong-initial-message" class="glass-card" style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“œ</div>
        <h2 style="color: var(--gold-primary); margin-bottom: 1rem;">í† ì •ë¹„ê²°</h2>
        <p style="color: var(--text-muted); line-height: 1.8;">
            ì™¼ìª½ì—ì„œ ì„±í•¨ê³¼ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì‹œë©´ í† ì •ë¹„ê²°ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>

    <!-- SEO Rich Content (ì´ˆê¸° í™”ë©´ì—ë§Œ í‘œì‹œ, ê²°ê³¼ ë‚˜ì˜¤ë©´ ìˆ¨ê¹€) -->
    <div id="seo-rich-content" class="glass-card"
        style="margin-top: 2rem; padding: 2rem; border-top: 1px solid rgba(212, 175, 55, 0.2);">
        <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; font-size: 1.3rem;">ğŸ’¡ í† ì •ë¹„ê²°ê³¼ ì‚¬ì£¼íŒ”ì ê°€ì´ë“œ</h3>

        <div style="margin-bottom: 2rem;">
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                í† ì •ë¹„ê²°ì˜ ìœ ë˜</h4>
            <p style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem; text-align: justify;">
                í† ì •ë¹„ê²°(åœŸäº­ç§˜è¨£)ì€ ì¡°ì„  ì¤‘ê¸°ì˜ í•™ì í† ì •(åœŸäº­) ì´ì§€í•¨(æä¹‹è¡, 1517~1578) ì„ ìƒì´ ì €ìˆ í•œ ê²ƒìœ¼ë¡œ ì•Œë ¤ì§„ ë¹„ê²°ì„œ(ç§˜è¨£æ›¸)ì…ë‹ˆë‹¤.
                ì£¼ë¡œ í•œ í•´ì˜ ì‹ ìˆ˜ë¥¼ ë³´ëŠ”ë° ì‚¬ìš©ë˜ë©°, íƒœì–´ë‚œ ì—°, ì›”, ì¼ì˜ ì„¸ ê°€ì§€ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 144ê°€ì§€ì˜ ê´˜(å¦)ë¥¼ ë§Œë“¤ì–´ ì¼ ë…„ì˜ ê¸¸í‰í™”ë³µì„ ì ì¹˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
                ë‹¹ì‹œ ë°±ì„±ë“¤ì´ ì‚¶ì˜ ë¶ˆí™•ì‹¤ì„± ì†ì—ì„œ í¬ë§ì„ ì°¾ê³ ì í–ˆë˜ ë§ˆìŒì„ ë‹¬ë˜ì£¼ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡Œë‹¤ê³  ì „í•´ì§€ë©°,
                ë¯¼ê°„ì— ë„ë¦¬ ë³´ê¸‰ë˜ì–´ ì¡°ì„  í›„ê¸°ë¶€í„° í˜„ëŒ€ì— ì´ë¥´ê¸°ê¹Œì§€ í•œêµ­ì¸ë“¤ì˜ ëŒ€í‘œì ì¸ ìƒˆí•´ë§ì´ í’ì†ìœ¼ë¡œ ê¹Šì´ ìë¦¬ ì¡ì•˜ìŠµë‹ˆë‹¤.
            </p>
        </div>

        <div style="margin-bottom: 2rem;">
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                ì‚¬ì£¼íŒ”ì(å››æŸ±å…«å­—) ë³´ëŠ” ë²•</h4>
            <div style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem;">
                <p style="margin-bottom: 1rem; text-align: justify;">
                    ì‚¬ì£¼íŒ”ìëŠ” ì‚¬ëŒì´ íƒœì–´ë‚œ ì—°(å¹´), ì›”(æœˆ), ì¼(æ—¥), ì‹œ(æ™‚)ì˜ ë„¤ ê°€ì§€ ê¸°ë‘¥(å››æŸ±)ì„ ì˜ë¯¸í•˜ë©°,
                    ê° ê¸°ë‘¥ì€ ì²œê°„(å¤©å¹²)ê³¼ ì§€ì§€(åœ°æ”¯) ë‘ ê¸€ìë¡œ ì´ë£¨ì–´ì ¸ ì´ ì—¬ëŸ ê¸€ì(å…«å­—)ê°€ ë©ë‹ˆë‹¤.
                    ì´ ì—¬ëŸ ê¸€ìì˜ ìŒì–‘ì˜¤í–‰(í™”, ìˆ˜, ëª©, ê¸ˆ, í† )ì˜ ì¡°í™”ì™€ ìƒìƒ, ìƒê·¹ì„ ë¶„ì„í•˜ì—¬ ì¸ìƒì˜ ê¸¸í‰í™”ë³µì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
                </p>
                <ul
                    style="list-style: none; padding-left: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <li style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì—°ì£¼
                            (å¹´æŸ±)</strong>
                        ì¡°ìƒê³¼ ê°€ë¬¸ì„ ìƒì§•í•˜ë©°, ë‚˜ì˜ ë¿Œë¦¬ì™€ ì´ˆë…„ìš´ì„ ë´…ë‹ˆë‹¤.
                    </li>
                    <li style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì›”ì£¼
                            (æœˆæŸ±)</strong>
                        ë¶€ëª¨ì™€ í˜•ì œ, ì‚¬íšŒì  í™˜ê²½ì„ ìƒì§•í•˜ë©°, ì²­ë…„ìš´ì„ ë´…ë‹ˆë‹¤.
                    </li>
                    <li style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì¼ì£¼
                            (æ—¥æŸ±)</strong>
                        ë‚˜ ìì‹ ê³¼ ë°°ìš°ìë¥¼ ìƒì§•í•˜ë©°, ì¤‘ë…„ìš´ê³¼ ë³¸ì§ˆì  ì„±í–¥ì„ ë´…ë‹ˆë‹¤.
                    </li>
                    <li style="background: rgba(255, 255, 255, 0.03); padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--gold-secondary); display: block; margin-bottom: 0.4rem;">ì‹œì£¼
                            (æ™‚æŸ±)</strong>
                        ìë…€ì™€ ë§ë…„ì„ ìƒì§•í•˜ë©°, ë…¸ë…„ìš´ê³¼ ìˆ¨ê²¨ì§„ ë‚´ë©´ì„ ë´…ë‹ˆë‹¤.
                    </li>
                </ul>
            </div>
        </div>

        <div>
            <h4
                style="color: #E2E8F0; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); padding-left: 0.8rem;">
                ìš´ì„¸ë‹´ì˜ ë¶„ì„ ë°©ì‹</h4>
            <p style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem; text-align: justify;">
                ìš´ì„¸ë‹´ì€ ê³ ì „ í† ì •ë¹„ê²°ì˜ ì›ë¬¸ì„ í˜„ëŒ€ì ì¸ ì–¸ì–´ë¡œ ì¬í•´ì„í•˜ê³ , ì‚¬ì£¼ëª…ë¦¬í•™ì˜ ì •êµí•œ ë¶„ì„ ì´ë¡ ì„ ê²°í•©í•˜ì—¬ ë”ìš± ê¹Šì´ ìˆëŠ” ìš´ì„¸ í’€ì´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                ë‹¨ìˆœíˆ 'ì¢‹ë‹¤', 'ë‚˜ì˜ë‹¤' ì‹ì˜ ì´ë¶„ë²•ì  ê¸¸í‰ë§Œì„ ë…¼í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
                í˜„ì¬ ë‚˜ì˜ ê¸°ìš´ì´ ì–´ë–¤ íë¦„ ì†ì— ìˆëŠ”ì§€ ì •í™•íˆ ì´í•´í•˜ê³ , ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì£¼ì²´ì ìœ¼ë¡œ ì‚¶ì„ ì„¤ê³„í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì‹¤ì§ˆì ì¸ ì¡°ì–¸ì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- í† ì •ë¹„ê²° ì»¨í…Œì´ë„ˆ (í•­ìƒ ë Œë”ë§, ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div class="glass-card" id="tojeong-container"
        style="{% if not processed or not pillars_data %}display: none;{% endif %}">
        <div class="section-header" id="tojeong-title">
            <span>ğŸ“œ</span> <span id="user-name">{{ user_name or '' }}</span>ë‹˜ì˜ <span id="current-year">{{ current_year
                or '' }}</span>ë…„ í† ì •ë¹„ê²°
        </div>

        <!-- ë¡œë”© í‘œì‹œ -->
        <div id="tojeong-loading" style="text-align: center; padding: 2rem; display: none;">
            <div class="spinner"
                style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;">
            </div>
            <p style="margin-top: 1rem; color: var(--text-muted);">í† ì •ë¹„ê²°ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- í† ì •ë¹„ê²° ê²°ê³¼ ì˜ì—­ -->
        <div id="tojeong-result" style="display: none;">
            <!-- ê¸°ë³¸ ì •ë³´ (ê°„ì§€ ì •ë³´) -->
            <div id="tojeong-basic-info"
                style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>

            <!-- AI ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
            <div id="tojeong-ai-analysis" style="display: none;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>

            <!-- ê¸°ë³¸ ìš´ì„¸ í‘œì‹œ ì˜ì—­ -->
            <div id="tojeong-basic-fortune" style="display: none;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>

            <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ ì˜ì—­ -->
            {% include "includes/share_buttons.html" %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function () {
        console.log('í† ì •ë¹„ê²° í˜ì´ì§€ ë¡œë“œë¨');

        // ë‚˜ì´ ê³„ì‚° ë° í‘œì‹œ
        document.getElementById('birth_date')?.addEventListener('change', function () {
            const birthDate = this.value;
            if (birthDate) {
                const today = new Date();
                const birth = new Date(birthDate);
                const currentAge = today.getFullYear() - birth.getFullYear() -
                    ((today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) ? 1 : 0);
                const koreanAge = today.getFullYear() - birth.getFullYear() + 1;

                const ageInfo = document.getElementById('age-info');
                if (ageInfo) {
                    ageInfo.style.display = 'block';
                    ageInfo.textContent = `í˜„ì¬ ë‚˜ì´: ë§Œ ${currentAge}ì„¸ (í•œêµ­ë‚˜ì´ ${koreanAge}ì„¸)`;
                }
            }
        });

        // í¼ ì œì¶œ ì²˜ë¦¬ (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
        const inputForm = document.getElementById('input-form');
        if (inputForm) {
            console.log('í† ì •ë¹„ê²° input-form ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
            inputForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('í† ì •ë¹„ê²° í¼ ì œì¶œë¨');

                const formData = new FormData(this);
                const errorDiv = document.getElementById('form-error');
                const submitBtn = this.querySelector('button[type="submit"]');

                // ë¡œë”© ìƒíƒœ
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
                }
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }

                try {
                    const response = await fetch('/api/calculate', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // ì„¸ì…˜ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
                        if (data.data && data.data.session_data) {
                            saveSessionDataToLocalStorage(data.data);
                        } else {
                            // session_dataê°€ ì—†ìœ¼ë©´ FormDataì—ì„œ ì§ì ‘ ì €ì¥
                            const sessionData = {
                                user_name: formData.get('name') || '',
                                user_gender: formData.get('gender') || '',
                                birth_date: formData.get('birth_date') || '',
                                birth_time: formData.get('birth_time') || '',
                                is_lunar: formData.get('is_lunar') === 'on' || formData.get('is_lunar') === 'true',
                                _timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                            };
                            localStorage.setItem('user_session_data', JSON.stringify(sessionData));
                        }

                        // í¼ ê°’ì„ FormDataì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
                        const form = document.getElementById('input-form');
                        if (form) {
                            const nameInput = form.querySelector('[name="name"]');
                            const birthDateInput = form.querySelector('[name="birth_date"]');
                            const birthTimeInput = form.querySelector('[name="birth_time"]');
                            const genderSelect = form.querySelector('[name="gender"]');
                            const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

                            if (nameInput) nameInput.value = formData.get('name') || '';
                            if (birthDateInput) birthDateInput.value = formData.get('birth_date') || '';
                            if (birthTimeInput) birthTimeInput.value = formData.get('birth_time') || '';
                            if (genderSelect) genderSelect.value = formData.get('gender') || '';
                            if (isLunarCheckbox) {
                                const isLunarValue = formData.get('is_lunar');
                                isLunarCheckbox.checked = isLunarValue === 'on' || isLunarValue === 'true' || isLunarValue === true;
                            }
                        }

                        // ë²„íŠ¼ ìƒíƒœ ë³µì›
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                        }

                        // í† ì •ë¹„ê²° ìë™ ê³„ì‚° (ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ì „ë‹¬)
                        // í”Œë˜ê·¸ ë¦¬ì…‹ í›„ ê³„ì‚° ì‹œì‘
                        window.tojeongCalculating = false;
                        window.tojeongAIAnalyzing = false;
                        console.log('í† ì •ë¹„ê²° ê³„ì‚° ì‹œì‘:', { has_data: !!data.data, has_pillars_data: !!(data.data?.pillars_data) });
                        setTimeout(() => {
                            calculateTojeong(data.data);
                        }, 200);
                    } else {
                        // ì—ëŸ¬ í‘œì‹œ
                        if (errorDiv) {
                            errorDiv.textContent = data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            errorDiv.style.display = 'block';
                        }
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    if (errorDiv) {
                        errorDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        errorDiv.style.display = 'block';
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                    }
                }
            });
        } else {
            console.error('í† ì •ë¹„ê²° input-formì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }

        // API Key ìë™ ì €ì¥ (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
        let apiKeyDebounceTimer;
        const apiKeyInput = document.getElementById('api-key-input');
        if (apiKeyInput) {
            apiKeyInput.addEventListener('input', function () {
                clearTimeout(apiKeyDebounceTimer);
                const apiKey = this.value.trim();
                const statusDiv = document.getElementById('api-key-status');

                // API KeyëŠ” ì €ì¥í•˜ì§€ ì•Šê³  ì…ë ¥ê°’ë§Œ ì‚¬ìš©
                apiKeyDebounceTimer = setTimeout(() => {
                    if (apiKey) {
                        if (statusDiv) {
                            statusDiv.textContent = 'âœ… API Keyê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. AI ë¶„ì„ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...';
                            statusDiv.style.color = '#86EFAC';
                            statusDiv.style.display = 'block';
                        }

                        // API Key ì…ë ¥ í›„, í† ì •ë¹„ê²° ê²°ê³¼ê°€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ AI ë¶„ì„ ìë™ ì‹¤í–‰
                        const tojeongResultDiv = document.getElementById('tojeong-result');
                        const tojeongBasicInfoDiv = document.getElementById('tojeong-basic-info');
                        const aiAnalysisDiv = document.getElementById('tojeong-ai-analysis');

                        if (tojeongResultDiv && tojeongResultDiv.style.display !== 'none' &&
                            tojeongBasicInfoDiv && tojeongBasicInfoDiv.innerHTML.trim() !== '' &&
                            aiAnalysisDiv && window.lastTojeongData) {
                            // API Keyê°€ ì…ë ¥ë˜ë©´ ìë™ìœ¼ë¡œ AI ë¶„ì„ ì‹œì‘
                            setTimeout(() => {
                                aiAnalysisDiv.style.display = 'block';
                                aiAnalysisDiv.innerHTML = `
                                <div style="text-align: center; padding: 2rem;">
                                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <p style="margin-top: 1rem; color: var(--text-muted);">í† ì •ë¹„ê²°ì„ ìƒì„¸í•˜ê²Œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 10-15ì´ˆ ì†Œìš”)</p>
                                </div>
                            `;
                                runTojeongAIAnalysis();
                            }, 500);
                        }
                    } else {
                        if (statusDiv) {
                            statusDiv.style.display = 'none';
                        }
                    }
                }, 1000);
            });
        }

        // localStorageì—ì„œ ì½ì–´ì™€ì„œ í¼ì— ì±„ìš°ê¸° (ì„¸ì…˜ ê°’ë³´ë‹¤ ìš°ì„ )
        fillFormFromLocalStorage('input-form');

        // í¼ì— ê°’ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ (ì„¸ì…˜ ë°ì´í„° ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ)
        // setTimeoutì„ ì‚¬ìš©í•˜ì—¬ fillFormFromLocalStorage ì™„ë£Œ í›„ ì‹¤í–‰ ë³´ì¥
        setTimeout(() => {
            const form = document.getElementById('input-form');
            if (form) {
                const nameInput = form.querySelector('[name="name"]');
                const birthDateInput = form.querySelector('[name="birth_date"]');
                const genderSelect = form.querySelector('[name="gender"]');

                // í¼ì— í•„ìˆ˜ ê°’ì´ ìˆìœ¼ë©´ ìë™ ë¡œë“œ
                if (nameInput?.value && birthDateInput?.value && genderSelect?.value) {
                    console.log('í† ì •ë¹„ê²° ìë™ ë¡œë“œ ì‹œì‘');
                    autoLoadTojeong();
                }
            }
        }, 100);
    });

    // ì„¸ì…˜ ë°ì´í„°ë¡œ ìë™ í† ì •ë¹„ê²° ë¡œë“œ
    async function autoLoadTojeong() {
        // ì´ë¯¸ ë¡œë“œ ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        if (window.tojeongAutoLoading) {
            console.log('í† ì •ë¹„ê²° ìë™ ë¡œë“œê°€ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }

        window.tojeongAutoLoading = true;

        // í¼ì—ì„œ ì§ì ‘ ê°’ì„ ì½ì–´ì™€ì„œ ì‚¬ìš© (localStorageì—ì„œ ì±„ì›Œì§„ ìµœì‹  ê°’)
        const form = document.getElementById('input-form');
        if (!form) {
            window.tojeongAutoLoading = false;
            return;
        }

        const nameInput = form.querySelector('[name="name"]');
        const birthDateInput = form.querySelector('[name="birth_date"]');
        const birthTimeInput = form.querySelector('[name="birth_time"]');
        const genderSelect = form.querySelector('[name="gender"]');
        const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

        // í¼ ê°’ì´ ì—†ìœ¼ë©´ ìë™ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        if (!nameInput?.value || !birthDateInput?.value || !genderSelect?.value) {
            window.tojeongAutoLoading = false;
            return;
        }

        // ë¨¼ì € ì‚¬ì£¼ ê³„ì‚° APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const formData = new FormData();
        formData.append('name', nameInput.value);
        formData.append('birth_date', birthDateInput.value);
        formData.append('birth_time', birthTimeInput.value || '');
        formData.append('gender', genderSelect.value);
        if (isLunarCheckbox?.checked) {
            formData.append('is_lunar', 'true');
        }

        try {
            // ì‚¬ì£¼ ê³„ì‚° ë¨¼ì € ìˆ˜í–‰
            const calculateResponse = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const calculateData = await calculateResponse.json();

            if (calculateResponse.ok && calculateData.success) {
                // ê³„ì‚°ëœ ë°ì´í„°ë¡œ í† ì •ë¹„ê²° ê³„ì‚°
                calculateTojeong(calculateData.data);
            } else {
                // ì‚¬ì£¼ ê³„ì‚° ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í‘œì‹œ
                console.error('ì‚¬ì£¼ ê³„ì‚° ì‹¤íŒ¨:', calculateData);
                window.tojeongAutoLoading = false;
            }
            window.tojeongAutoLoading = false;
        } catch (error) {
            console.error('ìë™ í† ì •ë¹„ê²° ë¡œë“œ ì˜¤ë¥˜:', error);
            window.tojeongAutoLoading = false;
        }
    }

    // í† ì •ë¹„ê²° ê³„ì‚° (ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ë°›ì•„ì„œ ì‚¬ìš©)
    async function calculateTojeong(calculatedData = null) {
        console.log('calculateTojeong í•¨ìˆ˜ ì‹œì‘:', { has_calculatedData: !!calculatedData });

        // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        const initialMessage = document.getElementById('tojeong-initial-message');
        if (initialMessage) {
            initialMessage.style.display = 'none';
        }

        // SEO ì»¨í…ì¸  ìˆ¨ê¸°ê¸° (ê²°ê³¼ ë‚˜ì˜¤ë©´ ì‚¬ë¼ì§)
        const seoRichContent = document.getElementById('seo-rich-content');
        if (seoRichContent) {
            seoRichContent.style.display = 'none';
        }

        // ì»¨í…Œì´ë„ˆ í‘œì‹œ
        const container = document.getElementById('tojeong-container');
        if (container) {
            container.style.display = 'block';
        }

        const loadingDiv = document.getElementById('tojeong-loading');
        const resultDiv = document.getElementById('tojeong-result');

        console.log('í† ì •ë¹„ê²° DOM ìš”ì†Œ í™•ì¸:', {
            has_loadingDiv: !!loadingDiv,
            has_resultDiv: !!resultDiv,
            has_container: !!container,
            has_initialMessage: !!initialMessage
        });

        if (!loadingDiv || !resultDiv) {
            console.error('í† ì •ë¹„ê²°: loadingDiv ë˜ëŠ” resultDivë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }

        // ê³„ì‚°ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
        if (!calculatedData || !calculatedData.pillars_data || !calculatedData.pillars_info) {
            console.error('í† ì •ë¹„ê²° ê³„ì‚°: ê³„ì‚°ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', {
                has_calculatedData: !!calculatedData,
                has_pillars_data: !!(calculatedData?.pillars_data),
                has_pillars_info: !!(calculatedData?.pillars_info)
            });
            loadingDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ì‚¬ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‚¬ì£¼ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.</div>`;
            return;
        }

        // ì´ë¯¸ ê³„ì‚° ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        if (window.tojeongCalculating) {
            console.log('í† ì •ë¹„ê²° ê³„ì‚°ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }

        window.tojeongCalculating = true;
        console.log('í† ì •ë¹„ê²° ê³„ì‚° ì‹œì‘ - í”Œë˜ê·¸ ì„¤ì •ë¨');

        // ë¡œë”© í‘œì‹œ
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        console.log('í† ì •ë¹„ê²° ë¡œë”© í‘œì‹œ ì™„ë£Œ');

        try {
            // ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ì „ë‹¬
            // calculatedDataëŠ” /api/calculateì˜ ì‘ë‹µ data.dataì´ë¯€ë¡œ pillars_dataì™€ pillars_infoê°€ í¬í•¨ë˜ì–´ ìˆìŒ
            const requestBody = {
                calculated_data: {
                    pillars_data: calculatedData.pillars_data,
                    pillars_info: calculatedData.pillars_info
                }
            };

            // ë””ë²„ê¹…: ì „ë‹¬ë˜ëŠ” ë°ì´í„° í™•ì¸
            if (calculatedData) {
                console.log('í† ì •ë¹„ê²° ê³„ì‚° - calculatedData ì „ë‹¬:', {
                    has_pillars_data: !!calculatedData.pillars_data,
                    has_pillars_info: !!calculatedData.pillars_info,
                    pillars_data_length: calculatedData.pillars_data?.length || 0,
                    birth_datetime: calculatedData.pillars_info?.birth_datetime
                });
            }

            console.log('í† ì •ë¹„ê²° API í˜¸ì¶œ ì‹œì‘:', {
                url: '/api/tojeong',
                has_requestBody: !!requestBody,
                has_calculated_data: !!(requestBody.calculated_data)
            });

            const response = await fetch('/api/tojeong', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(requestBody)
            });

            console.log('í† ì •ë¹„ê²° API ì‘ë‹µ ë°›ìŒ:', {
                status: response.status,
                ok: response.ok,
                statusText: response.statusText
            });

            // Content-Type í™•ì¸
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('í† ì •ë¹„ê²° API ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤:', { contentType, text: text.substring(0, 200) });
                throw new Error('ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }

            const data = await response.json();
            console.log('í† ì •ë¹„ê²° API ì‘ë‹µ ë°ì´í„°:', {
                success: data.success,
                has_data: !!data.data,
                has_tojeong_result: !!(data.data?.tojeong_result),
                detail: data.detail
            });

            if (response.ok && data.success) {
                // ë””ë²„ê¹…: ë°›ì€ ê²°ê³¼ í™•ì¸
                console.log('í† ì •ë¹„ê²° ê³„ì‚° ì™„ë£Œ:', {
                    has_tojeong_result: !!data.data.tojeong_result,
                    current_year: data.data.current_year,
                    fortune_level: data.data.tojeong_result?.fortune_level,
                    relationship: data.data.tojeong_result?.relationship
                });

                console.log('í† ì •ë¹„ê²° ê²°ê³¼ ë Œë”ë§ ì‹œì‘');
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                console.log('renderTojeongResult í˜¸ì¶œ:', {
                    has_tojeong_result: !!data.data.tojeong_result,
                    current_year: data.data.current_year
                });
                renderTojeongResult(data.data.tojeong_result, data.data.current_year);
                console.log('renderTojeongResult ì™„ë£Œ');

                // ê¸°ë³¸ ìš´ì„¸ í‘œì‹œ (AI ë¶„ì„ ì „ì— ë¨¼ì € í‘œì‹œ)
                const basicFortuneDiv = document.getElementById('tojeong-basic-fortune');
                if (basicFortuneDiv) {
                    basicFortuneDiv.style.display = 'block';
                }

                // í† ì •ë¹„ê²° ê²°ê³¼ì™€ ì‚¬ì£¼ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (AI ë¶„ì„ ì‹œ ì‚¬ìš©)
                window.lastTojeongData = {
                    tojeong_result: data.data.tojeong_result,
                    pillars_data: calculatedData.pillars_data,
                    pillars_info: calculatedData.pillars_info
                };

                // AI ë¶„ì„ì€ ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•  ë•Œë§Œ ì‹¤í–‰
                // API Key í™•ì¸ í›„ ë²„íŠ¼ í‘œì‹œ
                const aiAnalysisDiv = document.getElementById('tojeong-ai-analysis');

                // API Key í™•ì¸ - ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
                const apiKeyInput = document.getElementById('api-key-input');
                const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
                if (aiAnalysisDiv) {
                    if (currentApiKey) {
                        // API Keyê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ AI ë¶„ì„ ì‹œì‘
                        aiAnalysisDiv.style.display = 'block';
                        aiAnalysisDiv.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 1rem; color: var(--text-muted);">í† ì •ë¹„ê²°ì„ ìƒì„¸í•˜ê²Œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 10-15ì´ˆ ì†Œìš”)</p>
                        </div>
                    `;

                        // ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë³€ê²½í–ˆìœ¼ë¯€ë¡œ ìë™ìœ¼ë¡œ AI ë¶„ì„ ì‹œì‘
                        setTimeout(() => {
                            runTojeongAIAnalysis();
                        }, 500);
                    } else {
                        // API Keyê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í† ì •ë¹„ê²° ë¶„ì„ ê²°ê³¼ë¥¼ AI ë¶„ì„ ì„¹ì…˜ì— í‘œì‹œ
                        aiAnalysisDiv.style.display = 'block';
                        if (window.lastTojeongData && window.lastTojeongData.tojeong_result) {
                            aiAnalysisDiv.innerHTML = generateBasicTojeongAnalysis(
                                window.lastTojeongData.tojeong_result,
                                data.data.current_year || new Date().getFullYear()
                            );
                        } else {
                            aiAnalysisDiv.innerHTML = '';
                        }
                    }
                }

                window.tojeongCalculating = false;
            } else {
                loadingDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ${data.detail || 'í† ì •ë¹„ê²° ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`;
                window.tojeongCalculating = false;
            }
        } catch (error) {
            console.error('Tojeong Calculation Error:', error);
            loadingDiv.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
            window.tojeongCalculating = false;
        }
    }

    // í† ì •ë¹„ê²° ê²°ê³¼ ë Œë”ë§
    function renderTojeongResult(tojeongResult, currentYear) {
        console.log('renderTojeongResult í•¨ìˆ˜ ì‹œì‘:', {
            has_tojeongResult: !!tojeongResult,
            currentYear: currentYear
        });

        const basicInfoDiv = document.getElementById('tojeong-basic-info');
        const basicFortuneDiv = document.getElementById('tojeong-basic-fortune');

        console.log('í† ì •ë¹„ê²° DOM ìš”ì†Œ í™•ì¸:', {
            has_basicInfoDiv: !!basicInfoDiv,
            has_basicFortuneDiv: !!basicFortuneDiv
        });

        // ì •ë³´ì…ë ¥ë€ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  ê°’)
        const nameInput = document.getElementById('name');
        const userName = nameInput?.value || '';

        // ì˜¬í•´ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
        const displayYear = currentYear || new Date().getFullYear();

        // ìƒë‹¨ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        const titleDiv = document.getElementById('tojeong-title');
        if (titleDiv) {
            const userNameSpan = titleDiv.querySelector('#user-name');
            const currentYearSpan = titleDiv.querySelector('#current-year');
            if (userNameSpan && userName) userNameSpan.textContent = userName;
            if (currentYearSpan) currentYearSpan.textContent = displayYear;
        }

        // ë””ë²„ê¹…: ë Œë”ë§ë˜ëŠ” ê²°ê³¼ í™•ì¸
        console.log('í† ì •ë¹„ê²° ê²°ê³¼ ë Œë”ë§:', {
            birth_year_ganji: tojeongResult.birth_year_ganji,
            current_year_ganji: tojeongResult.current_year_ganji,
            relationship: tojeongResult.relationship,
            fortune_level: tojeongResult.fortune_level,
            currentYear: displayYear,
            userName: userName
        });

        if (!basicInfoDiv || !basicFortuneDiv) {
            console.error('í† ì •ë¹„ê²° ê²°ê³¼ ë Œë”ë§ ì‹¤íŒ¨: DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ê¸°ë³¸ ì •ë³´ (ê°„ì§€ ì •ë³´)
        basicInfoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <div>
                <div style="color: #A0AEC0; font-size: 0.9em; margin-bottom: 0.5rem;">ìƒë…„ ê°„ì§€</div>
                <div style="font-size: 1.5em; font-weight: bold; color: #D4AF37;">${tojeongResult.birth_year_ganji || ''}</div>
            </div>
            <div style="text-align: right;">
                <div style="color: #A0AEC0; font-size: 0.9em; margin-bottom: 0.5rem;">${currentYear}ë…„ ê°„ì§€</div>
                <div style="font-size: 1.5em; font-weight: bold; color: #D4AF37;">${tojeongResult.current_year_ganji || ''}</div>
            </div>
        </div>
        <div style="padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="color: #A0AEC0; font-size: 0.9em; margin-bottom: 0.5rem;">ê´€ê³„</div>
            <div style="font-size: 1.2em; font-weight: bold; color: #F9E79F;">${tojeongResult.relationship || ''}</div>
            <div style="color: #A0AEC0; font-size: 0.85em; margin-top: 0.3rem;">${tojeongResult.relationship_desc || ''}</div>
        </div>
    `;

        // ê¸°ë³¸ ìš´ì„¸ í‘œì‹œ (AI ë¶„ì„ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ)
        const fortuneColor = {
            "ì¢‹ìŒ": "#2ecc71",
            "ì–‘í˜¸": "#3498db",
            "ë³´í†µ": "#f1c40f",
            "ì£¼ì˜": "#e74c3c"
        }[tojeongResult.fortune_level] || "#f1c40f";

        // ê¸°ë³¸ ìš´ì„¸ë¥¼ ë” í’ë¶€í•˜ê²Œ í‘œì‹œ
        basicFortuneDiv.innerHTML = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-left: 4px solid ${fortuneColor}; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="color: #A0AEC0; font-size: 0.9em; margin-bottom: 0.5rem;">ì˜¬í•´ ìš´ì„¸</div>
            <div style="font-size: 1.3em; font-weight: bold; color: ${fortuneColor}; margin-bottom: 1rem;">${tojeongResult.fortune_level || ''}</div>
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em; margin-bottom: 1rem;">${tojeongResult.fortune_message || ''}</div>
            ${getRelationshipDetail(tojeongResult.relationship)}
        </div>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="color: #D4AF37; font-size: 1.1em; font-weight: bold; margin-bottom: 0.8rem;">ì›”ë³„ ê°€ì´ë“œ</div>
            <div style="color: #C0C8D0; line-height: 1.8;">${tojeongResult.monthly_guidance || ''}</div>
        </div>
        ${getYearlyGuidance(tojeongResult.relationship, tojeongResult.fortune_level)}
    `;

        // AI ë¶„ì„ ì„¹ì…˜ì—ë„ ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ (API Keyê°€ ì—†ì„ ë•Œ)
        const aiAnalysisDiv = document.getElementById('tojeong-ai-analysis');
        if (aiAnalysisDiv) {
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!currentApiKey) {
                aiAnalysisDiv.style.display = 'block';
                aiAnalysisDiv.innerHTML = generateBasicTojeongAnalysis(tojeongResult, currentYear);
            }
        }

        // ê³µìœ  ë°ì´í„° ì„¤ì •
        const shareTitle = `${currentYear}ë…„ í† ì •ë¹„ê²° ê²°ê³¼ - ìš´ì„¸ë‹´`;
        const shareDesc = `${userName}ë‹˜ì˜ ${currentYear}ë…„ í† ì •ë¹„ê²° ê²°ê³¼ì…ë‹ˆë‹¤. ê´€ê³„: ${tojeongResult.relationship}, ìš´ì„¸: ${tojeongResult.fortune_level}`;

        window.currentShareData = {
            title: shareTitle,
            description: shareDesc,
            url: window.location.href, // ê³µìœ  ì‹œ í˜„ì¬ í˜ì´ì§€ë¡œ ì´ë™
            text: `${shareTitle}\n${shareDesc}\n\nì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!`
        };
    }

    // ê´€ê³„ë³„ ìƒì„¸ ì„¤ëª… ìƒì„±
    function getRelationshipDetail(relationship) {
        const relationshipDetails = {
            "ì‚¼í•©": {
                desc: "ìƒë…„ ì§€ì§€ì™€ ì˜¬í•´ ì§€ì§€ê°€ ì‚¼í•© ê´€ê³„ì…ë‹ˆë‹¤. ì‚¼í•©ì€ ì¸ì—°, í˜‘ë ¥, ì¡°í™”ë¥¼ ì˜ë¯¸í•˜ëŠ” ì¢‹ì€ ê´€ê³„ì…ë‹ˆë‹¤.",
                color: "#2ecc71"
            },
            "ìœ¡í•©": {
                desc: "ìƒë…„ ì§€ì§€ì™€ ì˜¬í•´ ì§€ì§€ê°€ ìœ¡í•© ê´€ê³„ì…ë‹ˆë‹¤. ìœ¡í•©ì€ ì™„ë²½í•œ ì¡°í™”ì™€ í˜‘ë ¥ì„ ì˜ë¯¸í•˜ëŠ” ë§¤ìš° ì¢‹ì€ ê´€ê³„ì…ë‹ˆë‹¤.",
                color: "#3498db"
            },
            "ì¶©": {
                desc: "ìƒë…„ ì§€ì§€ì™€ ì˜¬í•´ ì§€ì§€ê°€ ì¶© ê´€ê³„ì…ë‹ˆë‹¤. ì¶©ì€ ë³€í™”ì™€ ë³€ë™ì„ ì˜ë¯¸í•˜ë¯€ë¡œ ì‹ ì¤‘í•œ íŒë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                color: "#e74c3c"
            },
            "í˜•": {
                desc: "ìƒë…„ ì§€ì§€ì™€ ì˜¬í•´ ì§€ì§€ê°€ í˜• ê´€ê³„ì…ë‹ˆë‹¤. í˜•ì€ ì•½ê°„ì˜ ì–´ë ¤ì›€ì´ë‚˜ ê²½ìŸì„ ì˜ë¯¸í•˜ë¯€ë¡œ ì¸ë‚´ì™€ ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                color: "#f1c40f"
            },
            "í‰ìƒ": {
                desc: "ìƒë…„ ì§€ì§€ì™€ ì˜¬í•´ ì§€ì§€ê°€ í‰ìƒ ê´€ê³„ì…ë‹ˆë‹¤. íŠ¹ë³„í•œ ë³€í™” ì—†ì´ ì•ˆì •ì ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.",
                color: "#95a5a6"
            }
        };

        const detail = relationshipDetails[relationship] || relationshipDetails["í‰ìƒ"];
        return `
        <div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 6px; margin-top: 1rem;">
            <div style="color: ${detail.color}; font-weight: bold; margin-bottom: 0.5rem;">${relationship} ê´€ê³„ ìƒì„¸</div>
            <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${detail.desc}</div>
        </div>
    `;
    }

    // ì—°ê°„ ê°€ì´ë“œ ìƒì„±
    function getYearlyGuidance(relationship, fortuneLevel) {
        let guidance = '';

        if (fortuneLevel === "ì¢‹ìŒ" || fortuneLevel === "ì–‘í˜¸") {
            guidance = `
            <div style="padding: 1.5rem; background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #2ecc71; font-size: 1.1em; font-weight: bold; margin-bottom: 0.8rem;">âœ¨ ì˜¬í•´ì˜ ê¸°íšŒ</div>
                <div style="color: #E2E8F0; line-height: 1.8;">
                    <p style="margin-bottom: 0.5rem;">â€¢ ìƒˆë¡œìš´ ë„ì „ê³¼ ëª©í‘œ ì„¤ì •ì— ìœ ë¦¬í•œ ì‹œê¸°ì…ë‹ˆë‹¤.</p>
                    <p style="margin-bottom: 0.5rem;">â€¢ ì¸ì—°ê³¼ í˜‘ë ¥ ê´€ê³„ê°€ ì¢‹ì•„ì§€ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.</p>
                    <p>â€¢ ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ê¸°ì— ì í•©í•œ ì‹œê¸°ì…ë‹ˆë‹¤.</p>
                </div>
            </div>
        `;
        } else if (fortuneLevel === "ì£¼ì˜") {
            guidance = `
            <div style="padding: 1.5rem; background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #e74c3c; font-size: 1.1em; font-weight: bold; margin-bottom: 0.8rem;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
                <div style="color: #E2E8F0; line-height: 1.8;">
                    <p style="margin-bottom: 0.5rem;">â€¢ ì¤‘ìš”í•œ ê²°ì •ì€ ì‹ ì¤‘í•˜ê²Œ ê²€í†  í›„ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <p style="margin-bottom: 0.5rem;">â€¢ ê¸‰í•˜ê²Œ ì„œë‘ë¥´ì§€ ë§ê³  ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <p>â€¢ ê±´ê°•ê³¼ ì•ˆì „ì— íŠ¹íˆ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ì„¸ìš”.</p>
                </div>
            </div>
        `;
        } else {
            guidance = `
            <div style="padding: 1.5rem; background: rgba(241, 196, 15, 0.1); border-left: 4px solid #f1c40f; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #f1c40f; font-size: 1.1em; font-weight: bold; margin-bottom: 0.8rem;">ğŸ’¡ ì˜¬í•´ì˜ ì¡°ì–¸</div>
                <div style="color: #E2E8F0; line-height: 1.8;">
                    <p style="margin-bottom: 0.5rem;">â€¢ ê¾¸ì¤€í•œ ë…¸ë ¥ê³¼ ê³„íšì„ í†µí•´ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì„¸ìš”.</p>
                    <p style="margin-bottom: 0.5rem;">â€¢ ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <p>â€¢ ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì„ ìœ ì§€í•˜ì„¸ìš”.</p>
                </div>
            </div>
        `;
        }

        return guidance;
    }

    // ì ìˆ˜ ë°” ì‹œê°í™” í•¨ìˆ˜ (10ì  ë§Œì )
    function renderScoreBar(label, score, maxScore = 10) {
        const percentage = (score / maxScore) * 100;
        const color = score >= 8 ? '#2ecc71' : score >= 6 ? '#3498db' : score >= 4 ? '#f1c40f' : '#e74c3c';

        return `
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-primary); font-weight: 500;">${label}</span>
                <span style="color: ${color}; font-weight: bold; font-size: 1.1em;">${score}ì </span>
            </div>
            <div style="width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.3s ease;"></div>
            </div>
        </div>
    `;
    }

    // ê¸°ë³¸ í† ì •ë¹„ê²° ë¶„ì„ ê²°ê³¼ ìƒì„± (API Keyê°€ ì—†ì„ ë•Œ AI ë¶„ì„ ì„¹ì…˜ì— í‘œì‹œ)
    function generateBasicTojeongAnalysis(tojeongResult, currentYear) {
        const fortuneColor = {
            "ì¢‹ìŒ": "#2ecc71",
            "ì–‘í˜¸": "#3498db",
            "ë³´í†µ": "#f1c40f",
            "ì£¼ì˜": "#e74c3c"
        }[tojeongResult.fortune_level] || "#f1c40f";

        // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
        let basicInfoHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-left: 4px solid ${fortuneColor}; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“œ ${currentYear}ë…„ í† ì •ë¹„ê²° ë¶„ì„</h3>
            <div style="line-height: 1.8; color: var(--text-primary);">
                <p style="margin-bottom: 0.8rem;"><strong>ìƒë…„ ê°„ì§€:</strong> ${tojeongResult.birth_year_ganji || ''}</p>
                <p style="margin-bottom: 0.8rem;"><strong>${currentYear}ë…„ ê°„ì§€:</strong> ${tojeongResult.current_year_ganji || ''}</p>
                <p style="margin-bottom: 0.8rem;"><strong>ê´€ê³„:</strong> <span style="color: ${fortuneColor}; font-weight: bold;">${tojeongResult.relationship || ''}</span></p>
                <p style="margin-bottom: 0.8rem;"><strong>ì˜¬í•´ ìš´ì„¸:</strong> <span style="color: ${fortuneColor}; font-weight: bold;">${tojeongResult.fortune_level || ''}</span></p>
                <p style="margin-top: 1rem;">${tojeongResult.relationship_desc || ''}</p>
            </div>
        </div>
    `;

        // ìƒë‹¨ ìš”ì•½ ì¹´ë“œ: ì ìˆ˜ ì‹œê°í™”
        let summaryCardHtml = '';
        if (tojeongResult.fortune_scores) {
            const scores = tojeongResult.fortune_scores;
            summaryCardHtml = `
            <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%); border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; text-align: center;">âœ¨ ì˜¬í•´ ìš´ì„¸ ì§€ìˆ˜ (10ì  ë§Œì )</h3>
                ${renderScoreBar('ì¢…í•©ìš´', scores.overall || 6)}
                ${renderScoreBar('ì¬ë¬¼ìš´', scores.wealth || 6)}
                ${renderScoreBar('ì—°ì• Â·ì¸ê°„ê´€ê³„', scores.love || 6)}
                ${renderScoreBar('ê±´ê°•ìš´', scores.health || 6)}
                ${renderScoreBar('ì§ì¥Â·ì‚¬ì—…ìš´', scores.career || 6)}
            </div>
        `;
        }

        // í‚¤ì›Œë“œ ì„¹ì…˜
        let keywordsHtml = '';
        if (tojeongResult.keywords && tojeongResult.keywords.length > 0) {
            const keywordColors = ['#3498db', '#2ecc71', '#f1c40f'];
            keywordsHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ·ï¸ ì˜¬í•´ì˜ í‚¤ì›Œë“œ</h4>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    ${tojeongResult.keywords.map((keyword, idx) => `
                        <span style="padding: 0.5rem 1rem; background: ${keywordColors[idx % keywordColors.length]}; color: white; border-radius: 20px; font-weight: bold; font-size: 0.95em;">${keyword}</span>
                    `).join('')}
                </div>
            </div>
        `;
        }

        // ì—°ìš´(å¹´é‹) ìƒì„¸ ì„¹ì…˜
        let yearlyFortuneHtml = '';
        if (tojeongResult.yearly_fortune) {
            const yf = tojeongResult.yearly_fortune;
            yearlyFortuneHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“– ì—°ìš´(å¹´é‹) ìƒì„¸</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary);">ì „í†µì  ì˜ë¯¸:</strong>
                        <p style="margin-top: 0.5rem;">${yf.traditional || ''}</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary);">í•´ì„ í¬ì¸íŠ¸:</strong>
                        <p style="margin-top: 0.5rem;">${yf.interpretation || ''}</p>
                    </div>
                    <div style="padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary);">í˜„ì‹¤ ì¡°ì–¸:</strong>
                        <p style="margin-top: 0.5rem;">${yf.advice || ''}</p>
                    </div>
                </div>
            </div>
        `;
        } else {
            // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
            yearlyFortuneHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ì˜¬í•´ ìš´ì„¸ í•´ì„</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>${tojeongResult.fortune_message || ''}</p>
                    ${getRelationshipDetail(tojeongResult.relationship)}
                </div>
            </div>
        `;
        }

        // ì›”ë³„ ìš´ì„¸ ê·¸ë¦¬ë“œ
        let monthlyFortunesHtml = '';
        if (tojeongResult.monthly_fortunes && tojeongResult.monthly_fortunes.length > 0) {
            const monthNames = ['', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            monthlyFortunesHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1.5rem;">ğŸ“… ì›”ë³„ ìš´ì„¸ (1~12ì›”)</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    ${tojeongResult.monthly_fortunes.map(month => {
                const bgColor = month.good_period ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)';
                const borderColor = month.good_period ? '#2ecc71' : '#e74c3c';
                const icon = month.good_period ? 'âœ…' : 'âš ï¸';
                return `
                            <div style="padding: 1rem; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 6px;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold; color: var(--gold-primary); margin-right: 0.5rem;">${monthNames[month.month]}</span>
                                    <span style="font-size: 1.2em;">${icon}</span>
                                </div>
                                <p style="color: var(--text-primary); font-size: 0.9em; margin-bottom: 0.8rem; line-height: 1.6;">${month.summary || ''}</p>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    ${(month.themes || []).map(theme => `
                                        <span style="padding: 0.25rem 0.5rem; background: rgba(212,175,55,0.2); color: var(--text-primary); border-radius: 12px; font-size: 0.8em;">#${theme}</span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            </div>
        `;
        } else {
            // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
            monthlyFortunesHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ì›”ë³„ ê°€ì´ë“œ</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <p>${tojeongResult.monthly_guidance || ''}</p>
                </div>
            </div>
        `;
        }

        // ì¬í…Œí¬/ì»¤ë¦¬ì–´ íŠ¹í™” ì¡°ì–¸ ì„¹ì…˜
        let careerAdviceHtml = '';
        if (tojeongResult.career_advice) {
            const ca = tojeongResult.career_advice;
            careerAdviceHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’¼ ì¬í…Œí¬Â·ì»¤ë¦¬ì–´ íŠ¹í™” ì¡°ì–¸</h4>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ’° ì¬í…Œí¬:</strong>
                        <p>${ca.investment || ''}</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ‘” ì»¤ë¦¬ì–´:</strong>
                        <p>${ca.career || ''}</p>
                    </div>
                    <div style="padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                        <strong style="color: var(--gold-primary); display: block; margin-bottom: 0.5rem;">ğŸ¢ ì‚¬ì—…:</strong>
                        <p>${ca.business || ''}</p>
                    </div>
                </div>
            </div>
        `;
        }

        // í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸/TODO ì„¹ì…˜
        let checklistHtml = '';
        if (tojeongResult.action_checklist) {
            const checklist = tojeongResult.action_checklist;
            checklistHtml = `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">âœ… ì˜¬í•´ ì‹¤ì²œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    ${['relationship', 'wealth', 'health', 'career'].map(category => {
                const categoryNames = {
                    'relationship': 'ì¸ê°„ê´€ê³„',
                    'wealth': 'ì¬ë¬¼',
                    'health': 'ê±´ê°•',
                    'career': 'ì»¤ë¦¬ì–´'
                };
                const categoryIcons = {
                    'relationship': 'ğŸ‘¥',
                    'wealth': 'ğŸ’°',
                    'health': 'ğŸƒ',
                    'career': 'ğŸ’¼'
                };
                if (!checklist[category] || !Array.isArray(checklist[category])) return '';
                return `
                            <div style="padding: 1rem; background: rgba(212,175,55,0.03); border-radius: 6px;">
                                <h5 style="color: var(--gold-primary); margin-bottom: 0.8rem; font-size: 1em;">
                                    ${categoryIcons[category]} ${categoryNames[category]}
                                </h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${checklist[category].map(item => `
                                        <li style="padding: 0.5rem 0; color: var(--text-primary); font-size: 0.9em; line-height: 1.6; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <span style="color: var(--gold-primary); margin-right: 0.5rem;">â˜</span> ${item}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
            }).join('')}
                </div>
            </div>
        `;
        }

        // ì¢…í•© í•´ì„ ì„¹ì…˜ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
        const overallInterpretationHtml = `
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-radius: 8px;">
            <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’¡ ì¢…í•© í•´ì„</h4>
            <div style="line-height: 1.8; color: var(--text-primary);">
                ${getOverallInterpretation(tojeongResult)}
            </div>
        </div>
    `;

        // ìµœì¢… HTML ì¡°í•©
        let html = `
        <div class="basic-tojeong-analysis" style="margin-top: 1.5rem;">
            ${basicInfoHtml}
            ${summaryCardHtml}
            ${keywordsHtml}
            ${yearlyFortuneHtml}
            ${monthlyFortunesHtml}
            ${careerAdviceHtml}
            ${checklistHtml}
            ${overallInterpretationHtml}
            ${getYearlyGuidance(tojeongResult.relationship, tojeongResult.fortune_level)}
        </div>
    `;

        return html;
    }

    // ì¢…í•© í•´ì„ ìƒì„±
    function getOverallInterpretation(tojeongResult) {
        const relationship = tojeongResult.relationship || '';
        const fortuneLevel = tojeongResult.fortune_level || '';

        let interpretation = '';

        if (relationship === "ì‚¼í•©" || relationship === "ìœ¡í•©") {
            interpretation = `
            <p style="margin-bottom: 0.8rem;">ìƒë…„ ê°„ì§€ì™€ ì˜¬í•´ ê°„ì§€ê°€ ${relationship} ê´€ê³„ë¡œ, ë§¤ìš° ì¢‹ì€ ì¡°í™”ë¥¼ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤. ì˜¬í•´ëŠ” ì¸ì—°ê³¼ í˜‘ë ¥ì´ ì¤‘ìš”í•˜ë©°, ìƒˆë¡œìš´ ì‹œì‘ì´ë‚˜ ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ê¸°ì— ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤.</p>
            <p style="margin-bottom: 0.8rem;">íŠ¹íˆ ì¸ì  ë„¤íŠ¸ì›Œí¬ë¥¼ ë„“íˆê³  í˜‘ë ¥ ê´€ê³„ë¥¼ ê°•í™”í•˜ëŠ” ê²ƒì´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. ê¸°íšŒê°€ ì˜¤ë©´ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ë˜, ì‹ ì¤‘í•˜ê²Œ íŒë‹¨í•˜ëŠ” ê²ƒë„ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
        `;
        } else if (relationship === "ì¶©") {
            interpretation = `
            <p style="margin-bottom: 0.8rem;">ìƒë…„ ê°„ì§€ì™€ ì˜¬í•´ ê°„ì§€ê°€ ì¶© ê´€ê³„ë¡œ, ë³€í™”ì™€ ë³€ë™ì´ ë§ì€ ì‹œê¸°ì…ë‹ˆë‹¤. ì´ëŠ” ë‚˜ìœ ê²ƒë§Œì€ ì•„ë‹ˆë©°, ì˜¤íˆë ¤ ìƒˆë¡œìš´ ì „í™˜ì ì„ ë§ì´í•  ìˆ˜ ìˆëŠ” ê¸°íšŒì´ê¸°ë„ í•©ë‹ˆë‹¤.</p>
            <p style="margin-bottom: 0.8rem;">ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦´ ë•ŒëŠ” ì¶©ë¶„í•œ ì‹œê°„ì„ ê°€ì§€ê³  ì‹ ì¤‘í•˜ê²Œ ê²€í† í•˜ì„¸ìš”. ê¸‰í•˜ê²Œ ì„œë‘ë¥´ì§€ ë§ê³ , ì°¨ê·¼ì°¨ê·¼ ì¤€ë¹„í•˜ë©° ì§„í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
        `;
        } else if (relationship === "í˜•") {
            interpretation = `
            <p style="margin-bottom: 0.8rem;">ìƒë…„ ê°„ì§€ì™€ ì˜¬í•´ ê°„ì§€ê°€ í˜• ê´€ê³„ë¡œ, ì•½ê°„ì˜ ì–´ë ¤ì›€ì´ë‚˜ ê²½ìŸì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ëŠ” ì„±ì¥ì˜ ê³„ê¸°ê°€ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¸ì •ì ìœ¼ë¡œ ë°›ì•„ë“¤ì´ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
            <p style="margin-bottom: 0.8rem;">ì¸ë‚´ì™€ ë…¸ë ¥ì„ í†µí•´ ì–´ë ¤ì›€ì„ ê·¹ë³µí•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë”ìš± ì„±ìˆ™í•œ ëª¨ìŠµì„ ê°–ì¶œ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. ê±´ê°•ê³¼ ì•ˆì „ì— íŠ¹íˆ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ì„¸ìš”.</p>
        `;
        } else {
            interpretation = `
            <p style="margin-bottom: 0.8rem;">ìƒë…„ ê°„ì§€ì™€ ì˜¬í•´ ê°„ì§€ê°€ í‰ìƒ ê´€ê³„ë¡œ, íŠ¹ë³„í•œ ë³€í™” ì—†ì´ ì•ˆì •ì ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ì´ëŠ” ë‚˜ìœ ê²ƒì´ ì•„ë‹ˆë©°, ê¾¸ì¤€í•œ ë…¸ë ¥ê³¼ ê³„íšì„ í†µí•´ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.</p>
            <p style="margin-bottom: 0.8rem;">ë¬´ë¦¬í•œ ë³€í™”ë¥¼ ì¶”êµ¬í•˜ê¸°ë³´ë‹¤ëŠ” í˜„ì¬ ìƒí™©ì„ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ ì ì§„ì ìœ¼ë¡œ ë°œì „ì‹œì¼œ ë‚˜ê°€ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì„ ìœ ì§€í•˜ì„¸ìš”.</p>
        `;
        }

        return interpretation;
    }

    // í† ì •ë¹„ê²° AI ë¶„ì„ ì‹¤í–‰
    async function runTojeongAIAnalysis() {
        const aiAnalysisDiv = document.getElementById('tojeong-ai-analysis');
        const basicFortuneDiv = document.getElementById('tojeong-basic-fortune');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (!aiAnalysisDiv) return;

        // ì´ë¯¸ ë¶„ì„ ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        if (window.tojeongAIAnalyzing) {
            console.log('í† ì •ë¹„ê²° AI ë¶„ì„ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }

        window.tojeongAIAnalyzing = true;

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'AI ë¶„ì„ì¤‘...';
        }

        try {
            // ì €ì¥ëœ í† ì •ë¹„ê²° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const tojeongData = window.lastTojeongData;
            if (!tojeongData || !tojeongData.tojeong_result) {
                console.error('í† ì •ë¹„ê²° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                window.tojeongAIAnalyzing = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
                return;
            }

            console.log('í† ì •ë¹„ê²° AI ë¶„ì„ ìš”ì²­:', {
                has_tojeong_result: !!tojeongData.tojeong_result,
                has_pillars_data: !!tojeongData.pillars_data,
                has_pillars_info: !!tojeongData.pillars_info
            });

            // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            // API Keyê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í† ì •ë¹„ê²° ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if (!currentApiKey) {
                if (tojeongData && tojeongData.tojeong_result) {
                    const currentYear = new Date().getFullYear();
                    aiAnalysisDiv.innerHTML = generateBasicTojeongAnalysis(
                        tojeongData.tojeong_result,
                        currentYear
                    );
                    aiAnalysisDiv.style.display = 'block';
                } else {
                    aiAnalysisDiv.innerHTML = '';
                }
                window.tojeongAIAnalyzing = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
                return;
            }

            const response = await fetch('/api/tojeong-ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    api_key: currentApiKey,  // API Keyë¥¼ ìš”ì²­ ë³¸ë¬¸ì— í¬í•¨
                    tojeong_result: tojeongData.tojeong_result,
                    pillars_data: tojeongData.pillars_data,
                    pillars_info: tojeongData.pillars_info
                })
            });

            // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/event-stream')) {
                // SSE ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                let fullData = null;

                aiAnalysisDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">í† ì •ë¹„ê²°ì„ ìƒì„¸í•˜ê²Œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 10-15ì´ˆ ì†Œìš”)</p>
                </div>
            `;

                try {
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        // ë§ˆì§€ë§‰ ì¤„ì€ ì™„ì „í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ìœ ì§€
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            // ë¹ˆ ì¤„ ë¬´ì‹œ
                            if (!line.trim()) continue;

                            // SSE í˜•ì‹: "data: {json}"
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.substring(6).trim();
                                    if (!jsonStr) continue;

                                    const data = JSON.parse(jsonStr);

                                    if (data.type === 'start') {
                                        accumulatedText = '';
                                        console.log('ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘');
                                    } else if (data.type === 'chunk') {
                                        if (data.content) {
                                            accumulatedText += data.content;
                                        }
                                    } else if (data.type === 'complete') {
                                        fullData = data.data;
                                        console.log('ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ:', fullData ? 'ë°ì´í„° ìˆ˜ì‹ ' : 'ë°ì´í„° ì—†ìŒ');
                                    } else if (data.type === 'error') {
                                        throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                    }
                                } catch (parseError) {
                                    console.error('ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError, 'Line:', line);
                                    // JSON íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰ (ë¶ˆì™„ì „í•œ ì²­í¬ì¼ ìˆ˜ ìˆìŒ)
                                }
                            }
                        }
                    }

                    // ë²„í¼ì— ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
                    if (buffer.trim() && buffer.startsWith('data: ')) {
                        try {
                            const jsonStr = buffer.substring(6).trim();
                            if (jsonStr) {
                                const data = JSON.parse(jsonStr);
                                if (data.type === 'complete') {
                                    fullData = data.data;
                                } else if (data.type === 'error') {
                                    throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        } catch (e) {
                            console.error('ë²„í¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                        }
                    }

                    // ìµœì¢… ê²°ê³¼ ë Œë”ë§
                    if (fullData) {
                        renderTojeongAIAnalysis(fullData);
                        if (basicFortuneDiv) {
                            basicFortuneDiv.style.display = 'none';
                        }
                        // ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ í•¨ìˆ˜ ì¢…ë£Œ
                        window.tojeongAIAnalyzing = false;
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                        }
                        return;
                    } else if (accumulatedText) {
                        // accumulatedTextê°€ ìˆìœ¼ë©´ JSON íŒŒì‹± ì‹œë„
                        try {
                            const parsed = JSON.parse(accumulatedText);
                            renderTojeongAIAnalysis(parsed);
                            if (basicFortuneDiv) {
                                basicFortuneDiv.style.display = 'none';
                            }
                            // ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ í•¨ìˆ˜ ì¢…ë£Œ
                            window.tojeongAIAnalyzing = false;
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                            }
                            return;
                        } catch (e) {
                            console.error('ëˆ„ì  í…ìŠ¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', e);
                            throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (streamError) {
                    console.error('ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì˜¤ë¥˜:', streamError);
                    throw streamError;
                }
            } else if (contentType && contentType.includes('application/json')) {
                // ê¸°ì¡´ JSON ì‘ë‹µ ì²˜ë¦¬ (í•˜ìœ„ í˜¸í™˜ì„±)
                const data = await response.json();

                console.log('í† ì •ë¹„ê²° AI ë¶„ì„ ì‘ë‹µ:', {
                    success: data.success,
                    is_ai_analysis: data.data?.is_ai_analysis,
                    has_error: !!data.detail,
                    status: response.status
                });

                if (response.ok && data.success) {
                    if (data.data.is_ai_analysis) {
                        // AI ë¶„ì„ ê²°ê³¼ ë Œë”ë§
                        renderTojeongAIAnalysis(data.data.ai_analysis_result);
                        // ê¸°ë³¸ ìš´ì„¸ ìˆ¨ê¸°ê¸°
                        if (basicFortuneDiv) {
                            basicFortuneDiv.style.display = 'none';
                        }
                    } else {
                        // API Keyê°€ ì—†ì„ ë•ŒëŠ” ê¸°ë³¸ í† ì •ë¹„ê²° ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        if (window.lastTojeongData && window.lastTojeongData.tojeong_result) {
                            const currentYear = new Date().getFullYear();
                            aiAnalysisDiv.innerHTML = generateBasicTojeongAnalysis(
                                window.lastTojeongData.tojeong_result,
                                currentYear
                            );
                            aiAnalysisDiv.style.display = 'block';
                        } else {
                            aiAnalysisDiv.style.display = 'none';
                        }
                    }
                    window.tojeongAIAnalyzing = false;
                } else {
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ìš´ì„¸ í‘œì‹œ
                    if (basicFortuneDiv) {
                        basicFortuneDiv.style.display = 'block';
                    }
                    aiAnalysisDiv.style.display = 'none';
                    console.error('Tojeong AI Analysis Error:', data.detail);
                    window.tojeongAIAnalyzing = false;
                }
            } else {
                // JSONì´ ì•„ë‹Œ ì‘ë‹µ (ì˜ˆ: HTML ì—ëŸ¬ í˜ì´ì§€) ì²˜ë¦¬
                const text = await response.text();
                console.error('Non-JSON response from /api/tojeong-ai-analysis:', text);

                // 503 ì—ëŸ¬ì— ëŒ€í•œ íŠ¹ë³„ ì²˜ë¦¬
                if (response.status === 503) {
                    throw new Error('ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }

                throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (HTTP ${response.status})`);
            }
        } catch (error) {
            console.error('Tojeong AI Analysis Error:', error);

            // ì—ëŸ¬ ë©”ì‹œì§€ ê²°ì •
            let errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            if (errorMessage.includes('503') || errorMessage.includes('Service Unavailable')) {
                errorMessage = 'ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } else if (errorMessage.includes('ë„¤íŠ¸ì›Œí¬')) {
                errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }

            window.tojeongAIAnalyzing = false;

            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ìš´ì„¸ í‘œì‹œ
            if (basicFortuneDiv) {
                basicFortuneDiv.style.display = 'block';
            }

            // AI ë¶„ì„ ì˜ì—­ì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            aiAnalysisDiv.style.display = 'block';
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ í† ì •ë¹„ê²° ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if (window.lastTojeongData && window.lastTojeongData.tojeong_result) {
                const currentYear = new Date().getFullYear();
                aiAnalysisDiv.innerHTML = generateBasicTojeongAnalysis(
                    window.lastTojeongData.tojeong_result,
                    currentYear
                );
            } else {
                aiAnalysisDiv.innerHTML = `
                <div style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
                    <div style="font-size: 0.9em; line-height: 1.6;">${errorMessage}</div>
                </div>
            `;
            }
        } finally {
            // ë²„íŠ¼ í™œì„±í™”
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    }

    // í† ì •ë¹„ê²° AI ë¶„ì„ ê²°ê³¼ ë Œë”ë§
    function renderTojeongAIAnalysis(aiAnalysis) {
        const aiAnalysisDiv = document.getElementById('tojeong-ai-analysis');

        if (!aiAnalysis || aiAnalysis.error) {
            return;
        }

        const overview = aiAnalysis.overview || {};
        const detailed = aiAnalysis.detailedAnalysis || {};
        const monthly = aiAnalysis.monthlyFortune || {};
        const lifeAspects = aiAnalysis.lifeAspects || {};
        const lucky = aiAnalysis.luckyElements || {};
        const advice = aiAnalysis.advice || {};

        let html = '';

        // ì „ì²´ ìš”ì•½
        if (overview.summary) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.05); border-left: 4px solid #D4AF37; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #D4AF37; font-size: 1.1em; font-weight: bold; margin-bottom: 1rem;">ğŸ“‹ ì˜¬í•´ì˜ í•µì‹¬ í…Œë§ˆ: ${overview.keyTheme || ''}</div>
                <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em; margin-bottom: 1rem;">${overview.summary}</div>
                <div style="color: #F9E79F; font-size: 0.95em; font-weight: bold;">ì „ì²´ ìš´ì„¸: ${overview.overallFortune || ''}</div>
            </div>
        `;
        }

        // ìƒì„¸ ë¶„ì„
        if (detailed.mainMessage) {
            html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ”® ìƒì„¸ ë¶„ì„</h3>';
            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1rem;"><strong>ì˜¬í•´ì˜ ì£¼ìš” ë©”ì‹œì§€</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${detailed.mainMessage}</div></div>`;

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
            html += `<div style="padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px;"><strong>âœ¨ ì˜¬í•´ì˜ ê¸°íšŒ</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${detailed.opportunities || ''}</div></div>`;
            html += `<div style="padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px;"><strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${detailed.challenges || ''}</div></div>`;
            html += '</div>';

            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px; margin-bottom: 1rem;"><strong>ğŸ’¡ ì‹¤ì²œ ê°€ì´ë“œ</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${detailed.guidance || ''}</div></div>`;
        }

        // ì›”ë³„ ìš´ì„¸
        if (monthly && (monthly.spring || monthly.summer || monthly.fall || monthly.winter)) {
            html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ“… ê³„ì ˆë³„ ìš´ì„¸</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">';
            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px;"><strong>ğŸŒ± ë´„ (3-5ì›”)</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8; font-size: 0.9em;">${monthly.spring || ''}</div></div>`;
            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px;"><strong>â˜€ï¸ ì—¬ë¦„ (6-8ì›”)</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8; font-size: 0.9em;">${monthly.summer || ''}</div></div>`;
            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px;"><strong>ğŸ‚ ê°€ì„ (9-11ì›”)</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8; font-size: 0.9em;">${monthly.fall || ''}</div></div>`;
            html += `<div style="padding: 1rem; background: rgba(212,175,55,0.05); border-radius: 8px;"><strong>â„ï¸ ê²¨ìš¸ (12-2ì›”)</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8; font-size: 0.9em;">${monthly.winter || ''}</div></div>`;
            html += '</div>';
        }

        // ìƒí™œ ì˜ì—­ë³„ ìš´ì„¸
        if (lifeAspects && (lifeAspects.career || lifeAspects.wealth || lifeAspects.relationships || lifeAspects.health || lifeAspects.family)) {
            html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ¯ ìƒí™œ ì˜ì—­ë³„ ìš´ì„¸</h3>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
            html += '<div>';
            if (lifeAspects.career) html += `<div style="margin-bottom: 1rem;"><strong>ğŸ’¼ ì§ì—…/ì‚¬ì—… ìš´</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${lifeAspects.career}</div></div>`;
            if (lifeAspects.wealth) html += `<div style="margin-bottom: 1rem;"><strong>ğŸ’° ì¬ë¬¼/ê¸ˆì „ ìš´</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${lifeAspects.wealth}</div></div>`;
            if (lifeAspects.relationships) html += `<div style="margin-bottom: 1rem;"><strong>â¤ï¸ ì¸ê°„ê´€ê³„/ì• ì • ìš´</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${lifeAspects.relationships}</div></div>`;
            html += '</div>';
            html += '<div>';
            if (lifeAspects.health) html += `<div style="margin-bottom: 1rem;"><strong>ğŸ¥ ê±´ê°• ìš´</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${lifeAspects.health}</div></div>`;
            if (lifeAspects.family) html += `<div style="margin-bottom: 1rem;"><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ìš´</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${lifeAspects.family}</div></div>`;
            html += '</div>';
            html += '</div>';
        }

        // í–‰ìš´ì˜ ìš”ì†Œ
        if (lucky && (lucky.colors || lucky.directions || lucky.numbers || lucky.season)) {
            html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ€ í–‰ìš´ì˜ ìš”ì†Œ</h3>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
            html += '<div>';
            if (lucky.colors) html += `<div style="margin-bottom: 0.5rem;"><strong>ìƒ‰ìƒ:</strong> ${lucky.colors.join(', ')}</div>`;
            if (lucky.directions) html += `<div style="margin-bottom: 0.5rem;"><strong>ë°©ìœ„:</strong> ${lucky.directions.join(', ')}</div>`;
            html += '</div>';
            html += '<div>';
            if (lucky.numbers) html += `<div style="margin-bottom: 0.5rem;"><strong>ìˆ«ì:</strong> ${lucky.numbers.map(String).join(', ')}</div>`;
            if (lucky.season) html += `<div style="margin-bottom: 0.5rem;"><strong>ìœ ë¦¬í•œ ê³„ì ˆ:</strong> ${lucky.season}</div>`;
            html += '</div>';
            html += '</div>';
        }

        // ì¡°ì–¸
        if (advice && (advice.do || advice.avoid || advice.specialNote)) {
            html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<h3 style="color: var(--gold-primary); margin-bottom: 1rem;">ğŸ’­ ì˜¬í•´ë¥¼ ìœ„í•œ ì¡°ì–¸</h3>';
            if (advice.do && advice.do.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong>âœ… ê¶Œì¥ ì‚¬í•­:</strong><ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: var(--text-primary); line-height: 1.8;">';
                advice.do.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul></div>';
            }
            if (advice.avoid && advice.avoid.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong>âŒ í”¼í•´ì•¼ í•  ì¼:</strong><ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: var(--text-primary); line-height: 1.8;">';
                advice.avoid.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul></div>';
            }
            if (advice.specialNote) {
                html += `<div style="padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px;"><strong>ğŸ“Œ íŠ¹ë³„ ì£¼ì˜ì‚¬í•­</strong><div style="margin-top: 0.5rem; color: var(--text-primary); line-height: 1.8;">${advice.specialNote}</div></div>`;
            }
        }

        aiAnalysisDiv.innerHTML = html;
    }
</script>
{% endblock %}