{% extends "base.html" %}

{% block sidebar %}
{% include "includes/sidebar_input.html" %}

<!-- Sidebar Banner -->
{{ sidebar_banner_html | safe }}
{% endblock %}

{% block content %}
<!-- ìš°ì¸¡: ê¶í•© ì…ë ¥ ë° ê²°ê³¼ -->
<div class="result-container">
    <!-- ì»¨í…ì¸  ìƒë‹¨ ë°°ë„ˆ -->


    <!-- ì²« ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì…ë ¥ -->
    <div class="glass-card" style="margin-bottom: 1.5rem;">
        <div class="section-header">
            <span>ğŸ‘¤</span> ì²« ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì…ë ¥
        </div>

        <form id="person1-form">
            <div style="margin-bottom: 1rem;">
                <label for="person1_name"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ì„±í•¨</label>
                <input type="text" id="person1_name" name="name" placeholder="ì²« ë²ˆì§¸ ì‚¬ëŒì˜ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                    value="{{ user_name }}" required autocomplete="off"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person1_birth_date"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ìƒë…„ì›”ì¼</label>
                <input type="date" id="person1_birth_date" name="birth_date" min="1900-01-01" required
                    value="{{ birth_date }}"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person1_birth_time"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">íƒœì–´ë‚œ ì‹œê° (ì„ íƒì‚¬í•­)</label>
                <input type="time" id="person1_birth_time" name="birth_time" value="{{ birth_time }}"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person1_gender"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ì„±ë³„</label>
                <select id="person1_gender" name="gender" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="ë‚¨ì„±" {% if user_gender=='ë‚¨ì„±' %}selected{% endif %}>ë‚¨ì„±</option>
                    <option value="ì—¬ì„±" {% if user_gender=='ì—¬ì„±' %}selected{% endif %}>ì—¬ì„±</option>
                    <option value="ê¸°íƒ€" {% if user_gender=='ê¸°íƒ€' %}selected{% endif %}>ê¸°íƒ€</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; color: var(--text-primary);">
                    <input type="checkbox" id="person1_is_lunar" name="is_lunar" style="margin-right: 0.5rem;" {% if
                        is_lunar %}checked{% endif %}>
                    ìŒë ¥ (Lunar Calendar)
                </label>
            </div>
        </form>
    </div>

    <!-- ë‘ ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì…ë ¥ -->
    <div class="glass-card" style="margin-bottom: 1.5rem;">
        <div class="section-header">
            <span>ğŸ’‘</span> ë‘ ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì…ë ¥
        </div>

        <form id="person2-form">
            <div style="margin-bottom: 1rem;">
                <label for="person2_name"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ì„±í•¨</label>
                <input type="text" id="person2_name" name="name" placeholder="ë‘ ë²ˆì§¸ ì‚¬ëŒì˜ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required
                    autocomplete="off"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person2_birth_date"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ìƒë…„ì›”ì¼</label>
                <input type="date" id="person2_birth_date" name="birth_date" min="1900-01-01" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person2_birth_time"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">íƒœì–´ë‚œ ì‹œê° (ì„ íƒì‚¬í•­)</label>
                <input type="time" id="person2_birth_time" name="birth_time"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="person2_gender"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">ì„±ë³„</label>
                <select id="person2_gender" name="gender" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); box-sizing: border-box;">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                    <option value="ì—¬ì„±">ì—¬ì„±</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; color: var(--text-primary);">
                    <input type="checkbox" id="person2_is_lunar" name="is_lunar" style="margin-right: 0.5rem;">
                    ìŒë ¥ (Lunar Calendar)
                </label>
            </div>

            <button type="button" id="calculate-btn"
                style="width: 100%; padding: 1rem; background: var(--gold-gradient); border: none; border-radius: 8px; color: var(--bg-dark); font-weight: bold; cursor: pointer; font-size: 1rem;">
                ê¶í•©ë³´ê¸°
            </button>
        </form>

        <div id="form-error"
            style="margin-top: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5; display: none;">
        </div>
    </div>

    <!-- ê¶í•© ê²°ê³¼ -->
    <div id="result-container" style="display: none;">
        <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ ì˜ì—­ -->
    <div id="gonghap-share" style="display: none;">
        {% include "includes/share_buttons.html" %}
    </div>

    <div id="empty-state" style="text-align: center; padding: 3rem; color: var(--text-muted);">
        <div style="font-size: 3em; margin-bottom: 1rem;">ğŸ’•</div>
        <p>ë‘ ì‚¬ëŒì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  "ê¶í•©ë³´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ í¼ ê°’ ë³µì› ë° ì²« ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì„¤ì •
    // API KeyëŠ” ì €ì¥í•˜ì§€ ì•Šê³  ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´

    document.addEventListener('DOMContentLoaded', function () {
        fillFormFromLocalStorage('input-form');

        // ì¢Œì¸¡ ì •ë³´ì…ë ¥ë€ì˜ ê°’ì„ ì²« ë²ˆì§¸ ì‚¬ëŒ ì…ë ¥ë€ì— ë³µì‚¬
        setTimeout(() => {
            const inputForm = document.getElementById('input-form');
            const person1Form = document.getElementById('person1-form');

            if (inputForm && person1Form) {
                const nameInput = inputForm.querySelector('[name="name"]');
                const birthDateInput = inputForm.querySelector('[name="birth_date"]');
                const birthTimeInput = inputForm.querySelector('[name="birth_time"]');
                const genderSelect = inputForm.querySelector('[name="gender"]');
                const isLunarCheckbox = inputForm.querySelector('[name="is_lunar"]');

                const person1NameInput = person1Form.querySelector('[name="name"]');
                const person1BirthDateInput = person1Form.querySelector('[name="birth_date"]');
                const person1BirthTimeInput = person1Form.querySelector('[name="birth_time"]');
                const person1GenderSelect = person1Form.querySelector('[name="gender"]');
                const person1IsLunarCheckbox = person1Form.querySelector('[name="is_lunar"]');

                // ì¢Œì¸¡ ì •ë³´ì…ë ¥ë€ì— ê°’ì´ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ì‚¬ëŒ ì…ë ¥ë€ì— ë³µì‚¬
                if (nameInput?.value && person1NameInput) {
                    person1NameInput.value = nameInput.value;
                }
                if (birthDateInput?.value && person1BirthDateInput) {
                    person1BirthDateInput.value = birthDateInput.value;
                }
                if (birthTimeInput?.value && person1BirthTimeInput) {
                    person1BirthTimeInput.value = birthTimeInput.value;
                }
                if (genderSelect?.value && person1GenderSelect) {
                    person1GenderSelect.value = genderSelect.value;
                }
                if (person1IsLunarCheckbox) {
                    person1IsLunarCheckbox.checked = isLunarCheckbox?.checked || false;
                }
            }
        }, 100);
    });

    // ì¢Œì¸¡ ì •ë³´ì…ë ¥ë€ í¼ ì œì¶œ ì²˜ë¦¬ (ì‚¬ì£¼ ê³„ì‚°)
    document.getElementById('input-form')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        // ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        if (submitBtn && submitBtn.disabled) {
            return;
        }

        const formData = new FormData(this);
        const errorDiv = document.getElementById('form-error');

        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        }
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ì„¸ì…˜ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
                if (data.data && data.data.session_data) {
                    saveSessionDataToLocalStorage(data.data);
                } else {
                    const sessionData = {
                        user_name: formData.get('name') || '',
                        user_gender: formData.get('gender') || '',
                        birth_date: formData.get('birth_date') || '',
                        birth_time: formData.get('birth_time') || '',
                        is_lunar: formData.get('is_lunar') === 'on' || formData.get('is_lunar') === 'true',
                        _timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                    };
                    localStorage.setItem('user_session_data', JSON.stringify(sessionData));
                }

                // í¼ ê°’ì„ FormDataì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
                const form = document.getElementById('input-form');
                if (form) {
                    const nameInput = form.querySelector('[name="name"]');
                    const birthDateInput = form.querySelector('[name="birth_date"]');
                    const birthTimeInput = form.querySelector('[name="birth_time"]');
                    const genderSelect = form.querySelector('[name="gender"]');
                    const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

                    if (nameInput) nameInput.value = formData.get('name') || '';
                    if (birthDateInput) birthDateInput.value = formData.get('birth_date') || '';
                    if (birthTimeInput) birthTimeInput.value = formData.get('birth_time') || '';
                    if (genderSelect) genderSelect.value = formData.get('gender') || '';
                    if (isLunarCheckbox) {
                        const isLunarValue = formData.get('is_lunar');
                        isLunarCheckbox.checked = isLunarValue === 'on' || isLunarValue === 'true' || isLunarValue === true;
                    }
                }

                // ì²« ë²ˆì§¸ ì‚¬ëŒ ì •ë³´ ì…ë ¥ë€ì— ìë™ìœ¼ë¡œ ì±„ìš°ê¸°
                document.getElementById('person1_name').value = formData.get('name') || '';
                document.getElementById('person1_birth_date').value = formData.get('birth_date') || '';
                document.getElementById('person1_birth_time').value = formData.get('birth_time') || '';
                document.getElementById('person1_gender').value = formData.get('gender') || '';
                const person1IsLunarValue = formData.get('is_lunar');
                document.getElementById('person1_is_lunar').checked = person1IsLunarValue === 'on' || person1IsLunarValue === 'true' || person1IsLunarValue === true;

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            } else {
                if (errorDiv) {
                    errorDiv.textContent = data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            if (errorDiv) {
                errorDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    });

    // API Key ì…ë ¥ ì²˜ë¦¬ (ì €ì¥í•˜ì§€ ì•Šê³  ì…ë ¥ê°’ë§Œ ì‚¬ìš©)
    // ë””ë°”ìš´ìŠ¤ë¥¼ ìœ„í•´ setTimeout ì‚¬ìš©
    let apiKeyInputTimeout = null;
    document.getElementById('api-key-input')?.addEventListener('input', function () {
        const apiKey = this.value.trim();
        const statusDiv = document.getElementById('api-key-status');

        // ë””ë°”ìš´ìŠ¤: ì…ë ¥ì´ ë©ˆì¶˜ í›„ 500ms í›„ì— ì²˜ë¦¬
        if (apiKeyInputTimeout) {
            clearTimeout(apiKeyInputTimeout);
        }

        apiKeyInputTimeout = setTimeout(() => {
            if (apiKey) {
                if (statusDiv) {
                    statusDiv.textContent = 'âœ“ API Keyê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶í•©ì„ ë‹¤ì‹œ ê³„ì‚°í•˜ë©´ AI ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.';
                    statusDiv.style.color = '#2ecc71';
                    statusDiv.style.display = 'block';
                }

                // API Key ì…ë ¥ í›„, ê¶í•© ê²°ê³¼ê°€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ë‹¤ì‹œ ê³„ì‚°
                const resultContainer = document.getElementById('result-container');
                const calculateBtn = document.getElementById('calculate-btn');
                if (resultContainer && resultContainer.style.display !== 'none' && calculateBtn) {
                    setTimeout(() => {
                        calculateBtn.click();
                    }, 500);
                }
            } else {
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }
        }, 500);
    });

    // ê¶í•© ê³„ì‚° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('calculate-btn')?.addEventListener('click', async function () {
        const errorDiv = document.getElementById('form-error');
        const resultContainer = document.getElementById('result-container');
        const emptyState = document.getElementById('empty-state');
        const calculateBtn = this;

        // ìœ íš¨ì„± ê²€ì‚¬
        const person1_name = document.getElementById('person1_name').value.trim();
        const person1_gender = document.getElementById('person1_gender').value;
        const person2_name = document.getElementById('person2_name').value.trim();
        const person2_gender = document.getElementById('person2_gender').value;

        if (!person1_name || person1_gender === '') {
            if (errorDiv) {
                errorDiv.textContent = 'ì²« ë²ˆì§¸ ì‚¬ëŒì˜ ì´ë¦„ê³¼ ì„±ë³„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorDiv.style.display = 'block';
            }
            return;
        }

        if (!person2_name || person2_gender === '') {
            if (errorDiv) {
                errorDiv.textContent = 'ë‘ ë²ˆì§¸ ì‚¬ëŒì˜ ì´ë¦„ê³¼ ì„±ë³„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorDiv.style.display = 'block';
            }
            return;
        }

        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        // ë¡œë”© í‘œì‹œ
        calculateBtn.disabled = true;
        calculateBtn.textContent = 'ê³„ì‚° ì¤‘...';
        if (emptyState) emptyState.style.display = 'none';
        if (resultContainer) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = `
            <div class="glass-card">
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">ê¶í•©ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
        `;
        }

        try {
            // ì²« ë²ˆì§¸ ì‚¬ëŒ ì‚¬ì£¼ ê³„ì‚°
            const form1 = document.getElementById('person1-form');
            const formData1 = new FormData(form1);

            const response1 = await fetch('/api/calculate', {
                method: 'POST',
                body: formData1,
                credentials: 'same-origin'
            });

            const data1 = await response1.json();
            if (!response1.ok || !data1.success) {
                throw new Error(data1.detail || 'ì²« ë²ˆì§¸ ì‚¬ëŒì˜ ì‚¬ì£¼ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            // ë‘ ë²ˆì§¸ ì‚¬ëŒ ì‚¬ì£¼ ê³„ì‚°
            const form2 = document.getElementById('person2-form');
            const formData2 = new FormData(form2);

            const response2 = await fetch('/api/calculate', {
                method: 'POST',
                body: formData2,
                credentials: 'same-origin'
            });

            const data2 = await response2.json();
            if (!response2.ok || !data2.success) {
                throw new Error(data2.detail || 'ë‘ ë²ˆì§¸ ì‚¬ëŒì˜ ì‚¬ì£¼ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            // ê¶í•© ê³„ì‚°
            const gonghapResponse = await fetch('/api/gonghap', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    person1_pillars_data: data1.data.pillars_data,
                    person1_pillars_info: data1.data.pillars_info,
                    person1_gender: person1_gender,
                    person2_pillars_data: data2.data.pillars_data,
                    person2_pillars_info: data2.data.pillars_info,
                    person2_gender: person2_gender
                })
            });

            let gonghapData;
            const contentType = gonghapResponse.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                gonghapData = await gonghapResponse.json();
            } else {
                // JSONì´ ì•„ë‹Œ ì‘ë‹µ (ì˜ˆ: HTML ì—ëŸ¬ í˜ì´ì§€) ì²˜ë¦¬
                const text = await gonghapResponse.text();
                console.error('Non-JSON response from /api/gonghap:', text);

                // 503 ì—ëŸ¬ì— ëŒ€í•œ íŠ¹ë³„ ì²˜ë¦¬
                if (gonghapResponse.status === 503) {
                    throw new Error('ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }

                throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (HTTP ${gonghapResponse.status})`);
            }

            if (!gonghapResponse.ok || !gonghapData.success) {
                let errorMessage = gonghapData.detail || 'ê¶í•© ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (gonghapResponse.status === 503) {
                    errorMessage = 'ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
                throw new Error(errorMessage);
            }

            // ê²°ê³¼ í‘œì‹œ
            renderGonghapResult(person1_name, person2_name, data1.data.pillars_data, data2.data.pillars_data, gonghapData.data);

            // ê¸°ë³¸ ê¶í•© ê²°ê³¼ ì €ì¥ (AI ë¶„ì„ìš©)
            window.lastGonghapData = {
                gonghap_data: gonghapData.data,
                person1_pillars_data: data1.data.pillars_data,
                person1_pillars_info: data1.data.pillars_info,
                person2_pillars_data: data2.data.pillars_data,
                person2_pillars_info: data2.data.pillars_info
            };

            // API Keyê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ AI ë¶„ì„ ì‹œì‘ (ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°)
            // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            if (currentApiKey) {
                setTimeout(() => {
                    runGonghapAIAnalysis();
                }, 500);
            }

        } catch (error) {
            console.error('Error:', error);
            if (errorDiv) {
                errorDiv.textContent = error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
            if (resultContainer) {
                resultContainer.style.display = 'none';
            }
            if (emptyState) emptyState.style.display = 'block';
        } finally {
            calculateBtn.disabled = false;
            calculateBtn.textContent = 'ê¶í•©ë³´ê¸°';
        }
    });

    // ê¶í•© ê²°ê³¼ ë Œë”ë§
    function renderGonghapResult(person1_name, person2_name, person1_pillars_data, person2_pillars_data, gonghap_result) {
        const resultContainer = document.getElementById('result-container');
        const emptyState = document.getElementById('empty-state');

        if (!resultContainer) return;

        if (emptyState) emptyState.style.display = 'none';
        resultContainer.style.display = 'block';



        const overall_score = gonghap_result.overall_score || 75;
        const overall_level = gonghap_result.overall_level || 'ë³´í†µ';
        const overall_desc = gonghap_result.overall_desc || '';

        // ê³µìœ  ë²„íŠ¼ í‘œì‹œ
        const shareDiv = document.getElementById('gonghap-share');
        if (shareDiv) shareDiv.style.display = 'block';

        // ê³µìœ  ë°ì´í„° ì„¤ì •
        const shareTitle = `${person1_name}ë‹˜ê³¼ ${person2_name}ë‹˜ì˜ ê¶í•© ê²°ê³¼ - ìš´ì„¸ë‹´`;
        const shareDesc = `ë‘ ë¶„ì˜ ê¶í•© ì ìˆ˜ëŠ” ${overall_score}ì ì…ë‹ˆë‹¤! ${overall_level} - ${overall_desc}`;

        window.currentShareData = {
            title: shareTitle,
            description: shareDesc,
            url: window.location.href,
            text: `${shareTitle}\n${shareDesc}\n\nì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!`
        };

        // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ
        let score_color, level_icon;
        if (overall_score >= 85) {
            score_color = "#2ecc71";
            level_icon = "ğŸŒŸ";
        } else if (overall_score >= 75) {
            score_color = "#3498db";
            level_icon = "âœ¨";
        } else if (overall_score >= 65) {
            score_color = "#f1c40f";
            level_icon = "ğŸ’«";
        } else if (overall_score >= 50) {
            score_color = "#e67e22";
            level_icon = "â­";
        } else {
            score_color = "#e74c3c";
            level_icon = "âš ï¸";
        }

        let html = `
        <div class="glass-card">
            <div class="section-header">
                <span>ğŸ’•</span> ${person1_name}ë‹˜ê³¼ ${person2_name}ë‹˜ì˜ ê¶í•©
            </div>
            
            <!-- ì „ì²´ ì ìˆ˜ ë° ë ˆë²¨ -->
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                <div style="font-size: 3em; font-weight: bold; color: ${score_color}; margin-bottom: 0.5rem;">${overall_score}ì </div>
                <div style="font-size: 1.5em; font-weight: bold; color: #D4AF37; margin-bottom: 1rem;">${level_icon} ${overall_level}</div>
                <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">${overall_desc}</div>
            </div>
            
            <!-- ì‚¬ì£¼ ë¹„êµ í…Œì´ë¸” -->
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ“Š ì‚¬ì£¼ ë¹„êµ</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">
                <thead>
                    <tr style="background: rgba(212,175,55,0.1);">
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-gold); color: var(--gold-primary);">êµ¬ë¶„</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-gold); color: var(--gold-primary);">${person1_name}</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-gold); color: var(--gold-primary);">${person2_name}</th>
                    </tr>
                </thead>
                <tbody>
    `;

        const pillar_names = ["ë…„ì£¼", "ì›”ì£¼", "ì¼ì£¼", "ì‹œì£¼"];
        for (let i = 0; i < 4; i++) {
            const p1_stem = person1_pillars_data[i]?.Heavenly_Stem || person1_pillars_data[i]?.['Heavenly Stem (ì²œê°„)'] || '-';
            const p1_branch = person1_pillars_data[i]?.Earthly_Branch || person1_pillars_data[i]?.['Earthly Branch (ì§€ì§€)'] || '-';
            const p2_stem = person2_pillars_data[i]?.Heavenly_Stem || person2_pillars_data[i]?.['Heavenly Stem (ì²œê°„)'] || '-';
            const p2_branch = person2_pillars_data[i]?.Earthly_Branch || person2_pillars_data[i]?.['Earthly Branch (ì§€ì§€)'] || '-';

            html += `
            <tr style="border-bottom: 1px solid rgba(212,175,55,0.2);">
                <td style="padding: 0.75rem; color: var(--text-primary);">${pillar_names[i]}</td>
                <td style="padding: 0.75rem; color: var(--text-primary);">${p1_stem}${p1_branch}</td>
                <td style="padding: 0.75rem; color: var(--text-primary);">${p2_stem}${p2_branch}</td>
            </tr>
        `;
        }

        html += `
                </tbody>
            </table>
            
            <!-- ê¸°ë‘¥ë³„ ìƒì„¸ ê¶í•© ë¶„ì„ -->
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ” ê¸°ë‘¥ë³„ ê¶í•© ë¶„ì„</h3>
    `;

        // ê¸°ë‘¥ë³„ ê¶í•© ë¶„ì„
        if (gonghap_result.pillar_compatibilities && gonghap_result.pillar_compatibilities.length > 0) {
            for (const pillar_compat of gonghap_result.pillar_compatibilities) {
                const score = pillar_compat.score || 50;
                const level = pillar_compat.level || 'ë³´í†µ';
                const analysis = pillar_compat.analysis || '';

                let bg_color, border_color;
                if (score >= 85) {
                    bg_color = "rgba(46, 204, 113, 0.2)";
                    border_color = "#2ecc71";
                } else if (score >= 75) {
                    bg_color = "rgba(52, 152, 219, 0.2)";
                    border_color = "#3498db";
                } else if (score >= 65) {
                    bg_color = "rgba(241, 196, 15, 0.2)";
                    border_color = "#f1c40f";
                } else if (score >= 50) {
                    bg_color = "rgba(230, 126, 34, 0.2)";
                    border_color = "#e67e22";
                } else {
                    bg_color = "rgba(231, 76, 60, 0.2)";
                    border_color = "#e74c3c";
                }

                html += `
                <div style="padding: 1rem; margin: 0.5rem 0; background: ${bg_color}; border-left: 4px solid ${border_color}; border-radius: 6px;">
                    <div style="font-weight: bold; font-size: 1.1em; color: #D4AF37; margin-bottom: 0.5rem;">
                        ${pillar_compat.pillar} ê¶í•©: ${score}ì  (${level})
                    </div>
                    <div style="color: #E2E8F0; line-height: 1.6; font-size: 0.95em;">
                        ${analysis}
                    </div>
                </div>
            `;
            }
        }

        // ì§€ì§€ ê´€ê³„ ë¶„ì„
        if (gonghap_result.branch_relationships && gonghap_result.branch_relationships.length > 0) {
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ”— ì§€ì§€ ê´€ê³„ ë¶„ì„</h3>
        `;
            for (const relation of gonghap_result.branch_relationships) {
                html += `
                <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(52, 152, 219, 0.1); border-radius: 6px; color: #E2E8F0;">
                    â€¢ ${relation}
                </div>
            `;
            }
        }

        // ì‹­ì„± ë¶„ì„
        if (gonghap_result.ten_god_analysis && gonghap_result.ten_god_analysis.length > 0) {
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ¯ ì‹­ì„± ê´€ê³„ ë¶„ì„</h3>
        `;
            for (const ten_god of gonghap_result.ten_god_analysis) {
                html += `
                <div style="padding: 0.75rem; margin: 0.5rem 0; color: #E2E8F0;">
                    â€¢ ${ten_god}
                </div>
            `;
            }
        }

        // ê°•ì ê³¼ ì•½ì 
        if (gonghap_result.strengths && gonghap_result.strengths.length > 0) {
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">âœ… ì¥ì </h3>
        `;
            for (const strength of gonghap_result.strengths) {
                html += `
                <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(46, 204, 113, 0.1); border-radius: 6px; color: #E2E8F0;">
                    â€¢ ${strength}
                </div>
            `;
            }
        }

        if (gonghap_result.weaknesses && gonghap_result.weaknesses.length > 0) {
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
        `;
            for (const weakness of gonghap_result.weaknesses) {
                html += `
                <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(241, 196, 15, 0.1); border-radius: 6px; color: #E2E8F0;">
                    â€¢ ${weakness}
                </div>
            `;
            }
        }

        // ìƒì„¸ ê°€ì´ë“œ
        if (gonghap_result.detailed_guidance) {
            const guidance = gonghap_result.detailed_guidance;
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ’¡ ê´€ê³„ ê°€ì´ë“œ</h3>
            <h4 style="color: var(--gold-primary); margin-top: 1rem; margin-bottom: 0.5rem;">ğŸ’¬ ì†Œí†µ</h4>
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(52, 152, 219, 0.1); border-radius: 6px; color: #E2E8F0;">
                ${guidance.communication || ''}
            </div>
            <h4 style="color: var(--gold-primary); margin-top: 1rem; margin-bottom: 0.5rem;">ğŸ¤ ê´€ê³„ ìœ ì§€</h4>
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(52, 152, 219, 0.1); border-radius: 6px; color: #E2E8F0;">
                ${guidance.relationship || ''}
            </div>
            <h4 style="color: var(--gold-primary); margin-top: 1rem; margin-bottom: 0.5rem;">ğŸ› ï¸ ê°ˆë“± í•´ê²°</h4>
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(52, 152, 219, 0.1); border-radius: 6px; color: #E2E8F0;">
                ${guidance.conflict_resolution || ''}
            </div>
            <h4 style="color: var(--gold-primary); margin-top: 1rem; margin-bottom: 0.5rem;">ğŸ“ˆ í•¨ê»˜ ì„±ì¥í•˜ê¸°</h4>
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: rgba(52, 152, 219, 0.1); border-radius: 6px; color: #E2E8F0;">
                ${guidance.growth || ''}
            </div>
        `;
        }

        // ì¡°ì–¸
        if (gonghap_result.advice) {
            html += `
            <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸŒŸ ì¢…í•© ì¡°ì–¸</h3>
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.15); border-radius: 8px; border-left: 4px solid #D4AF37;">
                <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">
                    ${gonghap_result.advice}
                </div>
            </div>
        `;
        }

        // AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        if (gonghap_result.is_ai_analysis && gonghap_result.ai_analysis && !gonghap_result.ai_analysis.error) {
            const aiAnalysis = gonghap_result.ai_analysis;
            html += `
            <div id="gonghap-ai-analysis" style="margin-top: 2rem;">
                <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ¤– AI ìƒì„¸ ë¶„ì„</h3>
        `;

            // Overview
            if (aiAnalysis.overview) {
                html += `
                <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ“‹ ì „ì²´ ìš”ì•½</h4>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em; margin-bottom: 1rem;">
                        ${aiAnalysis.overview.summary || ''}
                    </div>
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">í•µì‹¬ í…Œë§ˆ: ${aiAnalysis.overview.keyTheme || ''}</div>
                    <div style="color: #E2E8F0;">ì „ì²´ í‰ê°€: ${aiAnalysis.overview.overallLevel || ''}</div>
                </div>
            `;
            }

            // Detailed Analysis
            if (aiAnalysis.detailedAnalysis) {
                html += `
                <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ” ìƒì„¸ ë¶„ì„</h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’ª ê´€ê³„ì˜ ê°•ì </div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.strengths || ''}</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ ë„ì „ê³¼ì œ</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.challenges || ''}</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ”„ í˜¸í™˜ì„±</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.compatibility || ''}</div>
                    </div>
                    <div>
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“ˆ ì„±ì¥ ê°€ëŠ¥ì„±</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.growthPotential || ''}</div>
                    </div>
                </div>
            `;
            }

            // Life Aspects
            if (aiAnalysis.lifeAspects) {
                html += `
                <h4 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ¯ ìƒí™œ ì˜ì—­ë³„ ê¶í•©</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            `;
                if (aiAnalysis.lifeAspects.career) {
                    html += `
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’¼ ì§ì—…/ì‚¬ì—…</div>
                        <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.career}</div>
                    </div>
                `;
                }
                if (aiAnalysis.lifeAspects.wealth) {
                    html += `
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’° ì¬ë¬¼/ê¸ˆì „</div>
                        <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.wealth}</div>
                    </div>
                `;
                }
                if (aiAnalysis.lifeAspects.relationships) {
                    html += `
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">â¤ï¸ ì¸ê°„ê´€ê³„/ì• ì •</div>
                        <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.relationships}</div>
                    </div>
                `;
                }
                if (aiAnalysis.lifeAspects.health) {
                    html += `
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ¥ ê±´ê°•</div>
                        <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.health}</div>
                    </div>
                `;
                }
                if (aiAnalysis.lifeAspects.family) {
                    html += `
                    <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±</div>
                        <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.family}</div>
                    </div>
                `;
                }
                html += `</div>`;
            }

            // Communication
            if (aiAnalysis.communication) {
                html += `
                <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ’¬ ì†Œí†µ ë¶„ì„</h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ì†Œí†µ ìŠ¤íƒ€ì¼</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.communication.style || ''}</div>
                    </div>
                    <div>
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ì†Œí†µ íŒ</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.communication.tips || ''}</div>
                    </div>
                </div>
            `;
            }

            // Relationship Guidance
            if (aiAnalysis.relationshipGuidance) {
                html += `
                <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ’¡ ê´€ê³„ ê°€ì´ë“œ</h4>
            `;
                if (aiAnalysis.relationshipGuidance.do && aiAnalysis.relationshipGuidance.do.length > 0) {
                    html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âœ… í•´ì•¼ í•  ì¼</div>
                        <ul style="color: #E2E8F0; line-height: 1.8; padding-left: 1.5rem;">
                            ${aiAnalysis.relationshipGuidance.do.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
                }
                if (aiAnalysis.relationshipGuidance.avoid && aiAnalysis.relationshipGuidance.avoid.length > 0) {
                    html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ í”¼í•´ì•¼ í•  ì¼</div>
                        <ul style="color: #E2E8F0; line-height: 1.8; padding-left: 1.5rem;">
                            ${aiAnalysis.relationshipGuidance.avoid.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
                }
                if (aiAnalysis.relationshipGuidance.specialAdvice) {
                    html += `
                    <div>
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸŒŸ íŠ¹ë³„ ì¡°ì–¸</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.relationshipGuidance.specialAdvice}</div>
                    </div>
                `;
                }
                html += `</div>`;
            }

            // Long Term Outlook
            if (aiAnalysis.longTermOutlook) {
                html += `
                <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ“… ì¥ê¸° ì „ë§</h4>
            `;
                if (aiAnalysis.longTermOutlook.shortTerm) {
                    html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“† ë‹¨ê¸° ì „ë§ (1-2ë…„)</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.shortTerm}</div>
                    </div>
                `;
                }
                if (aiAnalysis.longTermOutlook.mediumTerm) {
                    html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“… ì¤‘ê¸° ì „ë§ (3-5ë…„)</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.mediumTerm}</div>
                    </div>
                `;
                }
                if (aiAnalysis.longTermOutlook.longTerm) {
                    html += `
                    <div>
                        <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ”® ì¥ê¸° ì „ë§ (5ë…„ ì´ìƒ)</div>
                        <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.longTerm}</div>
                    </div>
                `;
                }
                html += `</div>`;
            }

            html += `</div>`;
        }

        html += `
        </div>
    `;

        resultContainer.innerHTML = html;

        // API Keyê°€ ì—†ê³  AI ë¶„ì„ ê²°ê³¼ë„ ì—†ì„ ë•Œë§Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
        // (API Keyê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ AI ë¶„ì„ì´ ì‹œì‘ë˜ë¯€ë¡œ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
        // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
        if (!gonghap_result.is_ai_analysis) {
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            if (!currentApiKey) {
                const apiKeyMessage = document.createElement('div');
                apiKeyMessage.style.cssText = 'margin-top: 2rem; padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; border-left: 4px solid #D4AF37;';
                apiKeyMessage.innerHTML = `
                <div style="color: #F9E79F; line-height: 1.8; font-size: 1.05em;">
                    ğŸ’¡ ë” ìƒì„¸í•œ AI ë¶„ì„ì„ ë°›ìœ¼ì‹œë ¤ë©´ ì¢Œì¸¡ ë©”ë‰´ì—ì„œ OpenAI API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            `;
                resultContainer.appendChild(apiKeyMessage);
            }
        }
    }

    // ê¶í•© AI ë¶„ì„ ì‹¤í–‰
    async function runGonghapAIAnalysis() {
        const aiAnalysisContainer = document.getElementById('gonghap-ai-analysis-container') || document.getElementById('result-container');
        if (!aiAnalysisContainer) return;

        const gonghapData = window.lastGonghapData;
        if (!gonghapData || !gonghapData.gonghap_data) {
            console.error('ê¶í•© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // AI ë¶„ì„ ì˜ì—­ ìƒì„±
        let aiAnalysisDiv = document.getElementById('gonghap-ai-analysis');
        if (!aiAnalysisDiv) {
            aiAnalysisDiv = document.createElement('div');
            aiAnalysisDiv.id = 'gonghap-ai-analysis';
            aiAnalysisDiv.style.marginTop = '2rem';

            if (aiAnalysisContainer.id === 'gonghap-ai-analysis-container') {
                aiAnalysisContainer.appendChild(aiAnalysisDiv);
            } else {
                // result-containerì— ì¶”ê°€
                aiAnalysisContainer.insertAdjacentElement('beforeend', aiAnalysisDiv);
            }
        }

        // ë¡œë”© í‘œì‹œ
        aiAnalysisDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 1rem; color: var(--text-muted);">ê¶í•©ì„ ìƒì„¸í•˜ê²Œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 15-20ì´ˆ ì†Œìš”)</p>
        </div>
    `;

        try {
            console.log('ê¶í•© AI ë¶„ì„ ìš”ì²­:', {
                has_gonghap_data: !!gonghapData.gonghap_data,
                has_person1_pillars: !!gonghapData.person1_pillars_data,
                has_person2_pillars: !!gonghapData.person2_pillars_data
            });

            // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!currentApiKey) {
                throw new Error('OpenAI API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            const response = await fetch('/api/gonghap-ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    api_key: currentApiKey,  // API Keyë¥¼ ìš”ì²­ ë³¸ë¬¸ì— í¬í•¨
                    gonghap_data: gonghapData.gonghap_data,
                    person1_pillars_data: gonghapData.person1_pillars_data,
                    person1_pillars_info: gonghapData.person1_pillars_info,
                    person2_pillars_data: gonghapData.person2_pillars_data,
                    person2_pillars_info: gonghapData.person2_pillars_info
                })
            });

            // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/event-stream')) {
                // SSE ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                let fullData = null;

                try {
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (!line.trim()) continue;

                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.substring(6).trim();
                                    if (!jsonStr) continue;

                                    const data = JSON.parse(jsonStr);

                                    if (data.type === 'start') {
                                        accumulatedText = '';
                                        console.log('ê¶í•© ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘');
                                    } else if (data.type === 'chunk') {
                                        if (data.content) {
                                            accumulatedText += data.content;
                                        }
                                    } else if (data.type === 'complete') {
                                        fullData = data.data;
                                        console.log('ê¶í•© ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ:', fullData ? 'ë°ì´í„° ìˆ˜ì‹ ' : 'ë°ì´í„° ì—†ìŒ');
                                    } else if (data.type === 'error') {
                                        throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                    }
                                } catch (parseError) {
                                    console.error('ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError, 'Line:', line);
                                }
                            }
                        }
                    }

                    // ë²„í¼ì— ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
                    if (buffer.trim() && buffer.startsWith('data: ')) {
                        try {
                            const jsonStr = buffer.substring(6).trim();
                            if (jsonStr) {
                                const data = JSON.parse(jsonStr);
                                if (data.type === 'complete') {
                                    fullData = data.data;
                                } else if (data.type === 'error') {
                                    throw new Error(data.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        } catch (e) {
                            console.error('ë²„í¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                        }
                    }

                    // ìµœì¢… ê²°ê³¼ ë Œë”ë§
                    if (fullData) {
                        renderGonghapAIAnalysis(fullData);
                    } else if (accumulatedText) {
                        try {
                            const parsed = JSON.parse(accumulatedText);
                            renderGonghapAIAnalysis(parsed);
                        } catch (e) {
                            console.error('ëˆ„ì  í…ìŠ¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', e);
                            throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        throw new Error('AI ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (streamError) {
                    console.error('ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì˜¤ë¥˜:', streamError);
                    throw streamError;
                }
            } else if (contentType && contentType.includes('application/json')) {
                // ê¸°ì¡´ JSON ì‘ë‹µ ì²˜ë¦¬ (í•˜ìœ„ í˜¸í™˜ì„±)
                const data = await response.json();
                if (response.ok && data.success && data.data && data.data.is_ai_analysis) {
                    // JSON ì‘ë‹µì—ì„œ AI ë¶„ì„ ê²°ê³¼ ë Œë”ë§
                    // ì´ ê²½ìš°ëŠ” ì—†ì„ ê²ƒ ê°™ì§€ë§Œ, ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                } else {
                    throw new Error(data.detail || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                const text = await response.text();
                console.error('Non-JSON response from /api/gonghap-ai-analysis:', text);
                if (response.status === 503) {
                    throw new Error('ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (HTTP ${response.status})`);
            }
        } catch (error) {
            console.error('ê¶í•© AI ë¶„ì„ ì˜¤ë¥˜:', error);
            let errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            if (errorMessage.includes('503') || errorMessage.includes('Service Unavailable')) {
                errorMessage = 'ì„œë²„ê°€ í˜„ì¬ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }

            aiAnalysisDiv.innerHTML = `
            <div style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
                <div style="font-size: 0.9em; line-height: 1.6;">${errorMessage}</div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 6px; color: #F9E79F; font-size: 0.85em;">
                    ğŸ’¡ ê¸°ë³¸ ê¶í•© ê²°ê³¼ëŠ” ìœ„ì— í‘œì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤. AI ë¶„ì„ì€ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        `;
        }
    }

    // ê¶í•© AI ë¶„ì„ ê²°ê³¼ ë Œë”ë§
    function renderGonghapAIAnalysis(aiAnalysis) {
        const aiAnalysisDiv = document.getElementById('gonghap-ai-analysis');
        if (!aiAnalysisDiv || !aiAnalysis || aiAnalysis.error) {
            return;
        }

        let html = `
        <h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ¤– AI ìƒì„¸ ë¶„ì„</h3>
    `;

        // Overview
        if (aiAnalysis.overview) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ“‹ ì „ì²´ ìš”ì•½</h4>
                <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em; margin-bottom: 1rem;">
                    ${aiAnalysis.overview.summary || ''}
                </div>
                <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">í•µì‹¬ í…Œë§ˆ: ${aiAnalysis.overview.keyTheme || ''}</div>
                <div style="color: #E2E8F0;">ì „ì²´ í‰ê°€: ${aiAnalysis.overview.overallLevel || ''}</div>
            </div>
        `;
        }

        // Detailed Analysis
        if (aiAnalysis.detailedAnalysis) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ” ìƒì„¸ ë¶„ì„</h4>
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’ª ê´€ê³„ì˜ ê°•ì </div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.strengths || ''}</div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ ë„ì „ê³¼ì œ</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.challenges || ''}</div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ”„ í˜¸í™˜ì„±</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.compatibility || ''}</div>
                </div>
                <div>
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“ˆ ì„±ì¥ ê°€ëŠ¥ì„±</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.detailedAnalysis.growthPotential || ''}</div>
                </div>
            </div>
        `;
        }

        // Life Aspects
        if (aiAnalysis.lifeAspects) {
            html += `
            <h4 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ¯ ìƒí™œ ì˜ì—­ë³„ ê¶í•©</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        `;
            if (aiAnalysis.lifeAspects.career) {
                html += `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’¼ ì§ì—…/ì‚¬ì—…</div>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.career}</div>
                </div>
            `;
            }
            if (aiAnalysis.lifeAspects.wealth) {
                html += `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’° ì¬ë¬¼/ê¸ˆì „</div>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.wealth}</div>
                </div>
            `;
            }
            if (aiAnalysis.lifeAspects.relationships) {
                html += `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">â¤ï¸ ì¸ê°„ê´€ê³„/ì• ì •</div>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.relationships}</div>
                </div>
            `;
            }
            if (aiAnalysis.lifeAspects.health) {
                html += `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ¥ ê±´ê°•</div>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.health}</div>
                </div>
            `;
            }
            if (aiAnalysis.lifeAspects.family) {
                html += `
                <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±</div>
                    <div style="color: #E2E8F0; line-height: 1.8; font-size: 0.95em;">${aiAnalysis.lifeAspects.family}</div>
                </div>
            `;
            }
            html += `</div>`;
        }

        // Communication
        if (aiAnalysis.communication) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ’¬ ì†Œí†µ ë¶„ì„</h4>
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ì†Œí†µ ìŠ¤íƒ€ì¼</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.communication.style || ''}</div>
                </div>
                <div>
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ì†Œí†µ íŒ</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.communication.tips || ''}</div>
                </div>
            </div>
        `;
        }

        // Relationship Guidance
        if (aiAnalysis.relationshipGuidance) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ’¡ ê´€ê³„ ê°€ì´ë“œ</h4>
        `;
            if (aiAnalysis.relationshipGuidance.do && aiAnalysis.relationshipGuidance.do.length > 0) {
                html += `
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âœ… í•´ì•¼ í•  ì¼</div>
                    <ul style="color: #E2E8F0; line-height: 1.8; padding-left: 1.5rem;">
                        ${aiAnalysis.relationshipGuidance.do.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `;
            }
            if (aiAnalysis.relationshipGuidance.avoid && aiAnalysis.relationshipGuidance.avoid.length > 0) {
                html += `
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ í”¼í•´ì•¼ í•  ì¼</div>
                    <ul style="color: #E2E8F0; line-height: 1.8; padding-left: 1.5rem;">
                        ${aiAnalysis.relationshipGuidance.avoid.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `;
            }
            if (aiAnalysis.relationshipGuidance.specialAdvice) {
                html += `
                <div>
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸŒŸ íŠ¹ë³„ ì¡°ì–¸</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.relationshipGuidance.specialAdvice}</div>
                </div>
            `;
            }
            html += `</div>`;
        }

        // Long Term Outlook
        if (aiAnalysis.longTermOutlook) {
            html += `
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #D4AF37; margin-bottom: 1rem;">ğŸ“… ì¥ê¸° ì „ë§</h4>
        `;
            if (aiAnalysis.longTermOutlook.shortTerm) {
                html += `
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“† ë‹¨ê¸° ì „ë§ (1-2ë…„)</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.shortTerm}</div>
                </div>
            `;
            }
            if (aiAnalysis.longTermOutlook.mediumTerm) {
                html += `
                <div style="margin-bottom: 1rem;">
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“… ì¤‘ê¸° ì „ë§ (3-5ë…„)</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.mediumTerm}</div>
                </div>
            `;
            }
            if (aiAnalysis.longTermOutlook.longTerm) {
                html += `
                <div>
                    <div style="color: #D4AF37; font-weight: bold; margin-bottom: 0.5rem;">ğŸ”® ì¥ê¸° ì „ë§ (5ë…„ ì´ìƒ)</div>
                    <div style="color: #E2E8F0; line-height: 1.8;">${aiAnalysis.longTermOutlook.longTerm}</div>
                </div>
            `;
            }
            html += `</div>`;
        }

        aiAnalysisDiv.innerHTML = html;
    }

    // ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}