{% extends "base.html" %}

{% block sidebar %}
{% include "includes/sidebar_input.html" %}

<!-- Sidebar Banner -->
{{ sidebar_banner_html | safe }}
{% endblock %}

{% block content %}
<!-- ìš°ì¸¡: íƒ€ë¡œ ì¹´ë“œ ë½‘ê¸° ë° ê²°ê³¼ -->
<div class="result-container">
    <!-- ì»¨í…ì¸  ìƒë‹¨ ë°°ë„ˆ -->


    <div class="glass-card">
        <div class="section-header">
            <span>ğŸƒ</span> íƒ€ë¡œ ì¹´ë“œ
        </div>

        <!-- íƒ€ë¡œ ì†Œê°œ -->
        <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1.5rem;">
            <p style="color: #E2E8F0; line-height: 1.8;">
                íƒ€ë¡œ ì¹´ë“œëŠ” ë‹¹ì‹ ì˜ ë‚´ë©´ì„ íƒìƒ‰í•˜ê³  ë¯¸ë˜ì— ëŒ€í•œ í†µì°°ì„ ì œê³µí•©ë‹ˆë‹¤.
                ë§ˆìŒì„ ì§‘ì¤‘í•˜ê³  ì§ˆë¬¸ì„ ë– ì˜¬ë¦° í›„ ì¹´ë“œë¥¼ ë½‘ì•„ë³´ì„¸ìš”.
            </p>
        </div>

        <!-- ì§ˆë¬¸ ì…ë ¥ (ì„ íƒì‚¬í•­) -->
        <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ’­ ì§ˆë¬¸ì´ë‚˜ ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)</h3>
        <textarea id="taro-question" placeholder="ì˜ˆ: ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë–¨ê¹Œìš”? / ì´ ê´€ê³„ì˜ ë¯¸ë˜ëŠ”? / ìƒˆë¡œìš´ ì§ì¥ì—ì„œì˜ ì ì‘ì€?"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-gold); border-radius: 8px; background: var(--navy-glass); color: var(--text-primary); min-height: 100px; margin-bottom: 1.5rem; font-family: inherit; resize: vertical;"></textarea>

        <!-- ìŠ¤í”„ë ˆë“œ íƒ€ì… ì„ íƒ -->
        <h3 style="color: var(--gold-primary); margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ´ ì¹´ë“œ ë½‘ê¸° ë°©ì‹ ì„ íƒ</h3>
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">
                <input type="radio" name="spread-type" value="1ì¥" checked style="margin-right: 0.5rem;">
                <span>1ì¥ - ì› ì¹´ë“œ: í˜„ì¬ ìƒí™©ì— ëŒ€í•œ ê°„ë‹¨í•œ í†µì°°</span>
            </label>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">
                <input type="radio" name="spread-type" value="3ì¥" style="margin-right: 0.5rem;">
                <span>3ì¥ - ê³¼ê±°Â·í˜„ì¬Â·ë¯¸ë˜: ì‹œê°„ì˜ íë¦„ì„ í†µí•œ ìƒí™© ì´í•´</span>
            </label>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">
                <input type="radio" name="spread-type" value="5ì¥" style="margin-right: 0.5rem;">
                <span>5ì¥ - ì¼ˆí‹± í¬ë¡œìŠ¤: ìƒí™©ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì¢…í•© ë¶„ì„</span>
            </label>
        </div>

        <!-- ì¹´ë“œ ë½‘ê¸° ë²„íŠ¼ -->
        <button id="draw-tarot-btn"
            style="width: 100%; padding: 1rem; background: var(--gold-gradient); border: none; border-radius: 8px; color: var(--bg-dark); font-weight: bold; cursor: pointer; font-size: 1rem; margin-bottom: 1.5rem;">
            ğŸ”® ì¹´ë“œ ë½‘ê¸°
        </button>

        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="tarot-result-container" style="display: none;"></div>

        <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ ì˜ì—­ -->
        <div id="tarot-share" style="display: none;">
            {% include "includes/share_buttons.html" %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ í¼ ê°’ ë³µì›
    document.addEventListener('DOMContentLoaded', function () {
        fillFormFromLocalStorage('input-form');
    });

    // íƒ€ë¡œ ì¹´ë“œ ë½‘ê¸°
    document.getElementById('draw-tarot-btn')?.addEventListener('click', async function () {
        const questionInput = document.getElementById('taro-question');
        const spreadTypeInputs = document.querySelectorAll('input[name="spread-type"]');
        const resultContainer = document.getElementById('tarot-result-container');

        if (!resultContainer) return;

        // ìŠ¤í”„ë ˆë“œ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
        let spreadType = '1ì¥';
        for (const input of spreadTypeInputs) {
            if (input.checked) {
                spreadType = input.value;
                break;
            }
        }

        const question = questionInput ? questionInput.value.trim() : '';

        // ë¡œë”© í‘œì‹œ
        resultContainer.style.display = 'block';
        resultContainer.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-gold); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 1rem; color: var(--text-muted);">íƒ€ë¡œ ì¹´ë“œë¥¼ ë½‘ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    `;

        try {
            // API KeyëŠ” ì…ë ¥ í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const apiKeyInput = document.getElementById('api-key-input');
            const currentApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            const response = await fetch('/api/tarot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    spread_type: spreadType,
                    question: question,
                    api_key: currentApiKey  // API Keyë¥¼ ìš”ì²­ ë³¸ë¬¸ì— í¬í•¨
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                renderTarotResult(data.data);
            } else {
                resultContainer.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ${data.detail || 'íƒ€ë¡œ ì¹´ë“œ ë½‘ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`;
            }
        } catch (error) {
            console.error('íƒ€ë¡œ ì¹´ë“œ ë½‘ê¸° ì˜¤ë¥˜:', error);
            resultContainer.innerHTML = `<div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5;">âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        }
    });

    // íƒ€ë¡œ ê²°ê³¼ ë Œë”ë§
    function renderTarotResult(result) {
        const resultContainer = document.getElementById('tarot-result-container');
        if (!resultContainer) return;

        const spreadType = result.spread_type;
        const question = result.question;
        const cards = result.cards;
        const analysis = result.analysis;



        // ê³µìœ  ë²„íŠ¼ í‘œì‹œ
        const shareDiv = document.getElementById('tarot-share');
        if (shareDiv) shareDiv.style.display = 'block';

        // ê³µìœ  ë°ì´í„° ì„¤ì •
        let shareTitle = "ì˜¤ëŠ˜ì˜ íƒ€ë¡œ ìš´ì„¸ - ìš´ì„¸ë‹´";
        if (spreadType === '1ì¥') shareTitle = `ì˜¤ëŠ˜ì˜ ì› ì¹´ë“œ íƒ€ë¡œ ìš´ì„¸ - ${cards[0].ì¹´ë“œëª…}`;
        else if (spreadType === '3ì¥') shareTitle = "íƒ€ë¡œ ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ ë¶„ì„ - ìš´ì„¸ë‹´";
        else if (spreadType === '5ì¥') shareTitle = "íƒ€ë¡œ ì¼ˆí‹± í¬ë¡œìŠ¤ ìƒì„¸ ë¶„ì„ - ìš´ì„¸ë‹´";

        const shareDesc = question ? `ì§ˆë¬¸: ${question}\në©”ì‹œì§€: ${analysis.overall_theme}` : `ë©”ì‹œì§€: ${analysis.overall_theme}`;

        window.currentShareData = {
            title: shareTitle,
            description: shareDesc,
            url: window.location.href,
            text: `${shareTitle}\n${shareDesc}\n\nì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!`
        };

        let html = '';

        // ì§ˆë¬¸ì´ ìˆìœ¼ë©´ í‘œì‹œ
        if (question) {
            html += `
            <div class="section-header" style="margin-top: 0;">
                <span>ğŸ’­</span> ì§ˆë¬¸: ${question}
            </div>
            <div style="margin-bottom: 2rem;"></div>
        `;
        }

        // ìŠ¤í”„ë ˆë“œ ì •ë³´
        const spreadNames = {
            "1ì¥": "ì› ì¹´ë“œ",
            "3ì¥": "ê³¼ê±°Â·í˜„ì¬Â·ë¯¸ë˜",
            "5ì¥": "ì¼ˆí‹± í¬ë¡œìŠ¤"
        };

        html += `<h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ´ ${spreadNames[spreadType]} ìŠ¤í”„ë ˆë“œ</h3>`;

        // ì¹´ë“œ í‘œì‹œ
        const numCards = cards.length;
        let cardGridStyle = '';

        if (numCards === 1) {
            cardGridStyle = 'grid-template-columns: 1fr;';
        } else if (numCards === 3) {
            cardGridStyle = 'grid-template-columns: repeat(3, 1fr);';
        } else if (numCards === 5) {
            cardGridStyle = 'grid-template-columns: repeat(3, 1fr);';
        } else {
            cardGridStyle = `grid-template-columns: repeat(${numCards}, 1fr);`;
        }

        html += `<div style="display: grid; ${cardGridStyle}; gap: 1rem; margin-bottom: 2rem;">`;

        // 5ì¥ ìŠ¤í”„ë ˆë“œì˜ ê²½ìš° íŠ¹ë³„ ë ˆì´ì•„ì›ƒ
        if (numCards === 5) {
            // ì²« 3ì¥
            for (let i = 0; i < 3; i++) {
                html += renderSingleCard(cards[i], i);
            }
            html += '</div><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; margin-top: 1rem;">';
            // ë‚˜ë¨¸ì§€ 2ì¥
            for (let i = 3; i < 5; i++) {
                html += renderSingleCard(cards[i], i);
            }
        } else {
            // ì¼ë°˜ ë ˆì´ì•„ì›ƒ
            for (let i = 0; i < numCards; i++) {
                html += renderSingleCard(cards[i], i);
            }
        }

        html += '</div>';

        html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(212,175,55,0.3);">';

        // ì¢…í•© í•´ì„
        html += `<h3 style="color: var(--gold-primary); margin-top: 2rem; margin-bottom: 1rem;">ğŸ”® ì¢…í•© í•´ì„</h3>`;

        // ì „ì²´ í…Œë§ˆ
        html += `
        <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ’« ì „ì²´ í…Œë§ˆ</h4>
        <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1rem;">
            <p style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">
                ${analysis.overall_theme}
            </p>
        </div>
    `;

        // ìƒì„¸ í•´ì„
        if (analysis.detailed_interpretation) {
            html += `
            <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ“– ìƒì„¸ í•´ì„</h4>
            <div style="padding: 1.5rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-bottom: 1rem;">
                <div style="color: #E2E8F0; line-height: 1.8; font-size: 1.05em;">
                    ${analysis.detailed_interpretation.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        }

        // ì¹´ë“œ ê´€ê³„ì„±
        if (analysis.card_relationships && analysis.card_relationships.length > 0) {
            html += `
            <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ”— ì¹´ë“œ ê°„ ê´€ê³„ì„±</h4>
        `;
            for (const relationship of analysis.card_relationships) {
                html += `
                <div style="padding: 1rem; background: rgba(52,152,219,0.1); border-left: 4px solid #3498db; border-radius: 6px; margin-bottom: 0.5rem;">
                    <p style="color: #E2E8F0; line-height: 1.6; margin: 0;">â€¢ ${relationship}</p>
                </div>
            `;
            }
        }

        // í•µì‹¬ ë©”ì‹œì§€
        if (analysis.key_messages && analysis.key_messages.length > 0) {
            html += `
            <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">âœ¨ í•µì‹¬ ë©”ì‹œì§€</h4>
        `;
            for (const message of analysis.key_messages) {
                html += `
                <div style="padding: 1rem; background: rgba(46,204,113,0.1); border-left: 4px solid #2ecc71; border-radius: 6px; margin-bottom: 0.5rem;">
                    <p style="color: #E2E8F0; line-height: 1.6; margin: 0;">â€¢ ${message}</p>
                </div>
            `;
            }
        }

        // ì¡°ì–¸
        if (analysis.advice && analysis.advice.length > 0) {
            html += `
            <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">ğŸ’¡ ì¡°ì–¸</h4>
        `;
            for (const adviceItem of analysis.advice) {
                html += `
                <div style="padding: 1rem; background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db; border-radius: 6px; margin-bottom: 0.5rem;">
                    <p style="color: #E2E8F0; line-height: 1.6; margin: 0;">${adviceItem}</p>
                </div>
            `;
            }
        }

        // ê²½ê³ 
        if (analysis.warning && analysis.warning.length > 0) {
            html += `
            <h4 style="color: #D4AF37; margin-top: 1.5rem; margin-bottom: 1rem;">âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
        `;
            for (const warningItem of analysis.warning) {
                html += `
                <div style="padding: 1rem; background: rgba(231,76,60,0.1); border-left: 4px solid #e74c3c; border-radius: 6px; margin-bottom: 0.5rem;">
                    <p style="color: #E2E8F0; line-height: 1.6; margin: 0;">â€¢ ${warningItem}</p>
                </div>
            `;
            }
        }

        // ë§ˆì§€ë§‰ ì•ˆë‚´
        html += `
        <hr style="margin: 2rem 0; border: none; border-top: 1px solid rgba(212,175,55,0.3);">
        <div style="padding: 1rem; background: rgba(212,175,55,0.1); border-radius: 8px; margin-top: 1rem;">
            <p style="color: #A0AEC0; line-height: 1.8; font-size: 0.9em;">
                ğŸ’« íƒ€ë¡œ ì¹´ë“œëŠ” ë‹¹ì‹ ì˜ í˜„ì¬ ìƒí™©ê³¼ ë‚´ë©´ì˜ ë©”ì‹œì§€ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. 
                ì¹´ë“œëŠ” ë¯¸ë˜ë¥¼ ì˜ˆì–¸í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í˜„ì¬ ìƒí™©ì—ì„œì˜ ê°€ëŠ¥ì„±ê³¼ ì£¼ì˜ì‚¬í•­ì„ ì•Œë ¤ì¤ë‹ˆë‹¤. 
                ì¹´ë“œë“¤ì´ ì œì‹œí•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì°¸ê³ í•˜ì—¬ ìì‹ ì˜ íŒë‹¨ê³¼ ì„ íƒì„ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </p>
        </div>
    `;

        // ë‹¤ì‹œ ë½‘ê¸° ë²„íŠ¼
        html += `
        <button id="redraw-tarot-btn" style="width: 100%; padding: 1rem; background: var(--gold-gradient); border: none; border-radius: 8px; color: var(--bg-dark); font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 1.5rem;">
            ğŸ”„ ë‹¤ì‹œ ë½‘ê¸°
        </button>
    `;

        resultContainer.innerHTML = html;

        // ë‹¤ì‹œ ë½‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('redraw-tarot-btn')?.addEventListener('click', function () {
            resultContainer.style.display = 'none';
            resultContainer.innerHTML = '';
        });
    }

    // ë‹¨ì¼ ì¹´ë“œ ë Œë”ë§
    function renderSingleCard(cardData, index) {
        const cardName = cardData.ì¹´ë“œëª…;
        const position = cardData.ìœ„ì¹˜;
        const isReversed = cardData.is_reversed; // backendì—ì„œ ìˆ˜ì •í•œ is_reversed ì‚¬ìš©
        const icon = cardData.ì•„ì´ì½˜ || 'ğŸƒ';
        const defaultImage = cardData.default_image; // ê¸°ë³¸ ì´ë¯¸ì§€ ê²½ë¡œ
        const aiImageUrl = cardData.ai_image_url; // AI ìƒì„± ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)

        const reversedText = isReversed ? " (ì—­ìœ„ì¹˜)" : "";
        const cardMeaning = isReversed ? cardData.ì—­ìœ„ì¹˜ : cardData.ì •ìœ„ì¹˜;

        // ì´ë¯¸ì§€ ìš°ì„ ìˆœìœ„: ê¸°ë³¸ ì´ë¯¸ì§€ > AI ìƒì„± ì´ë¯¸ì§€ > ì•„ì´ì½˜
        let imageOrIcon = '';
        if (defaultImage) {
            // ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš© (ì—­ìœ„ì¹˜ì¼ ê²½ìš° 180ë„ íšŒì „)
            // console.log(`Loading image for ${cardName}: ${defaultImage}`);
            imageOrIcon = `<img src="${defaultImage}" alt="${cardName}" onerror="console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';" style="width: 100%; max-width: 300px; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(212,175,55,0.3); margin-bottom: 0.5rem; ${isReversed ? 'transform: rotate(180deg);' : ''}" /><div style="font-size: 3rem; margin-bottom: 0.5rem; display: none;">${icon}</div>`;
        } else if (aiImageUrl) {
            // AI ìƒì„± ì´ë¯¸ì§€ ì‚¬ìš©
            imageOrIcon = `<img src="${aiImageUrl}" alt="${cardName}" onerror="console.error('AI ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.src);" style="width: 100%; max-width: 300px; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(212,175,55,0.3); margin-bottom: 0.5rem; ${isReversed ? 'transform: rotate(180deg);' : ''}" />`;
        } else {
            // ì•„ì´ì½˜ ì‚¬ìš©
            imageOrIcon = `<div style="font-size: 3rem; margin-bottom: 0.5rem;">${icon}</div>`;
        }

        return `
        <div style="padding: 1rem; background: rgba(212,175,55,0.15); border-radius: 12px; border: 2px solid rgba(212,175,55,0.4); min-height: 300px;">
            <div style="text-align: center; margin-bottom: 1rem;">
                ${imageOrIcon}
                <div style="font-weight: bold; color: #D4AF37; font-size: 1.1em; margin-bottom: 0.5rem;">
                    ${position}
                </div>
                <div style="color: #F9E79F; font-size: 0.95em; margin-bottom: 1rem;">
                    ${cardName}${reversedText}
                </div>
            </div>
            <div style="padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="color: #E2E8F0; font-size: 0.9em; line-height: 1.6;">
                    ${cardMeaning}
                </div>
            </div>
        </div>
    `;
    }

    // í¼ ì œì¶œ ì²˜ë¦¬ (ì‚¬ì£¼ ê³„ì‚°)
    document.getElementById('input-form')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        // ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        if (submitBtn && submitBtn.disabled) {
            return;
        }

        const formData = new FormData(this);
        const errorDiv = document.getElementById('form-error');

        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        }
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ì„¸ì…˜ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
                if (data.data && data.data.session_data) {
                    saveSessionDataToLocalStorage(data.data);
                } else {
                    const sessionData = {
                        user_name: formData.get('name') || '',
                        user_gender: formData.get('gender') || '',
                        birth_date: formData.get('birth_date') || '',
                        birth_time: formData.get('birth_time') || '',
                        is_lunar: formData.get('is_lunar') === 'on' || formData.get('is_lunar') === 'true',
                        _timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                    };
                    localStorage.setItem('user_session_data', JSON.stringify(sessionData));
                }

                // í¼ ê°’ì„ FormDataì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
                const form = document.getElementById('input-form');
                if (form) {
                    const nameInput = form.querySelector('[name="name"]');
                    const birthDateInput = form.querySelector('[name="birth_date"]');
                    const birthTimeInput = form.querySelector('[name="birth_time"]');
                    const genderSelect = form.querySelector('[name="gender"]');
                    const isLunarCheckbox = form.querySelector('[name="is_lunar"]');

                    if (nameInput) nameInput.value = formData.get('name') || '';
                    if (birthDateInput) birthDateInput.value = formData.get('birth_date') || '';
                    if (birthTimeInput) birthTimeInput.value = formData.get('birth_time') || '';
                    if (genderSelect) genderSelect.value = formData.get('gender') || '';
                    if (isLunarCheckbox) {
                        const isLunarValue = formData.get('is_lunar');
                        isLunarCheckbox.checked = isLunarValue === 'on' || isLunarValue === 'true' || isLunarValue === true;
                    }
                }

                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            } else {
                if (errorDiv) {
                    errorDiv.textContent = data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            if (errorDiv) {
                errorDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ê²°ê³¼ë³´ê¸°';
            }
        }
    });

    // ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}